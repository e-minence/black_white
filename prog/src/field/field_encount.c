//======================================================================
/**
 * @file  field_encount.c
 * @brief	フィールド　エンカウント処理
 * @author kagaya
 */
//======================================================================
#include <gflib.h>
#include "system/gfl_use.h"
#include "system/main.h"

#include "fieldmap.h"
#include "map_attr.h"

#include "encount_data.h"
#include "field_encount.h"

#include "battle/battle.h"
#include "gamesystem/btl_setup.h"
#include "poke_tool/monsno_def.h"
#include "poke_tool/tokusyu_def.h"
#include "poke_tool/poketype.h"
#include "poke_tool/pokeparty.h"
#include "poke_tool/poke_tool.h"
#include "poke_tool/poke_personal.h"
#include "tr_tool/tr_tool.h"
#include "item/itemsym.h"

#include "enc_pokeset.h"
#include "event_battle.h"

#include "sound/wb_sound_data.sadl"

//======================================================================
//  define
//======================================================================
#define FENCOUNT_PL_NULL ///<PL処理無効

#define DEBUG_WB_FORCE_GROUND //エンカウントデータを地上固定する

#define CALC_SHIFT (8) ///<計算シフト値
#define WALK_COUNT_GLOBAL (8) ///<エンカウントしない歩数
#define WALK_COUNT_MAX (0xffff) ///<歩数カウント最大
#define NEXT_PERCENT (40) ///<エンカウントする基本確率
#define	WALK_NEXT_PERCENT	(5) ///<歩数カウント失敗で次の処理に進む確率

#define LONG_GRASS_PERCENT (30) ///<長い草の中にいるときの加算確率
#define CYCLE_PERCENT (30) ///<自転車に乗っているときの加算確率

#define HEAPID_BTLPARAM (HEAPID_PROC) ///<バトルパラメタ用HEAPID

#if 0
///ランダムポケモン抽選タイプ
typedef enum{
  ENCPROB_CALCTYPE_NORMAL,  ///<ノーマル
  ENCPROB_CALCTYPE_WATER,   ///<水上
  ENCPROB_CALCTYPE_FISHING, ///<釣り
  ENCPROB_CALCTYPE_EQUAL,  ///<1/指定数
  ENCPROB_CALCTYPE_MAX,  ///<1/指定数
}ENCPROB_CALCTYPE;
#endif

//--------------------------------------------------------------
/// エンカウントデータ要素
//--------------------------------------------------------------
#ifdef DEBUG_ONLY_FOR_kagaya
//#define DEBUG_ENCOUNT_CHECKOFF_ATTR
#endif

//======================================================================
//  struct
//======================================================================

//======================================================================
//  proto
//======================================================================
static ENCOUNT_LOCATION enc_GetAttrLocation( FIELD_ENCOUNT *enc );
static u32 enc_GetLocationPercent( FIELD_ENCOUNT *enc,ENCOUNT_LOCATION location );
static BOOL enc_CheckEncount( FIELD_ENCOUNT *enc, const u32 per );
static BOOL enc_CheckEncountWalk( FIELD_ENCOUNT *enc, u32 per );

static void enc_CreateBattleParam( FIELD_ENCOUNT *enc, const ENCPOKE_FLD_PARAM* spa,
    BATTLE_SETUP_PARAM *bsp, HEAPID heapID, const ENC_POKE_PARAM* inPokeTbl );
static void enc_AddPartyPokemon(
    POKEPARTY *party, u32 monsno, u32 level, u32 id, HEAPID heapID );

static u32 enc_GetPercentRand( void );

static int enc_GetWalkCount( FIELD_ENCOUNT *enc );
static void enc_AddWalkCount( FIELD_ENCOUNT *enc );
static void enc_ClearWalkCount( FIELD_ENCOUNT *enc );


//======================================================================
//  フィールドエンカウント
//======================================================================
//--------------------------------------------------------------
/**
 * フィールドエンカウント　ワーク作成
 * @param fwork FIELDMAP_WORK
 * @retval FIELD_ENCOUNT*
 */
//--------------------------------------------------------------
FIELD_ENCOUNT * FIELD_ENCOUNT_Create( FIELDMAP_WORK *fwork )
{
  HEAPID heapID;
  FIELD_ENCOUNT *enc;
  
  heapID = FIELDMAP_GetHeapID( fwork );
  enc = GFL_HEAP_AllocClearMemory( heapID, sizeof(FIELD_ENCOUNT) );
  
  enc->fwork = fwork;
  enc->gsys = FIELDMAP_GetGameSysWork( enc->fwork );
  enc->gdata = GAMESYSTEM_GetGameData( enc->gsys );
  enc->encdata = EVENTDATA_GetEncountDataTable( GAMEDATA_GetEventData(enc->gdata) );
  return( enc );
}

//--------------------------------------------------------------
/**
 * フィールドエンカウント　削除
 * @param enc FIELD_ENCOUNT*
 * @retval nothing
 */
//--------------------------------------------------------------
void FIELD_ENCOUNT_Delete( FIELD_ENCOUNT *enc )
{
  GFL_HEAP_FreeMemory( enc );
}
#if 0
//--------------------------------------------------------------
/**
 * フィールドエンカウント　BATTLE_SETUP_PARAMポインタ取得
 * @param enc FIELD_ENCOUNT*
 * @return  FIELD_ENCOUNTが保持するBATTLE_SETUP_PARAM構造体の参照ポインタ
 */
//--------------------------------------------------------------
BATTLE_SETUP_PARAM* FIELD_ENCOUNT_GetBattleParamPointer( FIELD_ENCOUNT *enc )
{
  return &enc->battle_param;
}
#endif

//======================================================================
//  フィールドエンカウント　チェック
//======================================================================
//--------------------------------------------------------------
/**
 * エンカウントチェック
 * @param enc FIELD_ENCOUNT
 * @param enc_mode  ENCOUNT_MODE_???
 * @retval BOOL TRUE=エンカウントした
 */
//--------------------------------------------------------------
GMEVENT* FIELD_ENCOUNT_CheckEncount( FIELD_ENCOUNT *enc, ENCOUNT_TYPE enc_type )
{
  u32 per,enc_num;
  BOOL ret = FALSE;
  BATTLE_SETUP_PARAM* bp;

  ENCOUNT_LOCATION enc_loc;
  ENC_POKE_PARAM poke_tbl[FLD_ENCPOKE_NUM_MAX];
  
  FIELD_PLAYER *fplayer = FIELDMAP_GetFieldPlayer( enc->fwork );
	ENCPOKE_FLD_PARAM fld_spa;
   
  enc_loc = enc_GetAttrLocation( enc );
  per = enc_GetLocationPercent( enc, enc_loc );
  if( per <= 0 ){
    return( NULL ); //確率0
  }
  
  //ENCPOKE_FLD_PARAM作成
  ENCPOKE_SetEFPStruct( &fld_spa, enc, enc_loc, ENC_TYPE_NORMAL, FALSE );
  //道具＆特性によるエンカウント率変動
  per = ENCPOKE_EncProbManipulation( enc, &fld_spa, per);
 
  if( enc_CheckEncount(enc,per) == FALSE ){ //エンカウントチェック
    return NULL;
  }
  
  { //移動ポケモンチェック

  }

  //エンカウントデータ生成
  enc_num = ENCPOKE_GetNormalEncountPokeData( enc, &fld_spa, poke_tbl );
 
  if( enc_num == 0 ){ //エンカウント失敗
    return NULL;
  }

  //バトルパラメータセット
  bp = BATTLE_PARAM_Create( HEAPID_BTLPARAM );
  enc_CreateBattleParam( enc, &fld_spa, bp, HEAPID_BTLPARAM, poke_tbl );
  
  // 歩数カウントクリア
  enc_ClearWalkCount( enc );

  //エンカウントイベント生成
  if(enc_type == ENC_TYPE_BINGO){
    return EVENT_BingoBattle( enc->gsys, enc->fwork, bp );
  }
  return EVENT_WildPokeBattle( enc->gsys, enc->fwork, bp );
}

//======================================================================
//  サブ　エンカウント確率
//======================================================================

//--------------------------------------------------------------
/**
 * アトリビュートからエンカウントローケーション取得
 * @param
 * @retval
 */
//--------------------------------------------------------------
static ENCOUNT_LOCATION enc_GetAttrLocation( FIELD_ENCOUNT *enc )
{
  MAPATTR attr;
  VecFx32 pos;
  FIELD_PLAYER *fplayer = FIELDMAP_GetFieldPlayer( enc->fwork );
  FLDMAPPER *mapper = FIELDMAP_GetFieldG3Dmapper( enc->fwork );
  MAPATTR_FLAG attr_flag;
  
  FIELD_PLAYER_GetPos( fplayer, &pos );
  attr = MAPATTR_GetAttribute( mapper, &pos );

  if(MAPATTR_IsEnable(attr) == FALSE){
    return ENC_LOCATION_ERR;
  }

  //エンカウントフラグチェック
  attr_flag = MAPATTR_GetAttrFlag(attr);

#ifdef DEBUG_ENCOUNT_CHECKOFF_ATTR
  attr_flag |= MAPATTR_FLAGBIT_ENCOUNT;
#endif
  if((attr_flag & MAPATTR_FLAGBIT_ENCOUNT) == FALSE ){
    return ENC_LOCATION_ERR;
  }
  
  //エンカウントアトリビュートチェック
  {
    MAPATTR_VALUE attr_value = MAPATTR_GetAttrValue(attr);
#ifdef DEBUG_WB_FORCE_GROUND    
    attr_flag = 0; //@todo 仮　地上で固定
#endif

    //水チェック
    if(attr_flag & MAPATTR_FLAGBIT_WATER){
      return ENC_LOCATION_WATER;
    }
    //地面ハイレベル
    if( MAPATTR_VALUE_CheckEncountGrassB(attr_value) ){
      return ENC_LOCATION_GROUND_H;
    }
  }
  //@todo その他は今のところ地面ローレベルを当てておく 091002
  return ENC_LOCATION_GROUND_L;
}

//--------------------------------------------------------------
/**
 * エンカウント率をロケーションから取得
 * @param enc FIELD_ENCOUNT*
 * @param attr チェックするMAPATTR
 * @param outEncLocation にエンカウント場所を格納するENCOUNT_LOCATION
 * @retval u32 エンカウント率 0=エンカウント無し
 */
//--------------------------------------------------------------
static u32 enc_GetLocationPercent( FIELD_ENCOUNT *enc,ENCOUNT_LOCATION location )
{
  u32 per = 0;

  if(location >= ENC_LOCATION_MAX){
    return 0;
  }
  return enc->encdata->prob[location];
}

//======================================================================
//  サブ　エンカウントチェック
//======================================================================
//--------------------------------------------------------------
/**
 * エンカウントチェック
 * @param enc FIELD_ENCOUNT
 * @param per エンカウント確率
 * @param attr MAPATTR
 * @retval BOOL TRUE=エンカウントした
 */
//--------------------------------------------------------------
static BOOL enc_CheckEncount( FIELD_ENCOUNT *enc, u32 per )
{
  u32 calc_per,next_per;
  
  if( per > 100 ){ //100%
    per = 100;
  }
  //エンカウント直後のグリッド移動補正

  if( enc_GetPercentRand() < per ){
    return( TRUE );
  }
#if 0   //091006時点では歩数によるエンカウント率補正はない
  calc_per = per << CALC_SHIFT;
  
  if( enc_CheckEncountWalk(enc,calc_per) == FALSE ){
    enc_AddWalkCount( enc ); //歩数カウント
    
    if( enc_GetPercentRand() >= WALK_NEXT_PERCENT ){ //5%で次の処理へ
      return( FALSE );
    }
  }
  
  next_per = NEXT_PERCENT; //エンカウント基本確率
    
  { //日付による確率変動 
  }
  
  if( next_per > 100 ){ //100%超えチェック
    next_per = 100;
  }
  
  if( enc_GetPercentRand() < next_per ){ //確率チェック
    if( enc_GetPercentRand() >= per ){
      return( TRUE );
    }
  }
#endif
  return( FALSE );
}

//--------------------------------------------------------------
/**
 * エンカウントチェック　歩数チェック
 * @param enc FIELD_ENCOUNT
 * @param per エンカウント確率
 * @retval BOOL TRUE=エンカウントした
 */
//--------------------------------------------------------------
static BOOL enc_CheckEncountWalk( FIELD_ENCOUNT *enc, u32 per )
{
  per = (per/10) >> CALC_SHIFT;
  
  if( per > WALK_COUNT_GLOBAL ){
    per = WALK_COUNT_GLOBAL;
  }
  
  per = WALK_COUNT_GLOBAL - per;
  
  if( enc_GetWalkCount(enc) >= per ){
    return( TRUE );
  }
   
  return( FALSE );
}

//======================================================================
//  バトルパラム
//======================================================================
//--------------------------------------------------------------
/**
 * バトルパラム作成
 * @param
 * @retval
 */
//--------------------------------------------------------------
static void enc_CreateBattleParam( FIELD_ENCOUNT *enc, const ENCPOKE_FLD_PARAM* efp,
    BATTLE_SETUP_PARAM *bsp, HEAPID heapID, const ENC_POKE_PARAM* inPokeTbl )
{
  GAMEDATA *gdata = enc->gdata;

  //エネミーパーティ生成
  {
    int i;
    POKEPARTY* partyEnemy = PokeParty_AllocPartyWork( heapID );
    POKEMON_PARAM* pp = GFL_HEAP_AllocClearMemory( heapID, POKETOOL_GetWorkSize() );

    for(i = 0;i < ((u8)(efp->enc_double_f)+1);i++){
      ENCPOKE_PPSetup( pp, efp, &inPokeTbl[i] );
      PokeParty_Add( partyEnemy, pp );
    }
    GFL_HEAP_FreeMemory( pp );
  
    BP_SETUP_Wild( bsp, gdata, heapID, BTL_RULE_SINGLE+efp->enc_double_f,partyEnemy, efp->land_form, efp->weather );
  }
  
  { //2vs2時の味方AI（不要ならnull）
    bsp->partyPartner = NULL;
  }

  { //2vs2時の２番目敵AI用（不要ならnull）
    bsp->partyEnemy2 = NULL;
  }
  
  { //BGM設定
    //デフォルト時のBGMナンバー
//  bsp->musicDefault = SEQ_WB_BA_TEST_250KB;
    bsp->musicDefault = SEQ_BGM_VS_NORAPOKE;
    //ピンチ時のBGMナンバー
    bsp->musicPinch = SEQ_BGM_BATTLEPINCH;
  }
}

//--------------------------------------------------------------
/**
 * バトルパラム作成（トレーナー戦）
 * @param
 * @retval
 */
//--------------------------------------------------------------
static void enc_CreateTrainerBattleParam(
    FIELD_ENCOUNT *enc,
    BATTLE_SETUP_PARAM *param, const HEAPID heapID,
    TrainerID tr_id )
{
  GAMESYS_WORK *gsys = enc->gsys;
  GAMEDATA *gdata = enc->gdata;
 
  BATTLE_PARAM_Init(param);

  { //各設定
    param->engine = BTL_ENGINE_ALONE;
    param->rule = BTL_RULE_SINGLE;
    param->competitor = BTL_COMPETITOR_TRAINER;
    param->netHandle = NULL;
    param->commMode = BTL_COMM_NONE;
    param->netID = 0;
  }

  { //プレイヤーパーティ追加
    KAGAYA_Printf( "バトルパラム作成 HEAPID=%d\n", heapID );
    param->partyPlayer = PokeParty_AllocPartyWork( heapID );
    PokeParty_Copy( GAMEDATA_GetMyPokemon(gdata), param->partyPlayer );
  }
  
  { //対戦相手の手持ちポケモン生成
    param->partyEnemy1 = PokeParty_AllocPartyWork( heapID );

    param->trID = tr_id;
    
    TT_EncountTrainerDataMake( param, heapID );
  }
  
  { //2vs2時の味方AI（不要ならnull）
    param->partyPartner = NULL;
  }

  { //2vs2時の２番目敵AI用（不要ならnull）
    param->partyEnemy2 = NULL;
  }
  
  { //プレイヤーステータス
    param->statusPlayer = SaveData_GetMyStatus( SaveControl_GetPointer() );
  }
  
  { //BGM設定
    //デフォルト時のBGMナンバー
//  param->musicDefault = SEQ_WB_BA_TEST_250KB;
    param->musicDefault = SEQ_BGM_VS_NORAPOKE;
    //ピンチ時のBGMナンバー
    param->musicPinch = SEQ_BGM_BATTLEPINCH;
  }
}

//--------------------------------------------------------------
/**
 * フィールドエンカウント　トレーナー用BATTLE_SETUP_PARAM*作成
 * @param enc FIELD_ENCOUNT*
 * @param tr_id トレーナーID
 * @retval nothing
 */
//--------------------------------------------------------------
void FIELD_ENCOUNT_SetTrainerBattleParam(
    FIELD_ENCOUNT *enc, BATTLE_SETUP_PARAM *setup, int tr_id, HEAPID heapID )
{
  KAGAYA_Printf( "トレーナーバトルパラム作成 HEAPID=%d\n", heapID );
  enc_CreateTrainerBattleParam( enc, setup, heapID, tr_id );
}

//--------------------------------------------------------------
/**
 * PP追加
 * @param
 * @retval
 */
//--------------------------------------------------------------
static void enc_AddPartyPokemon(
    POKEPARTY *party, u32 monsNo, u32 lv, u32 id, HEAPID heapID ) 
{
  {
    //monsNo
    KAGAYA_Printf( "PP追加 %d\n", monsNo );
  }

  {
    POKEMON_PARAM *pp = PP_Create( monsNo, lv, id, heapID );
    PokeParty_Add( party, pp );
    GFL_HEAP_FreeMemory( pp );
  }
}

//======================================================================
//  パーツ
//======================================================================
//--------------------------------------------------------------
/**
 * ランダム確率取得
 * @retval  u32 確率
 */
//--------------------------------------------------------------
static u32 enc_GetPercentRand( void )
{
  u32 per = (0xffff/100) + 1;
  u32 val = GFUser_GetPublicRand(0xffff) / per;
  return( val );
}

//--------------------------------------------------------------
/**
 * 歩数カウント取得
 * @param
 * @retval
 */
//--------------------------------------------------------------
static int enc_GetWalkCount( FIELD_ENCOUNT *enc )
{
  return( GAMEDATA_GetFieldMapWalkCount(enc->gdata) );
}

//--------------------------------------------------------------
/**
 * 歩数カウント増加
 * @param
 * @retval
 */
//--------------------------------------------------------------
static void enc_AddWalkCount( FIELD_ENCOUNT *enc )
{
  int count = GAMEDATA_GetFieldMapWalkCount( enc->gdata );
  if( count < WALK_COUNT_MAX ){ count++; }
  GAMEDATA_SetFieldMapWalkCount( enc->gdata, count );
}

//--------------------------------------------------------------
/**
 * 歩数カウントクリア
 * @param
 * @retval
 */
//--------------------------------------------------------------
static void enc_ClearWalkCount( FIELD_ENCOUNT *enc )
{
  GAMEDATA_SetFieldMapWalkCount( enc->gdata, 0 );
}

