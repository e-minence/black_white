//======================================================================
/**
 * @file	fldmmdl.c
 * @brief	動作モデル
 * @author	kagaya
 * @data	05.07.13
 */
//======================================================================
#include "fldmmdl.h"
#include "fldmmdl_procdraw.h"

#include "arc_def.h"
#include "arc/fieldmap/fldmmdl_mdlparam.naix"

//======================================================================
//	define
//======================================================================
//--------------------------------------------------------------
//	debug
//--------------------------------------------------------------

//--------------------------------------------------------------
//	MMDL 動作、描画関数ワークサイズ (byte size)
//--------------------------------------------------------------
#define MMDL_MOVE_WORK_SIZE		(16)	///<動作関数用ワークサイズ
#define MMDL_MOVE_SUB_WORK_SIZE	(16)	///<動作サブ関数用ワークサイズ
#define MMDL_MOVE_CMD_WORK_SIZE	(16)	///<動作コマンド用ワークサイズ
#define MMDL_DRAW_WORK_SIZE		(32)	///<描画関数用ワークサイズ

//--------------------------------------------------------------
///	エイリアスシンボル
//--------------------------------------------------------------
enum
{
	RET_ALIES_NOT = 0,	//エイリアスではない
	RET_ALIES_EXIST,	//エイリアスとして既に存在している
	RET_ALIES_CHANGE,	//エイリアス変更が必要である
};

//======================================================================
//	struct
//======================================================================
//--------------------------------------------------------------
///	MMDLSYS構造体
//--------------------------------------------------------------
struct _TAG_MMDLSYS
{
	u32 status_bit;					///<ステータスビット
	u16 fmmdl_max;					///<MMDL最大数
	HEAPID sysHeapID;				///<システム用 ヒープID
	MMDL *pMMdlBuf;			///<MMDLワーク *
	
	HEAPID heapID;					///<ヒープID
	s16 fmmdl_count;				///<フィールド動作モデル現在数
	u16 tcb_pri;					///<TCBプライオリティ
	u16 dummy;						///<余り
	const FLDMAPPER *pG3DMapper;	///<FLDMAPPER

	void *pTCBSysWork;				///<TCBワーク
	GFL_TCBSYS *pTCBSys;			///<TCBSYS*
	
	MMDL_BLACTCONT *pBlActCont;	///<MMDL_BLACTCONT
	
	u8 *pOBJCodeParamBuf;			///<OBJCODE_PARAMバッファ
	const OBJCODE_PARAM *pOBJCodeParamTbl; ///<OBJCODE_PARAM
  
  void *fieldMapWork; ///<FIELDMAP_WORK
};

#define MMDLSYS_SIZE (sizeof(MMDLSYS)) ///<MMDLSYSサイズ

//--------------------------------------------------------------
///	MMDL構造体
//--------------------------------------------------------------
struct _TAG_MMDL
{
	u32 status_bit;				///<ステータスビット
	u32 move_bit;				///<動作ビット
	
	u16 obj_id;					///<OBJ ID
	u16 zone_id;				///<ゾーン ID
	u16 obj_code;				///<OBJコード
	u16 move_code;				///<動作コード
	u16 event_type;				///<イベントタイプ
	u16 event_flag;				///<イベントフラグ
	u16 event_id;				///<イベントID
	u16 dir_head;				///<MMDL_H指定方向
	u16 dir_disp;				///<現在向いている方向
	u16 dir_move;				///<現在動いている方向
	u16 dir_disp_old;			///<過去の動いていた方向
	u16 dir_move_old;			///<過去の動いていた方向
	
	u16 param0;					///<ヘッダ指定パラメタ
	u16 param1;					///<ヘッダ指定パラメタ
	u16 param2;					///<ヘッダ指定パラメタ
	
	u16 acmd_code;				///<アニメーションコマンドコード
	u16 acmd_seq;				///<アニメーションコマンドシーケンス
	u16 draw_status;			///<描画ステータス
	s16 move_limit_x;			///<X方向移動制限
	s16 move_limit_z;			///<Z方向移動制限
	s16 gx_init;				///<初期グリッドX
	s16 gy_init;				///<初期グリッドY
	s16 gz_init;				///<初期グリッドZ
	s16 gx_old;					///<過去グリッドX
	s16 gy_old;					///<過去グリッドY
	s16 gz_old;					///<過去グリッドZ
	s16 gx_now;					///<現在グリッドX
	s16 gy_now;					///<現在グリッドY
	s16 gz_now;					///<現在グリッドZ
	VecFx32 vec_pos_now;		///<現在実数座標
	VecFx32 vec_draw_offs;		///<表示座標オフセット
	VecFx32 vec_draw_offs_outside;	///<外部指定表示座標オフセット
	VecFx32 vec_attr_offs;		///<アトリビュートによる座標オフセット
	u32 now_attr;				///<現在のマップアトリビュート
	u32 old_attr;				///<過去のマップアトリビュート
	
	GFL_TCB *pTCB;				///<動作関数TCB*
	const MMDLSYS *pMMdlSys;///<MMDLSYS*
	
	const MMDL_MOVE_PROC_LIST *move_proc_list; ///<動作関数リスト
	const MMDL_DRAW_PROC_LIST *draw_proc_list; ///<描画関数リスト
	
	u8 move_proc_work[MMDL_MOVE_WORK_SIZE];///動作関数用ワーク
	u8 move_sub_proc_work[MMDL_MOVE_SUB_WORK_SIZE];///動作サブ関数用ワーク
	u8 move_cmd_proc_work[MMDL_MOVE_CMD_WORK_SIZE];///動作コマンド用ワーク
	u8 draw_proc_work[MMDL_DRAW_WORK_SIZE];///描画関数用ワーク
};

#define MMDL_SIZE (sizeof(MMDL)) ///<MMDLサイズ 224

//--------------------------------------------------------------
///	MMDL_SAVEWORK構造体 size 80
//--------------------------------------------------------------
typedef struct
{
	u32 status_bit;			///<ステータスビット
	u32 move_bit;			///<動作ビット
	
	u8 obj_id;        ///<OBJ ID
	u8 move_code;       ///<動作コード
	s8 move_limit_x;		///<X方向移動制限
	s8 move_limit_z;		///<Z方向移動制限
	
	s8 dir_head;			///<MMDL_H指定方向
	s8 dir_disp;			///<現在向いている方向
	s8 dir_move;			///<現在動いている方向
	u8 dummy;				///<ダミー
	
	u16 zone_id;			///<ゾーン ID
	u16 obj_code;			///<OBJコード
	u16 event_type;			///<イベントタイプ
	u16 event_flag;			///<イベントフラグ
	u16 event_id;			///<イベントID
  
	u16 param0;				///<ヘッダ指定パラメタ
	u16 param1;				///<ヘッダ指定パラメタ
	u16 param2;				///<ヘッダ指定パラメタ
  
	s16 gx_init;			///<初期グリッドX
	s16 gy_init;			///<初期グリッドY
	s16 gz_init;			///<初期グリッドZ
	s16 gx_now;				///<現在グリッドX
	s16 gy_now;				///<現在グリッドY
	s16 gz_now;				///<現在グリッドZ
  
	fx32 fx32_y;			///<fx32型の高さ値
  
	u8 move_proc_work[MMDL_MOVE_WORK_SIZE];///<動作関数用ワーク
	u8 move_sub_proc_work[MMDL_MOVE_SUB_WORK_SIZE];///<動作サブ関数用ワーク
}MMDL_SAVEWORK;

//--------------------------------------------------------------
///	MMDL_SAVEDATA構造体
//--------------------------------------------------------------
struct _TAG_MMDL_SAVEDATA
{
	MMDL_SAVEWORK SaveWorkBuf[MMDL_SAVEMMDL_MAX];
};

//======================================================================
//	proto
//======================================================================
//MMDLSYS プロセス
static void MMdlSys_DeleteProc( MMDLSYS *fos );

//MMDL 追加、削除
static void MMdl_SetHeader(
	MMDL * fmmdl, const MMDL_HEADER *head, void *sys );
static void MMdl_SetHeaderPos(MMDL *fmmdl,const MMDL_HEADER *head);
static void MMdl_InitWork( MMDL * fmmdl, const MMDLSYS *sys );
static void MMdl_InitCallMoveProcWork( MMDL * fmmdl );
static void MMdl_InitMoveWork( const MMDLSYS *fos, MMDL * fmmdl );
#if 0
static void MMdlSys_CheckSetInitMoveWork( MMDLSYS *fos );
static void MMdlSys_CheckSetInitDrawWork( MMDLSYS *fos );
#endif

//MMDL 動作関数
static void MMdl_TCB_MoveProc( GFL_TCB * tcb, void *work );
static void MMdl_TCB_DrawProc( MMDL * fmmdl );

//MMDL_SAVEDATA
static void MMdl_SaveData_SaveMMdl(
	const MMDL *fmmdl, MMDL_SAVEWORK *save );
static void MMdl_SaveData_LoadMMdl(
	MMDL *fmmdl, const MMDL_SAVEWORK *save, const MMDLSYS *fos );

//MMDLSYS 設定、参照
static void MMdlSys_OnStatusBit(
	MMDLSYS *fmmdlsys, MMDLSYS_STABIT bit );
static void MMdlSys_OffStatusBit(
	MMDLSYS *fmmdlsys, MMDLSYS_STABIT bit );
static void MMdlSys_IncrementOBJCount( MMDLSYS *fmmdlsys );
static void MMdlSys_DecrementOBJCount( MMDLSYS *fmmdlsys );

//MMDLSYS ツール
static MMDL * MMdlSys_SearchSpaceMMdl( const MMDLSYS *sys );
static MMDL * MMdlSys_SearchAlies(
	const MMDLSYS *fos, int obj_id, int zone_id );

//MMDL ツール
static void MMdl_AddTCB( MMDL *fmmdl, const MMDLSYS *sys );
static void MMdl_DeleteTCB( MMDL *fmmdl );
static void MMdl_InitDrawWork( MMDL *fmmdl );
static void MMdl_InitCallDrawProcWork( MMDL * fmmdl );
static void MMdl_InitDrawEffectFlag( MMDL * fmmdl );
static void MMdl_ClearWork( MMDL *fmmdl );
static int MMdl_CheckHeaderAlies(
		const MMDL *fmmdl, int h_zone_id, int max,
		const MMDL_HEADER *head );
static MMDL * MMdl_SearchOBJIDZoneID(
		const MMDLSYS *fos, int obj_id, int zone_id );
static void MMdl_InitDrawStatus( MMDL * fmmdl );
static void MMdl_SetDrawDeleteStatus( MMDL * fmmdl );
static void MMdl_ChangeAliesOBJ(
	MMDL *fmmdl, const MMDL_HEADER *head, int zone_id );
static void MMdl_ChangeOBJAlies(
	MMDL * fmmdl, int zone_id, const MMDL_HEADER *head );

//OBJCODE_PARAM
static void MMdlSys_InitOBJCodeParam( MMDLSYS *fmmdlsys );
static void MMdlSys_DeleteOBJCodeParam( MMDLSYS *fmmdlsys );

//parts
static u16 WorkOBJCode_GetOBJCode( void *fsys, int code );
static const MMDL_MOVE_PROC_LIST * MoveProcList_GetList( u16 code );
static const MMDL_DRAW_PROC_LIST * DrawProcList_GetList(
		MMDL_DRAWPROCNO no );
static BOOL MMdlHeader_CheckAlies( const MMDL_HEADER *head );
static int MMdlHeader_GetAliesZoneID( const MMDL_HEADER *head );

//======================================================================
//	フィールド動作モデル　システム
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS システム作成
 * @param	heapID	HEAPID
 * @param	max	動作モデル最大数
 * @retval	MMDLSYS* 作成されたMMDLSYS*
 */
//--------------------------------------------------------------
MMDLSYS * MMDLSYS_CreateSystem( HEAPID heapID, u32 max )
{
	MMDLSYS *fos;
	fos = GFL_HEAP_AllocClearMemory( heapID, MMDLSYS_SIZE );
	fos->pMMdlBuf = GFL_HEAP_AllocClearMemory( heapID, max*MMDL_SIZE );
	fos->fmmdl_max = max;
	fos->sysHeapID = heapID;
	return( fos );
}

//--------------------------------------------------------------
/**
 * MMDLSYS システム開放
 * @param	fos	MMDLSYS*
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_FreeSystem( MMDLSYS *fos )
{
	GFL_HEAP_FreeMemory( fos->pMMdlBuf );
	GFL_HEAP_FreeMemory( fos->pMMdlBuf );
}

//======================================================================
//	フィールド動作モデル　システム　プロセス
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS システム 動作プロセスセットアップ
 * @param	fos	MMDLSYS*
 * @param	heapID	プロセス用HEAPID
 * @param	pG3DMapper FLDMAPPER
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_SetupProc(
	MMDLSYS *fos, HEAPID heapID, const FLDMAPPER *pG3DMapper )
{
	fos->heapID = heapID;
	fos->pG3DMapper = pG3DMapper;
	
	MMdlSys_InitOBJCodeParam( fos );
	
	fos->pTCBSysWork = GFL_HEAP_AllocMemory(
		heapID, GFL_TCB_CalcSystemWorkSize(fos->fmmdl_max) );
	fos->pTCBSys = GFL_TCB_Init( fos->fmmdl_max, fos->pTCBSysWork );
	
	MMdlSys_OnStatusBit( fos, MMDLSYS_STABIT_MOVE_INIT_COMP );
}

//--------------------------------------------------------------
/**
 * MMDLSYS システム　動作プロセス削除
 * @param	fos		MMDLSYS *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdlSys_DeleteProc( MMDLSYS *fos )
{
	MMdlSys_DeleteOBJCodeParam( fos );
	GFL_TCB_Exit( fos->pTCBSys );
	GFL_HEAP_FreeMemory( fos->pTCBSysWork );
	MMdlSys_OffStatusBit( fos, MMDLSYS_STABIT_MOVE_INIT_COMP );
}

//--------------------------------------------------------------
/**
 * MMDLSYS 全てのプロセス削除
 * @param	fos		MMDLSYS *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_DeleteProc( MMDLSYS *fos )
{
//	MMDLSYS_DeleteMMdl( fos );
	MMDLSYS_DeleteDraw( fos );
	MMdlSys_DeleteProc( fos );
}

//--------------------------------------------------------------
/**
 * MMDLSYS 動作モデル更新
 * @param	fos	MMDLSYS
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_UpdateProc( MMDLSYS *fos )
{
	GFL_TCBSYS *tcbsys = fos->pTCBSys;
	GF_ASSERT( tcbsys != NULL );
	GFL_TCB_Main( tcbsys );
}

//--------------------------------------------------------------
/**
 * MMDLSYS Vブランク処理
 * @param	fos	MMDLSYS
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_VBlankProc( MMDLSYS *fos )
{
  if( fos->pBlActCont != NULL ){
    MMDL_BLACTCONT_ProcVBlank( fos );
  }
}

//======================================================================
//	フィールド動作モデル　システム　描画プロセス
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS システム　描画プロセスセットアップ
 * @param	fos	MMDLSYS*
 * @param	heapID	プロセス用HEAPID
 * @param	pG3DMapper FLDMAPPER
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_SetupDrawProc( MMDLSYS *fos )
{
	MMDLSYS_SetCompleteDrawInit( fos, TRUE );
}

//======================================================================
//	フィールド動作モデル追加、削除
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS フィールド動作モデルを追加
 * @param	fos			MMDLSYS *
 * @param	header		追加する情報を纏めたMMDL_HEADER *
 * @param	zone_id		ゾーンID
 * @retval	MMDL	追加されたMMDL *
 */
//--------------------------------------------------------------
MMDL * MMDLSYS_AddMMdl(
	const MMDLSYS *fos, const MMDL_HEADER *header, int zone_id )
{
	MMDL *fmmdl;
	MMDL_HEADER header_data = *header;
	const MMDL_HEADER *head = &header_data;
	
	fmmdl = MMdlSys_SearchSpaceMMdl( fos );
	GF_ASSERT( fmmdl != NULL );
	
	MMdl_SetHeader( fmmdl, head, NULL );
	MMdl_InitWork( fmmdl, fos );
	MMDL_SetZoneID( fmmdl, zone_id );
	
	if( MMDLSYS_CheckStatusBit(fos,MMDLSYS_STABIT_MOVE_INIT_COMP) ){
		MMdl_InitMoveWork( fos, fmmdl );
		MMDL_InitMoveProc( fmmdl );
	}
	
	if( MMDLSYS_CheckStatusBit(fos,MMDLSYS_STABIT_DRAW_INIT_COMP) ){
		MMdl_InitDrawWork( fmmdl );
	}
	
	MMdlSys_IncrementOBJCount( (MMDLSYS*)MMDL_GetMMdlSys(fmmdl) );
	return( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDLSYS フィールド動作モデルを追加　複数
 * @param	fos			MMDLSYS *
 * @param	header		追加する情報を纏めたMMDL_HEADER *
 * @param	zone_id		ゾーンID
 * @param	count		header要素数
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_SetMMdl( const MMDLSYS *fos,
	const MMDL_HEADER *header, int zone_id, int count )
{
	GF_ASSERT( count > 0 );
	GF_ASSERT( header != NULL );
	
	KAGAYA_Printf( "MMDLSYS_SetMMdl Count %d\n", count );
	
	do{
		MMDLSYS_AddMMdl( fos, header, zone_id );
		header++;
		count--;
	}while( count );
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデルを削除
 * @param	fmmdl		削除するMMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_Delete( MMDL * fmmdl )
{
	const MMDLSYS *fos;
	
	fos = MMDL_GetMMdlSys( fmmdl );
	
	if( MMDLSYS_CheckCompleteDrawInit(fos) == TRUE ){
		MMDL_CallDrawDeleteProc( fmmdl );
	}
	
	if( MMDL_CheckMoveBit(fmmdl,MMDL_MOVEBIT_MOVEPROC_INIT) ){
		MMDL_CallMoveDeleteProc( fmmdl );
		MMdl_DeleteTCB( fmmdl );
	}
	
	MMdlSys_DecrementOBJCount( (MMDLSYS*)(fmmdl->pMMdlSys) );
	MMdl_ClearWork( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDLSYS 現在発生しているフィールド動作モデルを全て削除
 * @param	fos	MMDLSYS
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_DeleteMMdl( const MMDLSYS *fos )
{
	u32 no = 0;
	MMDL *fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&no) ){
		MMDL_Delete( fmmdl );
	}
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル　ヘッダー情報反映
 * @param	fmmdl		設定するMMDL * 
 * @param	head		反映する情報を纏めたMMDL_HEADER *
 * @param	fsys		FIELDSYS_WORK *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_SetHeader(
	MMDL * fmmdl, const MMDL_HEADER *head, void *sys )
{
	MMDL_SetOBJID( fmmdl, head->id );
	MMDL_SetOBJCode( fmmdl, WorkOBJCode_GetOBJCode(sys,head->obj_code) );
	MMDL_SetMoveCode( fmmdl, head->move_code );
	MMDL_SetEventType( fmmdl, head->event_type );
	MMDL_SetEventFlag( fmmdl, head->event_flag );
	MMDL_SetEventID( fmmdl, head->event_id );
	fmmdl->dir_head = head->dir;
	MMDL_SetParam( fmmdl, head->param0, MMDL_PARAM_0 );
	MMDL_SetParam( fmmdl, head->param1, MMDL_PARAM_1 );
	MMDL_SetParam( fmmdl, head->param2, MMDL_PARAM_2 );
	MMDL_SetMoveLimitX( fmmdl, head->move_limit_x );
	MMDL_SetMoveLimitZ( fmmdl, head->move_limit_z );
	
	MMdl_SetHeaderPos( fmmdl, head );
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル　座標系初期化
 * @param	fmmdl		MMDL * 
 * @param	head		反映する情報を纏めたMMDL_HEADER *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_SetHeaderPos( MMDL *fmmdl, const MMDL_HEADER *head )
{
	int pos;
	VecFx32 vec;
	
	pos = head->gx;
	vec.x = GRID_SIZE_FX32( pos ) + MMDL_VEC_X_GRID_OFFS_FX32;
	MMDL_SetInitGridPosX( fmmdl, pos );
	MMDL_SetOldGridPosX( fmmdl, pos );
	MMDL_SetGridPosX( fmmdl, pos );
	
	pos = head->y;		//pos設定はfx32型で来る。
	vec.y = (fx32)pos;
	pos = SIZE_GRID_FX32( pos );
	MMDL_SetInitGridPosY( fmmdl, pos );
	MMDL_SetOldGridPosY( fmmdl, pos );
	MMDL_SetGridPosY( fmmdl, pos );
	
	pos = head->gz;
	vec.z = GRID_SIZE_FX32( pos ) + MMDL_VEC_Z_GRID_OFFS_FX32;
	MMDL_SetInitGridPosZ( fmmdl, pos );
	MMDL_SetOldGridPosZ( fmmdl, pos );
	MMDL_SetGridPosZ( fmmdl, pos );
	
	MMDL_SetVectorPos( fmmdl, &vec );
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル　ワーク初期化
 * @param	fmmdl		MMDL * 
 * @param	sys			MMDLSYS *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_InitWork( MMDL * fmmdl, const MMDLSYS *sys )
{
	MMDL_OnStatusBit( fmmdl,
		MMDL_STABIT_USE |				//使用中
		MMDL_STABIT_HEIGHT_GET_ERROR |	//高さ取得が必要
		MMDL_STABIT_ATTR_GET_ERROR );	//アトリビュート取得が必要
	
	if( MMDL_CheckAliesEventID(fmmdl) == TRUE ){
		MMDL_SetStatusBitAlies( fmmdl, TRUE );
	}
	
	fmmdl->pMMdlSys = sys;
	MMDL_SetForceDirDisp( fmmdl, MMDL_GetDirHeader(fmmdl) );
	MMDL_SetDirMove( fmmdl, MMDL_GetDirHeader(fmmdl) );
	MMDL_FreeAcmd( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル 動作関数初期化
 * @param	fmmdl		MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_InitCallMoveProcWork( MMDL * fmmdl )
{
	fmmdl->move_proc_list =
		MoveProcList_GetList( MMDL_GetMoveCode(fmmdl) );
}

//--------------------------------------------------------------
/**
 * MMDL 動作初期化に行う処理纏め
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_InitMoveWork( const MMDLSYS *fos, MMDL *fmmdl )
{
	MMdl_InitCallMoveProcWork( fmmdl );
	MMdl_AddTCB( fmmdl, fos );
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_MOVE_START );
}

//--------------------------------------------------------------
/**
 * MMDLSYS 動作初期化を行っていない動作モデルに対して初期化処理をセット
 * @param	fos	MMDLSYS*
 * @retval	nothing
 */
//--------------------------------------------------------------
#if 0
static void MMdlSys_CheckSetInitMoveWork( MMDLSYS *fos )
{
	u32 i = 0;
	MMDL *fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&i) == TRUE ){
		if( MMDL_CheckMoveBit(fmmdl,	//初期化関数呼び出しまだ
			MMDL_MOVEBIT_MOVEPROC_INIT) == 0 ){
			MMDL_InitMoveProc( fmmdl );
		}
	}
}
#endif

//--------------------------------------------------------------
/**
 * MMDLSYS 描画初期化を行っていない動作モデルに対して初期化処理をセット
 * @param	fos	MMDLSYS*
 * @retval	nothing
 */
//--------------------------------------------------------------
#if 0
static void MMdlSys_CheckSetInitDrawWork( MMDLSYS *fos )
{
	u32 i = 0;
	MMDL *fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&i) == TRUE ){
		if( MMDL_CheckStatusBitCompletedDrawInit(fmmdl) == FALSE ){
			MMdl_InitDrawWork( fmmdl );
		}
	}
}
#endif

//======================================================================
//	MMDLSYS PUSH POP
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS 動作モデル 退避
 * @param	fmmdlsys	MMDLSYS
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_Push( MMDLSYS *fmmdlsys )
{
	u32 no = 0;
	MMDL *fmmdl;
	
	#ifdef DEBUG_MMDL_PRINT
	if( MMDLSYS_CheckCompleteDrawInit(fmmdlsys) == FALSE ){
		GF_ASSERT( 0 && "WARNING!! 動作モデル 描画未初期化\n" );
	}
	#endif
	
	while( MMDLSYS_SearchUseMMdl(fmmdlsys,&fmmdl,&no) == TRUE ){
		{ //動作処理の退避
			MMdl_DeleteTCB( fmmdl );
			MMDL_OnMoveBit( fmmdl,
				MMDL_MOVEBIT_NEED_MOVEPROC_RECOVER );
		}
		
		{ //描画処理の退避
			MMDL_CallDrawPushProc( fmmdl );
			MMDL_OnStatusBit( fmmdl, MMDL_STABIT_DRAW_PUSH );
		}
	}
}

//--------------------------------------------------------------
/**
 * MMDLSYS 動作モデル復帰
 * @param	fmmdlsys	MMDLSYS
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_Pop( MMDLSYS *fmmdlsys )
{
	u32 no = 0;
	MMDL *fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(fmmdlsys,&fmmdl,&no) == TRUE ){
		{	//動作処理復帰
			MMdl_InitMoveWork( fmmdlsys, fmmdl ); //ワーク初期化
			
			if( MMDL_CheckMoveBit(fmmdl,	//初期化関数呼び出しまだ
				MMDL_MOVEBIT_MOVEPROC_INIT) == 0 ){
				MMDL_InitMoveProc( fmmdl );
			}
			
			if( MMDL_CheckMoveBit(fmmdl, //復元関数呼び出しが必要
				MMDL_MOVEBIT_NEED_MOVEPROC_RECOVER) ){
				MMDL_CallMovePopProc( fmmdl );
				MMDL_OffMoveBit( fmmdl,
					MMDL_MOVEBIT_NEED_MOVEPROC_RECOVER );
			}
		}
		
		{	//描画処理復帰
			if( MMDL_CheckStatusBitCompletedDrawInit(fmmdl) == FALSE ){
				MMdl_InitDrawWork( fmmdl );
			}
			
			if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_DRAW_PUSH) ){
				MMDL_CallDrawPopProc( fmmdl );
				MMDL_OffStatusBit( fmmdl, MMDL_STABIT_DRAW_PUSH );
			}
		}

    { //リカバリー
      MMdl_InitDrawEffectFlag( fmmdl );
    }
	}
}

//======================================================================
//	MMDL_SAVEDATA
//======================================================================
//--------------------------------------------------------------
/**
 * MMDL_SAVEDATA セーブデータ バッファサイズ取得
 * @param	nothing
 * @retval	u32	サイズ
 */
//--------------------------------------------------------------
u32 MMDL_SAVEDATA_GetWorkSize( void )
{
	return( sizeof(MMDL_SAVEDATA) );
}

//--------------------------------------------------------------
/**
 * MMDL_SAVEDATA セーブデータ バッファ初期化
 * @param	p	MMDL_SAVEDATA
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SAVEDATA_Init( void *p )
{
	MI_CpuClear8( p, MMDL_SAVEDATA_GetWorkSize() );
}

//--------------------------------------------------------------
/**
 * MMDL_SAVEDATA 動作モデルセーブ
 * @param	fmmdlsys セーブするMMDLSYS
 * @param	savedata LDMMDL_SAVEDATA
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SAVEDATA_Save(
	MMDLSYS *fmmdlsys, MMDL_SAVEDATA *savedata )
{
	u32 no = 0;
	MMDL *fmmdl;
	MMDL_SAVEWORK *save = savedata->SaveWorkBuf;
	
	while( MMDLSYS_SearchUseMMdl(fmmdlsys,&fmmdl,&no) == TRUE ){
		MMdl_SaveData_SaveMMdl( fmmdl, save );
		save++;
	}
}

//--------------------------------------------------------------
/**
 * MMDL_SAVEDATA 動作モデルロード
 * @param	fmmdlsys	MMDLSYS
 * @param	save	ロードするMMDL_SAVEWORK
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SAVEDATA_Load(
	MMDLSYS *fmmdlsys, MMDL_SAVEDATA *savedata )
{
	u32 no = 0;
	MMDL *fmmdl;
	MMDL_SAVEWORK *save = savedata->SaveWorkBuf;
	
	while( no < MMDL_SAVEMMDL_MAX ){
		if( (save->status_bit&MMDL_STABIT_USE) ){
			fmmdl = MMdlSys_SearchSpaceMMdl( fmmdlsys );
			MMdl_SaveData_LoadMMdl( fmmdl, save, fmmdlsys );
		}
		save++;
		no++;
	}

  fmmdlsys->fmmdl_count = no;
}

//--------------------------------------------------------------
/**
 * MMDL_SAVEDATA 動作モデル　セーブ
 * @param	fldmmdl		セーブするMMDL*
 * @param	save MMDL_SAVEWORK
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_SaveData_SaveMMdl(
	const MMDL *fmmdl, MMDL_SAVEWORK *save )
{
	save->status_bit = MMDL_GetStatusBit( fmmdl );
	save->move_bit = MMDL_GetMoveBit( fmmdl );
	save->obj_id = MMDL_GetOBJID( fmmdl );
	save->zone_id = MMDL_GetZoneID( fmmdl );
	save->obj_code = MMDL_GetOBJCode( fmmdl );
	save->move_code = MMDL_GetMoveCode( fmmdl );
	save->event_type = MMDL_GetEventType( fmmdl );
	save->event_flag = MMDL_GetEventFlag( fmmdl );
	save->event_id = MMDL_GetEventID( fmmdl );
	save->dir_head = MMDL_GetDirHeader( fmmdl );
	save->dir_disp = MMDL_GetDirDisp( fmmdl );
	save->dir_move = MMDL_GetDirMove( fmmdl );
	save->param0 = MMDL_GetParam( fmmdl, MMDL_PARAM_0 );
	save->param1 = MMDL_GetParam( fmmdl, MMDL_PARAM_1 );
	save->param2 = MMDL_GetParam( fmmdl, MMDL_PARAM_2 );
	save->move_limit_x = MMDL_GetMoveLimitX( fmmdl );
	save->move_limit_z = MMDL_GetMoveLimitZ( fmmdl );
	save->gx_init = MMDL_GetInitGridPosX( fmmdl );
	save->gy_init = MMDL_GetInitGridPosY( fmmdl );
	save->gz_init = MMDL_GetInitGridPosZ( fmmdl );
	save->gx_now = MMDL_GetGridPosX( fmmdl );
	save->gy_now = MMDL_GetGridPosY( fmmdl );
	save->gz_now = MMDL_GetGridPosZ( fmmdl );
	save->fx32_y = MMDL_GetVectorPosY( fmmdl );
	
	MI_CpuCopy8( MMDL_GetMoveProcWork((MMDL*)fmmdl),
		save->move_proc_work, MMDL_MOVE_WORK_SIZE );
	MI_CpuCopy8( MMDL_GetMoveSubProcWork((MMDL*)fmmdl),
		save->move_sub_proc_work, MMDL_MOVE_SUB_WORK_SIZE );
}

//--------------------------------------------------------------
/**
 * MMDL_SAVEDATA 動作モデル　ロード
 * @param	fldmmdl		セーブするMMDL*
 * @param	save MMDL_SAVEWORK
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_SaveData_LoadMMdl(
	MMDL *fmmdl, const MMDL_SAVEWORK *save, const MMDLSYS *fos )
{
	MMdl_ClearWork( fmmdl );

	fmmdl->status_bit = save->status_bit;
	fmmdl->move_bit = save->move_bit;
	MMDL_SetOBJID( fmmdl, save->obj_id );
	MMDL_SetZoneID( fmmdl, save->zone_id );
	MMDL_SetOBJCode( fmmdl, save->obj_code ); 
	MMDL_SetMoveCode( fmmdl, save->move_code );
	MMDL_SetEventType( fmmdl, save->event_type );
	MMDL_SetEventFlag( fmmdl, save->event_flag );
	MMDL_SetEventID( fmmdl, save->event_id );
	fmmdl->dir_head = save->dir_head;
	MMDL_SetForceDirDisp( fmmdl, save->dir_disp );
	MMDL_SetDirMove( fmmdl, save->dir_move );
	MMDL_SetParam( fmmdl, save->param0, MMDL_PARAM_0 );
	MMDL_SetParam( fmmdl, save->param1, MMDL_PARAM_1 );
	MMDL_SetParam( fmmdl, save->param2, MMDL_PARAM_2 );
	MMDL_SetMoveLimitX( fmmdl, save->move_limit_x );
	MMDL_SetMoveLimitZ( fmmdl, save->move_limit_z );
	MMDL_SetInitGridPosX( fmmdl, save->gx_init );
	MMDL_SetInitGridPosY( fmmdl, save->gy_init );
	MMDL_SetInitGridPosZ( fmmdl, save->gz_init );
	MMDL_SetGridPosX( fmmdl, save->gx_now );
	MMDL_SetGridPosY( fmmdl, save->gy_now );
	MMDL_SetGridPosZ( fmmdl, save->gz_now );
	
	MI_CpuCopy8( save->move_proc_work,
		MMDL_GetMoveProcWork((MMDL*)fmmdl), MMDL_MOVE_WORK_SIZE );
	MI_CpuCopy8( save->move_sub_proc_work,
		MMDL_GetMoveSubProcWork((MMDL*)fmmdl), MMDL_MOVE_SUB_WORK_SIZE );
	
	fmmdl->pMMdlSys = fos;
	
	{ //座標復帰
		s16 grid;
		VecFx32 pos = {0,0,0};
		
		grid = MMDL_GetGridPosX( fmmdl );
		MMDL_SetOldGridPosX( fmmdl, grid );
		pos.x = GRID_SIZE_FX32( grid ) + MMDL_VEC_X_GRID_OFFS_FX32;
		
		grid = MMDL_GetGridPosY( fmmdl );
		MMDL_SetOldGridPosY( fmmdl, grid );
		pos.y = save->fx32_y; //セーブ時の高さを信用する
	
		grid = MMDL_GetGridPosZ( fmmdl );
		MMDL_SetOldGridPosZ( fmmdl, grid );
		pos.z = GRID_SIZE_FX32( grid ) + MMDL_VEC_Z_GRID_OFFS_FX32;
	
		MMDL_SetVectorPos( fmmdl, &pos );
	}

	{ //ステータスビット復帰
		MMDL_OnStatusBit( fmmdl,
			MMDL_STABIT_USE |
//			MMDL_STABIT_HEIGHT_GET_NEED | //セーブ時の高さを信用する
			MMDL_STABIT_MOVE_START );
		
		MMDL_OffStatusBit( fmmdl,
			MMDL_STABIT_PAUSE_MOVE |
			MMDL_STABIT_VANISH |
			MMDL_STABIT_DRAW_PROC_INIT_COMP |
			MMDL_STABIT_JUMP_START |
			MMDL_STABIT_JUMP_END |
			MMDL_STABIT_MOVE_END |
			MMDL_STABIT_FELLOW_HIT_NON |
			MMDL_STABIT_TALK_OFF |
			MMDL_STABIT_DRAW_PUSH |
			MMDL_STABIT_BLACT_ADD_PRAC |
			MMDL_STABIT_HEIGHT_GET_OFF );
		
		MMDL_OffStatusBit( fmmdl,
			MMDL_STABIT_SHADOW_SET |
			MMDL_STABIT_SHADOW_VANISH |
			MMDL_STABIT_EFFSET_SHOAL	 |
			MMDL_STABIT_REFLECT_SET );
		
		if( MMDL_CheckMoveBit(fmmdl,MMDL_MOVEBIT_MOVEPROC_INIT) == 0 ){
			MMDL_OnMoveBit( fmmdl, MMDL_MOVEBIT_NEED_MOVEPROC_RECOVER );
		}
	}
}


//======================================================================
//	MMDL 動作関数
//======================================================================
//--------------------------------------------------------------
/**
 * MMDL 動作部分実行
 * @param	fmmdl	MMDL*
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_UpdateMoveProc( MMDL *fmmdl )
{
	MMDL_UpdateMove( fmmdl );
	
	if( MMDL_CheckStatusBitUse(fmmdl) == TRUE ){
		MMdl_TCB_DrawProc( fmmdl );
	}
}

//--------------------------------------------------------------
/**
 * MMDL TCB 動作関数
 * @param	tcb		GFL_TCB *
 * @param	work	tcb work
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_TCB_MoveProc( GFL_TCB * tcb, void *work )
{
	MMDL *fmmdl = (MMDL *)work;
	MMDL_UpdateMoveProc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL TCB 動作関数から呼ばれる描画関数
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_TCB_DrawProc( MMDL * fmmdl )
{
	const MMDLSYS *fos = MMDL_GetMMdlSys(fmmdl);
	
	if( MMDLSYS_CheckCompleteDrawInit(fos) == TRUE ){
		MMDL_UpdateDraw( fmmdl );
	}
}

//======================================================================
//	MMDL アニメーションコマンド
//======================================================================
//--------------------------------------------------------------
/**
 * アニメーションコマンドが可能かチェック
 * @param	fmmdl		対象となるMMDL * 
 * @retval	int			TRUE=可能。FALSE=無理
 */
//--------------------------------------------------------------
BOOL MMDL_CheckPossibleAcmd( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_USE) == 0 ){
		return( FALSE );
	}
	
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_MOVE) ){
		return( FALSE );
	}
	
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_ACMD) &&
		MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_ACMD_END) == 0 ){
		return( FALSE );
	}
	
	return( TRUE );
}

//--------------------------------------------------------------
/**
 * アニメーションコマンドセット
 * @param	fmmdl		対象となるMMDL * 
 * @param	code		実行するコード。AC_DIR_U等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetAcmd( MMDL * fmmdl, u16 code )
{
	GF_ASSERT( code < ACMD_MAX );
	MMDL_SetAcmdCode( fmmdl, code );
	MMDL_SetAcmdSeq( fmmdl, 0 );
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_ACMD );
	MMDL_OffStatusBit( fmmdl, MMDL_STABIT_ACMD_END );
}

//--------------------------------------------------------------
/**
 * コマンドセット
 * @param	fmmdl		対象となるMMDL * 
 * @param	code		実行するコード。AC_DIR_U等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetLocalAcmd( MMDL * fmmdl, u16 code )
{
	MMDL_SetAcmdCode( fmmdl, code );
	MMDL_SetAcmdSeq( fmmdl, 0 );
	MMDL_OffStatusBit( fmmdl, MMDL_STABIT_ACMD_END );
}

//--------------------------------------------------------------
/**
 * アニメーションコマンド終了チェック。
 * @param	fmmdl		対象となるMMDL * 
 * @retval	int			TRUE=終了
 */
//--------------------------------------------------------------
BOOL MMDL_CheckEndAcmd( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_ACMD) == 0 ){
		return( TRUE );
	}
	
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_ACMD_END) == 0 ){
		return( FALSE );
	}
	
	return( TRUE );
}

//--------------------------------------------------------------
/**
 * アニメーションコマンド終了チェックと開放。
 * アニメーションコマンドが終了していない場合は開放されない。
 * @param	fmmdl		対象となるMMDL * 
 * @retval	BOOL	TRUE=終了している。
 */
//--------------------------------------------------------------
BOOL MMDL_EndAcmd( MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_ACMD) == 0 ){
		return( TRUE );
	}
	
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_ACMD_END) == 0 ){
		return( FALSE );
	}
	
	MMDL_OffStatusBit(
		fmmdl, MMDL_STABIT_ACMD|MMDL_STABIT_ACMD_END );
	
	return( TRUE );
}

//--------------------------------------------------------------
/**
 * アニメーションコマンド開放。
 * アニメーションコマンドが終了していなくとも強制開放。
 * @param	fmmdl		対象となるMMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_FreeAcmd( MMDL * fmmdl )
{
	MMDL_OffStatusBit( fmmdl, MMDL_STABIT_ACMD );
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_ACMD_END ); //ローカルコマンドフラグ
	MMDL_SetAcmdCode( fmmdl, ACMD_NOT );
	MMDL_SetAcmdSeq( fmmdl, 0 );
}

//======================================================================
//	MMDLSYS パラメタ設定、参照
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS ステータスビットチェック
 * @param	fmmdlsys	MMDLSYS*
 * @param	bit	MMDLSYS_STABIT
 * @retval	u32	(status bit & bit)
 */
//--------------------------------------------------------------
u32 MMDLSYS_CheckStatusBit(
	const MMDLSYS *fmmdlsys, MMDLSYS_STABIT bit )
{
	return( (fmmdlsys->status_bit&bit) );
}

//--------------------------------------------------------------
/**
 * MMDLSYS ステータスビット ON
 * @param	fmmdlsys	MMDLSYS*
 * @param	bit	MMDLSYS_STABIT
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdlSys_OnStatusBit(
	MMDLSYS *fmmdlsys, MMDLSYS_STABIT bit )
{
	fmmdlsys->status_bit |= bit;
}

//--------------------------------------------------------------
/**
 * MMDLSYS ステータスビット OFF
 * @param	fmmdlsys	MMDLSYS*
 * @param	bit	MMDLSYS_STABIT
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdlSys_OffStatusBit(
	MMDLSYS *fmmdlsys, MMDLSYS_STABIT bit )
{
	fmmdlsys->status_bit &= ~bit;
}

//--------------------------------------------------------------
/**
 * FMMDLSYS 動作モデル最大数を取得
 * @param	fmmdlsys	MMDLSYS*
 * @retval	u16	最大数
 */
//--------------------------------------------------------------
u16 MMDLSYS_GetMMdlMax( const MMDLSYS *fmmdlsys )
{
	return( fmmdlsys->fmmdl_max );
}

//--------------------------------------------------------------
/**
 * FMMDLSYS 現在発生している動作モデルの数を取得
 * @param	fmmdlsys	MMDLSYS*
 * @retval	u16	発生数
 */
//--------------------------------------------------------------
u16 MMDLSYS_GetMMdlCount( const MMDLSYS *fmmdlsys )
{
	return( fmmdlsys->fmmdl_count );
}

//--------------------------------------------------------------
/**
 * MMDLSYS TCBプライオリティを取得
 * @param	fmmdlsys	MMDLSYS*
 * @retval	u16	TCBプライオリティ
 */
//--------------------------------------------------------------
u16 MMDLSYS_GetTCBPriority( const MMDLSYS *fmmdlsys )
{
	return( fmmdlsys->tcb_pri );
}

//--------------------------------------------------------------
/**
 * MMDLSYS HEAPID取得
 * @param	fmmdlsys	MMDLSYS*
 * @retval	HEAPID HEAPID
 */
//--------------------------------------------------------------
HEAPID MMDLSYS_GetHeapID( const MMDLSYS *fmmdlsys )
{
	return( fmmdlsys->heapID );
}

//--------------------------------------------------------------
/**
 * MMDLSYS 現在発生しているOBJ数を1増加
 * @param	fmmdlsys	MMDLSYS*
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdlSys_IncrementOBJCount( MMDLSYS *fmmdlsys )
{
	fmmdlsys->fmmdl_count++;
}

//--------------------------------------------------------------
/**
 * MMDLSYS 現在発生しているOBJ数を1減少
 * @param	fmmdlsys	MMDLSYS*
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdlSys_DecrementOBJCount( MMDLSYS *fmmdlsys )
{
	fmmdlsys->fmmdl_count--;
	GF_ASSERT( fmmdlsys->fmmdl_count >= 0 );
}

//--------------------------------------------------------------
/**
 * MMDLSYS GFL_TCBSYS*取得
 * @param	fos	MMDLSYS*
 * @retval	GFL_TCBSYS*
 */
//--------------------------------------------------------------
GFL_TCBSYS * MMDLSYS_GetTCBSYS( MMDLSYS *fos )
{
	return( fos->pTCBSys );
}

//--------------------------------------------------------------
/**
 * MMDLSYS MMDL_BLACTCONTセット
 * @param	fmmdlsys	MMDLSYS
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_SetBlActCont(
	MMDLSYS *fmmdlsys, MMDL_BLACTCONT *pBlActCont )
{
	fmmdlsys->pBlActCont = pBlActCont;
}

//--------------------------------------------------------------
/**
 * MMDLSYS MMDL_BLACTCONT取得
 * @param	fmmdlsys MMDLSYS
 * @retval	MMDL_BLACTCONT*
 */
//--------------------------------------------------------------
MMDL_BLACTCONT * MMDLSYS_GetBlActCont( MMDLSYS *fmmdlsys )
{
	GF_ASSERT( fmmdlsys->pBlActCont != NULL );
	return( fmmdlsys->pBlActCont );
}

//--------------------------------------------------------------
/**
 * MMDLSYS FLDMAPPER取得
 * @param	fmmdlsys	MMDLSYS
 * @retval	FLDMAPPER* FLDMAPPER*
 */
//--------------------------------------------------------------
const FLDMAPPER * MMDLSYS_GetG3DMapper( const MMDLSYS *fos )
{
	GF_ASSERT( fos->pG3DMapper != NULL);
	return( fos->pG3DMapper );
}

//--------------------------------------------------------------
/**
 * MMDLSYS FIELDMAP_WORKセット
 * @param fmmdlsys MMDLSYS
 * @param fieldMapWork FIELDMAP_WORK
 * @retval nothing
 */
//--------------------------------------------------------------
void MMDLSYS_SetFieldMapWork(
    MMDLSYS *fos, void *fieldMapWork )
{
  fos->fieldMapWork = fieldMapWork;
}

//--------------------------------------------------------------
/**
 * MMDLSYS FIELDMAP_WORK取得
 * @param fmmdlsys MMDLSYS
 * @retval fieldMapWork FIELDMAP_WORK
 */
//--------------------------------------------------------------
void * MMDLSYS_GetFieldMapWork( MMDLSYS *fos )
{
  GF_ASSERT( fos->fieldMapWork != NULL );
  return( fos->fieldMapWork );
}

//======================================================================
//	MMDL　パラメタ参照、設定
//======================================================================
//--------------------------------------------------------------
/**
 * MMDL ステータスビットON
 * @param	fmmdl	fmmdl
 * @param	bit		MMDL_STABIT
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OnStatusBit( MMDL *fmmdl, MMDL_STABIT bit )
{
	fmmdl->status_bit |= bit;
}

//--------------------------------------------------------------
/**
 * MMDL ステータスビットOFF
 * @param	fmmdl	fmmdl
 * @param	bit		MMDL_STABIT
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OffStatusBit( MMDL *fmmdl, MMDL_STABIT bit )
{
	fmmdl->status_bit &= ~bit;
}

//--------------------------------------------------------------
/**
 * MMDL ステータスビット取得
 * @param	fmmdl		MMDL * 
 * @retval	MMDL_STABIT ステータスビット
 */
//--------------------------------------------------------------
MMDL_STABIT MMDL_GetStatusBit( const MMDL * fmmdl )
{
	return( fmmdl->status_bit );
}

//--------------------------------------------------------------
/**
 * MMDL ステータスビットチェック
 * @param	fmmdl	MMDL*
 * @param	bit	MMDL_STABIT
 * @retval	u32	(status bit & bit)
 */
//--------------------------------------------------------------
u32 MMDL_CheckStatusBit( const MMDL *fmmdl, MMDL_STABIT bit )
{
	return( (fmmdl->status_bit&bit) );
}

//--------------------------------------------------------------
/**
 * MMDL 動作ビット　取得
 * @param	fmmdl	MMDL *
 * @retval	u32		動作ビット
 */
//--------------------------------------------------------------
MMDL_MOVEBIT MMDL_GetMoveBit( const MMDL * fmmdl )
{
	return( fmmdl->move_bit );
}

//--------------------------------------------------------------
/**
 * MMDL 動作ビット　ON
 * @param	fmmdl	MMDL *
 * @param	bit		立てるビット MMDL_MOVEBIT_NON等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OnMoveBit( MMDL * fmmdl, MMDL_MOVEBIT bit )
{
	fmmdl->move_bit |= bit;
}

//--------------------------------------------------------------
/**
 * MMDL 動作ビット　OFF
 * @param	fmmdl	MMDL *
 * @param	bit		下ろすビット MMDL_MOVEBIT_NON等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OffMoveBit( MMDL * fmmdl, MMDL_MOVEBIT bit )
{
	fmmdl->move_bit &= ~bit;
}

//--------------------------------------------------------------
/**
 * MMDL 動作ビット　チェック
 * @param	fmmdl	MMDL *
 * @param	bit		チェックするビット MMDL_MOVEBIT_NON等
 * @retval	nothing
 */
//--------------------------------------------------------------
u32 MMDL_CheckMoveBit( const MMDL * fmmdl, MMDL_MOVEBIT bit )
{
	return( (fmmdl->move_bit & bit) );
}

//--------------------------------------------------------------
/**
 * MMDL OBJ IDセット
 * @param	fmmdl	MMDL * 
 * @param	id		obj id
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetOBJID( MMDL * fmmdl, u16 obj_id )
{
	fmmdl->obj_id = obj_id;
}

//--------------------------------------------------------------
/**
 * MMDL OBJ ID取得
 * @param	fmmdl	MMDL *
 * @retval	u16		OBJ ID
 */
//--------------------------------------------------------------
u16 MMDL_GetOBJID( const MMDL * fmmdl )
{
	return( fmmdl->obj_id );
}

//--------------------------------------------------------------
/**
 * MMDL ZONE IDセット
 * @param	fmmdl	MMDL *
 * @param	zone_id	ゾーンID
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetZoneID( MMDL * fmmdl, u16 zone_id )
{
	fmmdl->zone_id = zone_id;
}

//--------------------------------------------------------------
/**
 * MMDL ZONE ID取得
 * @param	fmmdl	MMDL *
 * @retval	int		ZONE ID
 */
//--------------------------------------------------------------
u16 MMDL_GetZoneID( const MMDL * fmmdl )
{
	return( fmmdl->zone_id );
}

//--------------------------------------------------------------
/**
 * MMDL OBJコードセット
 * @param	fmmdl			MMDL * 
 * @param	code			セットするコード
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetOBJCode( MMDL * fmmdl, u16 code )
{
	fmmdl->obj_code = code;
}

//--------------------------------------------------------------
/**
 * MMDL OBJコード取得
 * @param	fmmdl			MMDL * 
 * @retval	u16				OBJコード
 */
//--------------------------------------------------------------
u16 MMDL_GetOBJCode( const MMDL * fmmdl )
{
	return( fmmdl->obj_code );
}

//--------------------------------------------------------------
/**
 * MMDL 動作コードセット
 * @param	fmmdl			MMDL * 
 * @param	code			動作コード
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetMoveCode( MMDL * fmmdl, u16 code )
{
	fmmdl->move_code = code;
}

//--------------------------------------------------------------
/**
 * MMDL 動作コード取得
 * @param	fmmdl			MMDL * 
 * @retval	u32				動作コード
 */
//--------------------------------------------------------------
u16 MMDL_GetMoveCode( const MMDL * fmmdl )
{
	return( fmmdl->move_code );
}

//--------------------------------------------------------------
/**
 * MMDL イベントタイプセット
 * @param	fmmdl		MMDL * 
 * @param	type		Event Type
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetEventType( MMDL * fmmdl, u16 type )
{
	fmmdl->event_type = type;
}

//--------------------------------------------------------------
/**
 * MMDL イベントタイプ取得
 * @param	fmmdl		MMDL * 
 * @retval	u32			Event Type
 */
//--------------------------------------------------------------
u16 MMDL_GetEventType( const MMDL * fmmdl )
{
	return( fmmdl->event_type );
}

//--------------------------------------------------------------
/**
 * MMDL イベントフラグセット
 * @param	fmmdl		MMDL * 
 * @param	flag		Event Flag
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetEventFlag( MMDL * fmmdl, u16 flag )
{
	fmmdl->event_flag = flag;
}

//--------------------------------------------------------------
/**
 * MMDL イベントフラグ取得
 * @param	fmmdl		MMDL * 
 * @retval	u16			Event Flag
 */
//--------------------------------------------------------------
u16 MMDL_GetEventFlag( const MMDL * fmmdl )
{
	return( fmmdl->event_flag );
}

//--------------------------------------------------------------
/**
 * MMDL イベントIDセット
 * @param	fmmdl		MMDL *
 * @param	id			Event ID
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetEventID( MMDL * fmmdl, u16 id )
{
	fmmdl->event_id = id;
}

//--------------------------------------------------------------
/**
 * MMDL イベントID取得
 * @param	fmmdl		MMDL * 
 * @retval	u16			Event ID
 */
//--------------------------------------------------------------
u16 MMDL_GetEventID( const MMDL * fmmdl )
{
	return( fmmdl->event_id );
}

//--------------------------------------------------------------
/**
 * MMDL イベントIDがエイリアスかどうかチェック
 * @param	fmmdl		MMDL * 
 * @retval	int			TRUE=エイリアスIDである FALSE=違う
 */
//--------------------------------------------------------------
BOOL MMDL_CheckAliesEventID( const MMDL * fmmdl )
{
	u16 id = (u16)MMDL_GetEventID( fmmdl );
	
	if( id == SP_SCRID_ALIES ){
		return( TRUE );
	}

	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL ヘッダー指定方向取得
 * @param	fmmdl		MMDL * 
 * @retval	u32			DIR_UP等
 */
//--------------------------------------------------------------
u32 MMDL_GetDirHeader( const MMDL * fmmdl )
{
	return( fmmdl->dir_head );
}

//--------------------------------------------------------------
/**
 * MMDL 表示方向セット　強制
 * @param	fmmdl			MMDL * 
 * @param	dir				DIR_UP等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetForceDirDisp( MMDL * fmmdl, u16 dir )
{
	fmmdl->dir_disp_old = fmmdl->dir_disp;
	fmmdl->dir_disp = dir;
}

//--------------------------------------------------------------
/**
 * MMDL 表示方向セット
 * @param	fmmdl			MMDL * 
 * @param	dir				DIR_UP等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetDirDisp( MMDL * fmmdl, u16 dir )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_PAUSE_DIR) == 0 ){
		fmmdl->dir_disp_old = fmmdl->dir_disp;
		fmmdl->dir_disp = dir;
	}
}

//--------------------------------------------------------------
/**
 * MMDL 表示方向取得
 * @param	fmmdl	MMDL * 
 * @retval	u16 	DIR_UP等
 */
//--------------------------------------------------------------
u16 MMDL_GetDirDisp( const MMDL * fmmdl )
{
	return( fmmdl->dir_disp );
}

//--------------------------------------------------------------
/**
 * MMDL 過去表示方向取得
 * @param	fmmdl			MMDL * 
 * @retval	dir				DIR_UP等
 */
//--------------------------------------------------------------
u16 MMDL_GetDirDispOld( const MMDL * fmmdl )
{
	return( fmmdl->dir_disp_old );
}

//--------------------------------------------------------------
/**
 * MMDL 移動方向セット
 * @param	fmmdl			MMDL * 
 * @param	dir				DIR_UP等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetDirMove( MMDL * fmmdl, u16 dir )
{
	fmmdl->dir_move_old = fmmdl->dir_move;
	fmmdl->dir_move = dir;
}

//--------------------------------------------------------------
/**
 * MMDL 移動方向取得
 * @param	fmmdl			MMDL * 
 * @retval	u16		DIR_UP等
 */
//--------------------------------------------------------------
u16 MMDL_GetDirMove( const MMDL * fmmdl )
{
	return( fmmdl->dir_move );
}

//--------------------------------------------------------------
/**
 * MMDL 過去移動方向取得
 * @param	fmmdl			MMDL * 
 * @retval	u16	DIR_UP等
 */
//--------------------------------------------------------------
u16 MMDL_GetDirMoveOld( const MMDL * fmmdl )
{
	return( fmmdl->dir_move_old );
}

//--------------------------------------------------------------
/**
 * MMDL 表示、移動方向セット
 * @param	fmmdl			MMDL * 
 * @param	dir				DIR_UP等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetDirAll( MMDL * fmmdl, u16 dir )
{
	MMDL_SetDirDisp( fmmdl, dir );
	MMDL_SetDirMove( fmmdl, dir );
}

//--------------------------------------------------------------
/**
 * MMDL ヘッダー指定パラメタセット
 * @param	fmmdl	MMDL * 
 * @param	param	パラメタ
 * @param	no		セットするパラメタ番号　MMDL_PARAM_0等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetParam( MMDL *fmmdl, u16 param, MMDL_H_PARAM no )
{
	switch( no ){
	case MMDL_PARAM_0: fmmdl->param0 = param; break;
	case MMDL_PARAM_1: fmmdl->param1 = param; break;
	case MMDL_PARAM_2: fmmdl->param2 = param; break;
	default: GF_ASSERT( 0 );
	}
}

//--------------------------------------------------------------
/**
 * MMDL ヘッダー指定パラメタ取得
 * @param	fmmdl			MMDL *
 * @param	param			MMDL_PARAM_0等
 * @retval	u16 パラメタ
 */
//--------------------------------------------------------------
u16 MMDL_GetParam( const MMDL * fmmdl, MMDL_H_PARAM param )
{
	switch( param ){
	case MMDL_PARAM_0: return( fmmdl->param0 );
	case MMDL_PARAM_1: return( fmmdl->param1 );
	case MMDL_PARAM_2: return( fmmdl->param2 );
	}
	
	GF_ASSERT( 0 );
	return( 0 );
}

//--------------------------------------------------------------
/**
 * MMDL 移動制限Xセット
 * @param	fmmdl			MMDL * 
 * @param	x				移動制限
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetMoveLimitX( MMDL * fmmdl, s16 x )
{
	fmmdl->move_limit_x = x;
}

//--------------------------------------------------------------
/**
 * MMDL 移動制限X取得
 * @param	fmmdl		MMDL * 
 * @retval	s16			移動制限X
 */
//--------------------------------------------------------------
s16 MMDL_GetMoveLimitX( const MMDL * fmmdl )
{
	return( fmmdl->move_limit_x );
}

//--------------------------------------------------------------
/**
 * MMDL 移動制限Zセット
 * @param	fmmdl			MMDL * 
 * @param	z				移動制限
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetMoveLimitZ( MMDL * fmmdl, s16 z )
{
	fmmdl->move_limit_z = z;
}

//--------------------------------------------------------------
/**
 * MMDL 移動制限Z取得
 * @param	fmmdl		MMDL * 
 * @retval	s16		移動制限z
 */
//--------------------------------------------------------------
s16 MMDL_GetMoveLimitZ( const MMDL * fmmdl )
{
	return( fmmdl->move_limit_z );
}

//--------------------------------------------------------------
/**
 * MMDL 描画ステータスセット
 * @param	fmmdl		MMDL * 
 * @param	st			DRAW_STA_STOP等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetDrawStatus( MMDL * fmmdl, u16 st )
{
	fmmdl->draw_status = st;
}

//--------------------------------------------------------------
/**
 * MMDL 描画ステータス取得
 * @param	fmmdl		MMDL * 
 * @retval	u16			DRAW_STA_STOP等
 */
//--------------------------------------------------------------
u16 MMDL_GetDrawStatus( const MMDL * fmmdl )
{
	return( fmmdl->draw_status );
}

//--------------------------------------------------------------
/**
 * MMDL MMDLSYS *取得
 * @param	fmmdl			MMDL * 
 * @retval	MMDLSYS	MMDLSYS *
 */
//--------------------------------------------------------------
const MMDLSYS * MMDL_GetMMdlSys( const MMDL *fmmdl )
{
	return( fmmdl->pMMdlSys );
}

//--------------------------------------------------------------
/**
 * MMDL 動作関数用ワーク初期化。
 * sizeがワークサイズを超えていた場合、ASSERT。
 * 動作用ワークはsize分、0で初期化。
 * @param	fmmdl	MMDL * 
 * @param	size	必要なワークサイズ
 * @retval	void*	初期化されたワーク
 */
//--------------------------------------------------------------
void * MMDL_InitMoveProcWork( MMDL * fmmdl, int size )
{
	void *work;
	GF_ASSERT( size <= MMDL_MOVE_WORK_SIZE );
	work = MMDL_GetMoveProcWork( fmmdl );
	GFL_STD_MemClear( work, size );
	return( work );
}

//--------------------------------------------------------------
/**
 * MMDL 動作関数用ワーク取得。
 * @param	fmmdl	MMDL * 
 * @retval	void*	ワーク
 */
//--------------------------------------------------------------
void * MMDL_GetMoveProcWork( MMDL * fmmdl )
{
	return( fmmdl->move_proc_work );
}

//--------------------------------------------------------------
/**
 * MMDL 動作補助関数用ワーク初期化。
 * sizeがワークサイズを超えていた場合、ASSERT。
 * @param	fmmdl	MMDL * 
 * @param	size	必要なワークサイズ
 * @retval	void*	初期化されたワーク
 */
//--------------------------------------------------------------
void * MMDL_InitMoveSubProcWork( MMDL * fmmdl, int size )
{
	u8 *work;
	
	GF_ASSERT( size <= MMDL_MOVE_SUB_WORK_SIZE );
	work = MMDL_GetMoveSubProcWork( fmmdl );
	GFL_STD_MemClear( work, size );
	return( work );
}

//--------------------------------------------------------------
/**
 * MMDL 動作補助関数用ワーク取得
 * @param	fmmdl	MMDL * 
 * @retval	void*	ワーク*
 */
//--------------------------------------------------------------
void * MMDL_GetMoveSubProcWork( MMDL * fmmdl )
{
	return( fmmdl->move_sub_proc_work );
}

//--------------------------------------------------------------
/**
 * MMDL 動作コマンド用ワーク初期化。
 * sizeがワークサイズを超えていた場合、ASSERT。
 * @param	fmmdl	MMDL * 
 * @param	size	必要なワークサイズ
 * @retval	void*	初期化されたワーク
 */
//--------------------------------------------------------------
void * MMDL_InitMoveCmdWork( MMDL * fmmdl, int size )
{
	u8 *work;
	
	GF_ASSERT( size <= MMDL_MOVE_CMD_WORK_SIZE );
	work = MMDL_GetMoveCmdWork( fmmdl );
	GFL_STD_MemClear( work, size );
	return( work );
}

//--------------------------------------------------------------
/**
 * MMDL 動作コマンド用ワーク取得
 * @param	fmmdl	MMDL *
 * @retval	void*	ワーク*
 */
//--------------------------------------------------------------
void * MMDL_GetMoveCmdWork( MMDL * fmmdl )
{
	return( fmmdl->move_cmd_proc_work );
}

//--------------------------------------------------------------
/**
 * MMDL 描画関数用ワーク初期化。
 * sizeがワークサイズを超えていた場合、ASSERT。
 * @param	fmmdl	MMDL * 
 * @param	size	必要なワークサイズ
 * @retval	void*	初期化されたワーク
 */
//--------------------------------------------------------------
void * MMDL_InitDrawProcWork( MMDL * fmmdl, int size )
{
	u8 *work;
	
	GF_ASSERT( size <= MMDL_DRAW_WORK_SIZE );
	work = MMDL_GetDrawProcWork( fmmdl );
	GFL_STD_MemClear( work, size );
	return( work );
}

//--------------------------------------------------------------
/**
 * MMDL 描画関数用ワーク取得
 * @param	fmmdl	MMDL * 
 * @retval	void*	ワーク
 */
//--------------------------------------------------------------
void * MMDL_GetDrawProcWork( MMDL * fmmdl )
{
	return( fmmdl->draw_proc_work );
}

//--------------------------------------------------------------
/**
 * MMDL 動作初期化関数実行
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_CallMoveInitProc( MMDL * fmmdl )
{
	GF_ASSERT( fmmdl->move_proc_list );
	GF_ASSERT( fmmdl->move_proc_list->init_proc );
	fmmdl->move_proc_list->init_proc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 動作関数実行
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_CallMoveProc( MMDL * fmmdl )
{
	GF_ASSERT( fmmdl->move_proc_list );
	GF_ASSERT( fmmdl->move_proc_list->move_proc );
	fmmdl->move_proc_list->move_proc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 削除関数実行
 * @param	fmmdl	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_CallMoveDeleteProc( MMDL * fmmdl )
{
	GF_ASSERT( fmmdl->move_proc_list );
	GF_ASSERT( fmmdl->move_proc_list->delete_proc );
	fmmdl->move_proc_list->delete_proc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 復帰関数実行
 * @param	fmmdl	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_CallMovePopProc( MMDL * fmmdl )
{
	GF_ASSERT( fmmdl->move_proc_list );
	GF_ASSERT( fmmdl->move_proc_list->recover_proc );
	fmmdl->move_proc_list->recover_proc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 描画初期化関数実行
 * @param	fmmdl	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_CallDrawInitProc( MMDL * fmmdl )
{
	GF_ASSERT( fmmdl->draw_proc_list );
	GF_ASSERT( fmmdl->draw_proc_list->init_proc );
	fmmdl->draw_proc_list->init_proc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 描画関数実行
 * @param	fmmdl	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_CallDrawProc( MMDL * fmmdl )
{
	GF_ASSERT( fmmdl->draw_proc_list );
	GF_ASSERT( fmmdl->draw_proc_list->draw_proc );
	fmmdl->draw_proc_list->draw_proc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 描画削除関数実行
 * @param	fmmdl	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_CallDrawDeleteProc( MMDL * fmmdl )
{
	GF_ASSERT( fmmdl->draw_proc_list );
	GF_ASSERT( fmmdl->draw_proc_list->delete_proc );
	fmmdl->draw_proc_list->delete_proc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 描画退避関数実行
 * @param	fmmdl	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_CallDrawPushProc( MMDL * fmmdl )
{
	GF_ASSERT( fmmdl->draw_proc_list );
	GF_ASSERT( fmmdl->draw_proc_list->push_proc );
	fmmdl->draw_proc_list->push_proc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 描画復帰関数実行
 * @param	fmmdl	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_CallDrawPopProc( MMDL * fmmdl )
{
	GF_ASSERT( fmmdl->draw_proc_list );
	GF_ASSERT( fmmdl->draw_proc_list->pop_proc );
	fmmdl->draw_proc_list->pop_proc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 描画取得関数実行
 * @param	fmmdl	MMDL*
 * @param	state	取得関数に与える情報
 * @retval	nothing
 */
//--------------------------------------------------------------
u32 MMDL_CallDrawGetProc( MMDL *fmmdl, u32 state )
{
	GF_ASSERT( fmmdl->draw_proc_list );
	GF_ASSERT( fmmdl->draw_proc_list->get_proc );
	return( fmmdl->draw_proc_list->get_proc(fmmdl,state) );
}

//--------------------------------------------------------------
/**
 * MMDL アニメーションコマンドコードセット
 * @param	fmmdl	MMDL * 
 * @param	code	AC_DIR_U等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetAcmdCode( MMDL * fmmdl, u16 code )
{
	fmmdl->acmd_code = code;
}

//--------------------------------------------------------------
/**
 * MMDL アニメーションコマンドコード取得
 * @param	fmmdl	MMDL * 
 * @retval	u16	AC_DIR_U等
 */
//--------------------------------------------------------------
u16 MMDL_GetAcmdCode( const MMDL * fmmdl )
{
	return( fmmdl->acmd_code );
}

//--------------------------------------------------------------
/**
 * MMDL アニメーションコマンドシーケンスセット
 * @param	fmmdl	MMDL * 
 * @param	no		シーケンス
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetAcmdSeq( MMDL * fmmdl, u16 no )
{
	fmmdl->acmd_seq = no;
}

//--------------------------------------------------------------
/**
 * MMDL アニメーションコマンドシーケンス増加
 * @param	fmmdl	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_IncAcmdSeq( MMDL * fmmdl )
{
	fmmdl->acmd_seq++;
}

//--------------------------------------------------------------
/**
 * MMDL アニメーションコマンドシーケンス取得
 * @param	fmmdl	MMDL * 
 * @retval	u16 シーケンス
 */
//--------------------------------------------------------------
u16 MMDL_GetAcmdSeq( const MMDL * fmmdl )
{
	return( fmmdl->acmd_seq );
}

//--------------------------------------------------------------
/**
 * MMDL 現在のマップアトリビュートをセット
 * @param	fmmdl	MMDL *
 * @param	attr	セットするアトリビュート
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetMapAttr( MMDL * fmmdl, u32 attr )
{
	fmmdl->now_attr = attr;
}

//--------------------------------------------------------------
/**
 * MMDL 現在のマップアトリビュートを取得
 * @param	fmmdl	MMDL *
 * @retval	u32		マップアトリビュート
 */
//--------------------------------------------------------------
u32 MMDL_GetMapAttr( const MMDL * fmmdl )
{
	return( fmmdl->now_attr );
}

//--------------------------------------------------------------
/**
 * MMDL 過去のマップアトリビュートをセット
 * @param	fmmdl	MMDL *
 * @param	attr	セットするアトリビュート
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetMapAttrOld( MMDL * fmmdl, u32 attr )
{
	fmmdl->old_attr = attr;
}

//--------------------------------------------------------------
/**
 * MMDL 過去のマップアトリビュートを取得
 * @param	fmmdl	MMDL *
 * @retval	u32		マップアトリビュート
 */
//--------------------------------------------------------------
u32 MMDL_GetMapAttrOld( const MMDL * fmmdl )
{
	return( fmmdl->old_attr );
}

//--------------------------------------------------------------
/**
 * MMDL エイリアス時のゾーンID取得。
 * ※エイリアス時はイベントフラグが指定ゾーンID
 * @param	fmmdl	MMDL *
 * @retval	u16 ゾーンID
 */
//--------------------------------------------------------------
u16 MMDL_GetZoneIDAlies( const MMDL * fmmdl )
{
	GF_ASSERT( MMDL_CheckStatusBitAlies(fmmdl) == TRUE );
	return( MMDL_GetEventFlag(fmmdl) );
}

//--------------------------------------------------------------
/**
 * MMDL 初期座標 グリッドX座標取得
 * @param	fmmdl	MMDL * 
 * @retval	s16 X座標
 */
//--------------------------------------------------------------
s16 MMDL_GetInitGridPosX( const MMDL * fmmdl )
{
	return( fmmdl->gx_init );
}

//--------------------------------------------------------------
/**
 * MMDL 初期座標 グリッドX座標セット
 * @param	fmmdl	MMDL * 
 * @param	x		セットする座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetInitGridPosX( MMDL * fmmdl, s16 x )
{
	fmmdl->gx_init = x;
}

//--------------------------------------------------------------
/**
 * MMDL 初期座標 Y座標取得
 * @param	fmmdl	MMDL * 
 * @retval	s16		Y
 */
//--------------------------------------------------------------
s16 MMDL_GetInitGridPosY( const MMDL * fmmdl )
{
	return( fmmdl->gy_init );
}

//--------------------------------------------------------------
/**
 * MMDL 初期座標 Y座標セット
 * @param	fmmdl	MMDL * 
 * @param	y		セットする座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetInitGridPosY( MMDL * fmmdl, s16 y )
{
	fmmdl->gy_init = y;
}

//--------------------------------------------------------------
/**
 * MMDL 初期座標 z座標取得
 * @param	fmmdl	MMDL * 
 * @retval	s16		z座標
 */
//--------------------------------------------------------------
s16 MMDL_GetInitGridPosZ( const MMDL * fmmdl )
{
	return( fmmdl->gz_init );
}

//--------------------------------------------------------------
/**
 * MMDL 初期座標 z座標セット
 * @param	fmmdl	MMDL * 
 * @param	z		セットする座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetInitGridPosZ( MMDL * fmmdl, s16 z )
{
	fmmdl->gz_init = z;
}

//--------------------------------------------------------------
/**
 * MMDL 過去座標　X座標取得
 * @param	fmmdl	MMDL * 
 * @retval	s16		X座標
 */
//--------------------------------------------------------------
s16 MMDL_GetOldGridPosX( const MMDL * fmmdl )
{
	return( fmmdl->gx_old );
}

//--------------------------------------------------------------
/**
 * MMDL 過去座標 X座標セット
 * @param	fmmdl	MMDL * 
 * @param	x		セットする座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetOldGridPosX( MMDL * fmmdl, s16 x )
{
	fmmdl->gx_old = x;
}

//--------------------------------------------------------------
/**
 * MMDL 過去座標 Y座標取得
 * @param	fmmdl	MMDL * 
 * @retval	s16		Y
 */
//--------------------------------------------------------------
s16 MMDL_GetOldGridPosY( const MMDL * fmmdl )
{
	return( fmmdl->gy_old );
}

//--------------------------------------------------------------
/**
 * MMDL 過去座標 Y座標セット
 * @param	fmmdl	MMDL * 
 * @param	y		セットする座標
 * @retval	s16		y座標
 */
//--------------------------------------------------------------
void MMDL_SetOldGridPosY( MMDL * fmmdl, s16 y )
{
	fmmdl->gy_old = y;
}

//--------------------------------------------------------------
/**
 * MMDL 過去座標 z座標取得
 * @param	fmmdl	MMDL * 
 * @retval	s16		z座標
 */
//--------------------------------------------------------------
s16 MMDL_GetOldGridPosZ( const MMDL * fmmdl )
{
	return( fmmdl->gz_old );
}

//--------------------------------------------------------------
/**
 * MMDL 過去座標 z座標セット
 * @param	fmmdl	MMDL * 
 * @param	z		セットする座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetOldGridPosZ( MMDL * fmmdl, s16 z )
{
	fmmdl->gz_old = z;
}

//--------------------------------------------------------------
/**
 * MMDL 現在座標 X座標取得
 * @param	fmmdl	MMDL * 
 * @retval	s16		X座標
 */
//--------------------------------------------------------------
s16 MMDL_GetGridPosX( const MMDL * fmmdl )
{
	return( fmmdl->gx_now );
}

//--------------------------------------------------------------
/**
 * MMDL 現在座標 X座標セット
 * @param	fmmdl	MMDL * 
 * @param	x		セットする座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetGridPosX( MMDL * fmmdl, s16 x )
{
	fmmdl->gx_now = x;
}

//--------------------------------------------------------------
/**
 * MMDL 現在座標 X座標増加
 * @param	fmmdl	MMDL * 
 * @param	x		足す値
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_AddGridPosX( MMDL * fmmdl, s16 x )
{
	fmmdl->gx_now += x;
}

//--------------------------------------------------------------
/**
 * MMDL 現在座標 Y座標取得
 * @param	fmmdl	MMDL * 
 * @retval	s16		Y
 */
//--------------------------------------------------------------
s16 MMDL_GetGridPosY( const MMDL * fmmdl )
{
	return( fmmdl->gy_now );
}

//--------------------------------------------------------------
/**
 * MMDL 現在座標 Y座標セット
 * @param	fmmdl	MMDL * 
 * @param	y		セットする座標
 * @retval	s16		y座標
 */
//--------------------------------------------------------------
void MMDL_SetGridPosY( MMDL * fmmdl, s16 y )
{
	fmmdl->gy_now = y;
}

//--------------------------------------------------------------
/**
 * MMDL 現在座標 Y座標増加
 * @param	fmmdl	MMDL * 
 * @param	y		足す値
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_AddGridPosY( MMDL * fmmdl, s16 y )
{
	fmmdl->gy_now += y;
}

//--------------------------------------------------------------
/**
 * MMDL 過去座標 z座標取得
 * @param	fmmdl	MMDL * 
 * @retval	s16		z座標
 */
//--------------------------------------------------------------
s16 MMDL_GetGridPosZ( const MMDL * fmmdl )
{
	return( fmmdl->gz_now );
}

//--------------------------------------------------------------
/**
 * MMDL 現在座標 z座標セット
 * @param	fmmdl	MMDL * 
 * @param	z		セットする座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetGridPosZ( MMDL * fmmdl, s16 z )
{
	fmmdl->gz_now = z;
}

//--------------------------------------------------------------
/**
 * MMDL 現在座標 z座標増加
 * @param	fmmdl	MMDL * 
 * @param	z		足す値
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_AddGridPosZ( MMDL * fmmdl, s16 z )
{
	fmmdl->gz_now += z;
}

//--------------------------------------------------------------
/**
 * MMDL 実座標ポインタ取得
 * @param	fmmdl	MMDL * 
 * @retval VecFx32*
 */
//--------------------------------------------------------------
const VecFx32 * MMDL_GetVectorPosAddress( const MMDL * fmmdl )
{
  return( &fmmdl->vec_pos_now );
}

//--------------------------------------------------------------
/**
 * MMDL 実座標取得
 * @param	fmmdl	MMDL * 
 * @param	vec		座標格納先
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_GetVectorPos( const MMDL * fmmdl, VecFx32 *vec )
{
	*vec = fmmdl->vec_pos_now;
}

//--------------------------------------------------------------
/**
 * MMDL 実座標セット
 * @param	fmmdl	MMDL * 
 * @param	vec		セット座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetVectorPos( MMDL * fmmdl, const VecFx32 *vec )
{
	fmmdl->vec_pos_now = *vec;
}

//--------------------------------------------------------------
/**
 * MMDL 実座標Y値取得
 * @param	fmmdl	MMDL * 
 * @retval	fx32	高さ
 */
//--------------------------------------------------------------
fx32 MMDL_GetVectorPosY( const MMDL * fmmdl )
{
	return( fmmdl->vec_pos_now.y );
}

//--------------------------------------------------------------
/**
 * MMDL 表示座標オフセット取得
 * @param	fmmdl	MMDL * 
 * @param	vec		セット座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_GetVectorDrawOffsetPos( const MMDL * fmmdl, VecFx32 *vec )
{
	*vec = fmmdl->vec_draw_offs;
}

//--------------------------------------------------------------
/**
 * MMDL 表示座標オフセットセット
 * @param	fmmdl	MMDL * 
 * @param	vec		セット座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetVectorDrawOffsetPos( MMDL * fmmdl, const VecFx32 *vec )
{
	fmmdl->vec_draw_offs = *vec;
}

//--------------------------------------------------------------
/**
 * MMDL 外部指定表示座標オフセット取得
 * @param	fmmdl	MMDL * 
 * @param	vec		セット座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_GetVectorOuterDrawOffsetPos( const MMDL * fmmdl, VecFx32 *vec )
{
	*vec = fmmdl->vec_draw_offs_outside;
}

//--------------------------------------------------------------
/**
 * MMDL 外部指定表示座標オフセットセット
 * @param	fmmdl	MMDL * 
 * @param	vec		セット座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetVectorOuterDrawOffsetPos( MMDL * fmmdl, const VecFx32 *vec )
{
	fmmdl->vec_draw_offs_outside = *vec;
}

//--------------------------------------------------------------
/**
 * MMDL アトリビュート変化座標オフセット取得
 * @param	fmmdl	MMDL * 
 * @param	vec		セット座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_GetVectorAttrDrawOffsetPos( const MMDL * fmmdl, VecFx32 *vec )
{
	*vec = fmmdl->vec_attr_offs;
}

//--------------------------------------------------------------
/**
 * MMDL アトリビュート変化座標オフセットセット
 * @param	fmmdl	MMDL * 
 * @param	vec		セット座標
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetVectorAttrDrawOffsetPos( MMDL * fmmdl, const VecFx32 *vec )
{
	fmmdl->vec_attr_offs = *vec;
}

//--------------------------------------------------------------
/**
 * MMDL 高さ(グリッド単位)を取得
 * @param	fmmdl	MMDL *
 * @retval	s16		高さ。H_GRID単位
 */
//--------------------------------------------------------------
s16 MMDL_GetHeightGrid( const MMDL * fmmdl )
{
	fx32 y = MMDL_GetVectorPosY( fmmdl );
	s16 gy = SIZE_GRID_FX32( y );
	return( gy );
}

//--------------------------------------------------------------
/**
 * MMDL MMDL_BLACTCONTを取得
 * @param	fmmdl	MMDL *
 * @retval	MMDL_BLACTCONT*
 */
//--------------------------------------------------------------
MMDL_BLACTCONT * MMDL_GetBlActCont( MMDL *fmmdl )
{
	return( MMDLSYS_GetBlActCont((MMDLSYS*)MMDL_GetMMdlSys(fmmdl)) );
}

//======================================================================
//	MMDLSYS ステータス操作
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS 描画処理が初期化されているかどうかチェック
 * @param	fmmdlsys	MMDLSYS *
 * @retval	BOOL	TRUE=初期化されている
 */
//--------------------------------------------------------------
BOOL MMDLSYS_CheckCompleteDrawInit( const MMDLSYS *fmmdlsys )
{
	if( MMDLSYS_CheckStatusBit(
			fmmdlsys,MMDLSYS_STABIT_DRAW_INIT_COMP) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDLSYS 描画処理初期化完了セット
 * @param	fmmdlsys	MMDLSYS*
 * @param	flag	TRUE=初期化完了
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_SetCompleteDrawInit( MMDLSYS *fmmdlsys, BOOL flag )
{
	if( flag == TRUE ){
		MMdlSys_OnStatusBit( fmmdlsys, MMDLSYS_STABIT_DRAW_INIT_COMP );
	}else{
		MMdlSys_OffStatusBit( fmmdlsys, MMDLSYS_STABIT_DRAW_INIT_COMP );
	}
}

//--------------------------------------------------------------
/**
 * MMDLSYS 影を付ける、付けないのセット
 * @param	fmmdlsys MMDLSYS *
 * @param	flag	TRUE=影を付ける FALSE=影を付けない
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_SetJoinShadow( MMDLSYS *fos, BOOL flag )
{
	if( flag == FALSE ){
		MMdlSys_OnStatusBit( fos, MMDLSYS_STABIT_SHADOW_JOIN_NOT );
	}else{
		MMdlSys_OffStatusBit( fos, MMDLSYS_STABIT_SHADOW_JOIN_NOT );
	}
}

//--------------------------------------------------------------
/**
 * MMDLSYS 影を付ける、付けないのチェック
 * @param	fmmdlsys MMDLSYS *
 * @retval	BOOL TRUE=付ける
 */
//--------------------------------------------------------------
BOOL MMDLSYS_CheckJoinShadow( const MMDLSYS *fos )
{
	if( MMDLSYS_CheckStatusBit(fos,MMDLSYS_STABIT_SHADOW_JOIN_NOT) ){
		return( FALSE );
	}
	return( TRUE );
}

//======================================================================
//	MMDLSYS プロセス操作
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS フィールド動作モデル全体の動作を完全停止。
 * 動作処理、描画処理を完全停止する。アニメーションコマンドにも反応しない。
 * @param	fmmdlsys	MMDLSYS*
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_StopProc( MMDLSYS *fmmdlsys )
{
	MMdlSys_OnStatusBit( fmmdlsys,
		MMDLSYS_STABIT_MOVE_PROC_STOP|MMDLSYS_STABIT_DRAW_PROC_STOP );
}

//--------------------------------------------------------------
/**
 * MMDLSYS MMDLSYS_StopProc()の解除。
 * @param	fmmdlsys	MMDLSYS*
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_PlayProc( MMDLSYS *fmmdlsys )
{
	MMdlSys_OffStatusBit( fmmdlsys,
		MMDLSYS_STABIT_MOVE_PROC_STOP|MMDLSYS_STABIT_DRAW_PROC_STOP );
}

//--------------------------------------------------------------
/**
 * MMDLSYS フィールド動作モデル全体の動作を一時停止
 * 固有の動作処理（ランダム移動等）を一時停止する。
 * アニメーションコマンドには反応する。
 * @param	fmmdlsys	MMDLSYS *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_PauseMoveProc( MMDLSYS *fmmdlsys )
{
	u32 no = 0;
	MMDL *fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(fmmdlsys,&fmmdl,&no) == TRUE ){
		MMDL_OnStatusBitMoveProcPause( fmmdl );
	}
}

//--------------------------------------------------------------
/**
 * MMDLSYS フィールド動作モデル全体の一時停止を解除
 * @param	fmmdlsys	MMDLSYS *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_ClearPauseMoveProc( MMDLSYS *fmmdlsys )
{
	u32 no = 0;
	MMDL *fmmdl;

	while( MMDLSYS_SearchUseMMdl(fmmdlsys,&fmmdl,&no) == TRUE ){
		MMDL_OffStatusBitMoveProcPause( fmmdl );
	}
}

//======================================================================
//	MMDL ステータスビット関連
//======================================================================
//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデルから
 * フィールド動作モデルシステムのビットチェック
 * @param	fmmdl		MMDL*
 * @param	bit			MMDLSYS_STABIT_DRAW_INIT_COMP等
 * @retval	u32			0以外 bitヒット
 */
//--------------------------------------------------------------
u32 MMDL_CheckMMdlSysStatusBit(
	const MMDL *fmmdl, MMDLSYS_STABIT bit )
{
	const MMDLSYS *fos = MMDL_GetMMdlSys( fmmdl );
	return( MMDLSYS_CheckStatusBit(fos,bit) );
}

//--------------------------------------------------------------
/**
 * MMDL 使用チェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL	TRUE=使用中
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitUse( const MMDL *fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_USE) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 移動動作中にする
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OnStatusBitMove( MMDL *fmmdl )
{
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_MOVE );
}

//--------------------------------------------------------------
/**
 * MMDL 移動動作中を解除
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OffStatusBitMove( MMDL * fmmdl )
{
	MMDL_OffStatusBit( fmmdl, MMDL_STABIT_MOVE );
}

//--------------------------------------------------------------
/**
 * MMDL 移動動作中チェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=動作中
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitMove( const MMDL *fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_MOVE) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 移動動作開始にする
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OnStatusBitMoveStart( MMDL * fmmdl )
{
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_MOVE_START );
}

//--------------------------------------------------------------
/**
 * MMDL 移動動作開始を解除
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OffStatusBitMoveStart( MMDL * fmmdl )
{
	MMDL_OffStatusBit( fmmdl, MMDL_STABIT_MOVE_START );
}

//--------------------------------------------------------------
/**
 * MMDL 移動動作開始チェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=移動動作開始
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitMoveStart( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_MOVE_START) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 移動動作終了にする
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OnStatusBitMoveEnd( MMDL * fmmdl )
{
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_MOVE_END );
}

//--------------------------------------------------------------
/**
 * MMDL 移動動作終了を解除
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OffStatusBitMoveEnd( MMDL * fmmdl )
{
	MMDL_OffStatusBit( fmmdl, MMDL_STABIT_MOVE_END );
}

//--------------------------------------------------------------
/**
 * MMDL 移動動作終了チェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=移動終了
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitMoveEnd( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_MOVE_END) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 描画初期化完了にする
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OnStatusBitCompletedDrawInit( MMDL * fmmdl )
{
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_DRAW_PROC_INIT_COMP );
}

//--------------------------------------------------------------
/**
 * MMDL 描画初期化完了を解除
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OffStatusBitCompletedDrawInit( MMDL * fmmdl )
{
	MMDL_OffStatusBit( fmmdl, MMDL_STABIT_DRAW_PROC_INIT_COMP );
}

//--------------------------------------------------------------
/**
 * MMDL 描画初期化完了チェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=描画初期化完了
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitCompletedDrawInit( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(
			fmmdl,MMDL_STABIT_DRAW_PROC_INIT_COMP) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 非表示フラグをチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=非表示　FALSE=表示
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitVanish( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_VANISH) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 非表示フラグを設定
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=非表示　FALSE=表示
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitVanish( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_VANISH );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_VANISH );
	}
}

//--------------------------------------------------------------
/**
 * MMDL OBJ同士の当たり判定フラグを設定
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=ヒットアリ　FALSE=ヒットナシ
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitFellowHit( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_FELLOW_HIT_NON );
	}else{
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_FELLOW_HIT_NON );
	}
}

//--------------------------------------------------------------
/**
 * MMDL 動作中フラグのセット
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=動作中　FALSE=停止中
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitMove( MMDL * fmmdl, int flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBitMove( fmmdl );
	}else{
		MMDL_OffStatusBitMove( fmmdl );
	}
}

//--------------------------------------------------------------
/**
 * MMDL 話しかけ可能チェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=可能 FALSE=不可
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitTalk( MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_TALK_OFF) ){
		return( FALSE );
	}
	return( TRUE );
}

//--------------------------------------------------------------
/**
 * MMDL 話しかけ不可フラグをセット
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=不可 FALSE=可能
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitTalkOFF( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_TALK_OFF );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_TALK_OFF );
	}
}

//--------------------------------------------------------------
/**
 * MMDL 動作ポーズ
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OnStatusBitMoveProcPause( MMDL * fmmdl )
{
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_PAUSE_MOVE );
}

//--------------------------------------------------------------
/**
 * MMDL 動作ポーズ解除
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_OffStatusBitMoveProcPause( MMDL * fmmdl )
{
	MMDL_OffStatusBit( fmmdl, MMDL_STABIT_PAUSE_MOVE );
}

//--------------------------------------------------------------
/**
 * MMDL 動作ポーズチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=動作ポーズ
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitMoveProcPause( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_PAUSE_MOVE) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL ステータスビット 描画処理初期化完了チェック
 * @param	fmmdl		MMDL *
 * @retval	BOOL TRUE=完了。FALSE=まだ
 */
//--------------------------------------------------------------
BOOL MMDL_CheckCompletedDrawInit( const MMDL * fmmdl )
{
	const MMDLSYS *fos;
	
	fos = MMDL_GetMMdlSys( fmmdl );
	
	if( MMDLSYS_CheckCompleteDrawInit(fos) == FALSE ){
		return( FALSE );
	}
	
	if( MMDL_CheckStatusBitCompletedDrawInit(fmmdl) ){
		return( TRUE );
	}
	
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 高さ取得を禁止する
 * @param	fmmdl	MMDL *
 * @param	int		TRUE=高さ取得OFF FALSE=ON
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitHeightGetOFF( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_HEIGHT_GET_OFF );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_HEIGHT_GET_OFF );
	}
}

//--------------------------------------------------------------
/**
 * MMDL 高さ取得が禁止されているかチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=禁止
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitHeightGetOFF( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_HEIGHT_GET_OFF) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL ゾーン切り替え時の削除禁止
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=禁止 FALSE=禁止しない
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitNotZoneDelete( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_ZONE_DEL_NOT );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_ZONE_DEL_NOT );
	}
}

//--------------------------------------------------------------
/**
 * MMDL エイリアスフラグをセット
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=エイリアス FALSE=違う
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitAlies( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_ALIES );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_ALIES );
	}
}

//--------------------------------------------------------------
/**
 * MMDL エイリアスフラグをチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=エイリアス FALSE=違う
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitAlies( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_ALIES) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 浅瀬エフェクトセットフラグをセット
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=セット　FALSE=クリア
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitShoalEffect( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_EFFSET_SHOAL );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_EFFSET_SHOAL );
	}
}

//--------------------------------------------------------------
/**
 * MMDL 浅瀬エフェクトセットフラグをチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=セット　FALSE=違う
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitShoalEffect( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_EFFSET_SHOAL) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL アトリビュートオフセット設定OFFセット
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=セット　FALSE=クリア
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitAttrOffsetOFF( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_ATTR_OFFS_OFF );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_ATTR_OFFS_OFF );
	}
}

//--------------------------------------------------------------
/**
 * MMDL アトリビュートオフセット設定OFFチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=OFF　FALSE=違う
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitAttrOffsetOFF( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_ATTR_OFFS_OFF) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 橋移動フラグセット
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=セット　FALSE=クリア
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitBridge( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_BRIDGE );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_BRIDGE );
	}
}

//--------------------------------------------------------------
/**
 * MMDL 橋移動フラグチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=橋　FALSE=違う
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitBridge( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_BRIDGE) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 映りこみフラグセット
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=セット　FALSE=クリア
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitReflect( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_REFLECT_SET );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_REFLECT_SET );
	}
}

//--------------------------------------------------------------
/**
 * MMDL 映りこみフラグチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=セット　FALSE=無し
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitReflect( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_REFLECT_SET) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL アニメーションコマンドチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=コマンドアリ　FALSE=無し
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitAcmd( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_ACMD) ){
		return( TRUE );
	}
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 拡張高さ反応フラグをセット
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=セット　FALSE=クリア
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetStatusBitHeightExpand( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnStatusBit( fmmdl, MMDL_STABIT_HEIGHT_EXPAND );
	}else{
		MMDL_OffStatusBit( fmmdl, MMDL_STABIT_HEIGHT_EXPAND );
	}
}

//--------------------------------------------------------------
/**
 * MMDL 拡張高さ反応フラグチェック
 * @param	fmmdl	MMDL *
 * @retval	BOOL TRUE=拡張高さに反応する　FALSE=無し
 */
//--------------------------------------------------------------
BOOL MMDL_CheckStatusBitHeightExpand( const MMDL * fmmdl )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_HEIGHT_EXPAND) ){
		return( TRUE );
	}
	return( FALSE );
}

//======================================================================
//	MMDL 動作ビット関連
//======================================================================
//--------------------------------------------------------------
/**
 * MMDL アトリビュート取得を停止
 * @param	fmmdl	MMDL *
 * @param	flag	TRUE=停止
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_SetMoveBitAttrGetOFF( MMDL * fmmdl, BOOL flag )
{
	if( flag == TRUE ){
		MMDL_OnMoveBit( fmmdl, MMDL_MOVEBIT_ATTR_GET_OFF );
	}else{
		MMDL_OffMoveBit( fmmdl, MMDL_MOVEBIT_ATTR_GET_OFF );
	}
}

//--------------------------------------------------------------
/**
 * MMDL アトリビュート取得を停止　チェック
 * @param	fmmdl	MMDL *
 * @retval	int	TRUE=停止
 */
//--------------------------------------------------------------
int MMDL_CheckMoveBitAttrGetOFF( const MMDL * fmmdl )
{
	if( MMDL_CheckMoveBit(fmmdl,MMDL_MOVEBIT_ATTR_GET_OFF) ){
		return( TRUE );
	}
	return( FALSE );
}

//======================================================================
//	MMDLSYS ツール
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS 使用しているフィールド動作モデルを探す。
 * @param	fos	MMDLSYS *
 * @param	fmmdl	MMDL*格納先
 * @param	no	検索開始ワークno。先頭から検索する際は初期値0を指定。
 * @retval BOOL TRUE=動作モデル取得した FALSE=noから終端まで検索し取得無し
 * @note 引数noは呼び出し後、取得位置+1の値になる。
 * @note ※例：OBJ ID 1番の動作モデルを探す。
 * u32 no=0;
 * MMDL *fmmdl;
 * while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&no) == TRUE ){
 * 		if( MMDL_GetOBJID(fmmdl) == 1 ){
 * 			break;
 * 		}
 * }
 */
//--------------------------------------------------------------
BOOL MMDLSYS_SearchUseMMdl(
	const MMDLSYS *fos, MMDL **fmmdl, u32 *no )
{
	u32 max = MMDLSYS_GetMMdlMax( fos );
	
	if( (*no) < max ){
		MMDL *check_obj = &(((MMDLSYS*)fos)->pMMdlBuf[*no]);
		
		do{
			(*no)++;
			if( MMDL_CheckStatusBit(check_obj,MMDL_STABIT_USE) ){
				*fmmdl = check_obj;
				return( TRUE );
			}
			check_obj++;
		}while( (*no) < max );
	}
	
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDLSYS 指定されたグリッドX,Z座標にいるOBJを取得
 * @param	sys			MMDLSYS *
 * @param	x			検索グリッドX
 * @param	z			検索グリッドZ
 * @param	old_hit		TURE=過去座標も判定する
 * @retval	MMDL	x,z位置にいるMMDL * 。NULL=その座標にOBJはいない
 */
//--------------------------------------------------------------
MMDL * MMDLSYS_SearchGridPos(
	const MMDLSYS *sys, s16 x, s16 z, BOOL old_hit )
{
	u32 no = 0;
	MMDL *fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(sys,&fmmdl,&no) == TRUE ){
		if( old_hit ){
			if( MMDL_GetOldGridPosX(fmmdl) == x &&
				MMDL_GetOldGridPosZ(fmmdl) == z ){
				return( fmmdl );
			}
		}
		
		if( MMDL_GetGridPosX(fmmdl) == x &&
			MMDL_GetGridPosZ(fmmdl) == z ){
			return( fmmdl );
		}
	}
	
	return( NULL );
}

//--------------------------------------------------------------
/**
 * MMDLSYS 動作コードに一致するMMDL *を検索
 * @param	fos		MMDLSYS *
 * @param	mv_code		検索する動作コード
 * @retval	MMDL *	NULL=存在しない
 */
//--------------------------------------------------------------
MMDL * MMDLSYS_SearchMoveCode( const MMDLSYS *fos, u16 mv_code )
{
	u32 no = 0;
	MMDL *fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&no) == TRUE ){
		if( MMDL_GetMoveCode(fmmdl) == mv_code ){
			return( fmmdl );
		}
	}
	
	return( NULL );
}

//--------------------------------------------------------------
/**
 * MMDLSYS OBJ IDに一致するMMDL *を検索
 * @param	fos		MMDLSYS *
 * @param	id		検索するOBJ ID
 * @retval	MMDL *	NULL=存在しない
 */
//--------------------------------------------------------------
MMDL * MMDLSYS_SearchOBJID( const MMDLSYS *fos, u16 id )
{
	u32 no = 0;
	MMDL *fmmdl;

	while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&no) == TRUE ){
		if( MMDL_CheckStatusBitAlies(fmmdl) == FALSE ){
			if( MMDL_GetOBJID(fmmdl) == id ){
				return( fmmdl );
			}
		}
	}
	
	return( NULL );
}

//--------------------------------------------------------------
/**
 * MMDLSYS フィールド動作モデルの空きを探す
 * @param	sys			MMDLSYS *
 * @retval	MMDL	空きのMMDL*　空きが無い場合はNULL
 */
//--------------------------------------------------------------
static MMDL * MMdlSys_SearchSpaceMMdl( const MMDLSYS *sys )
{
	int i,max;
	MMDL *fmmdl;
	
	i = 0;
	max = MMDLSYS_GetMMdlMax( sys );
	fmmdl = ((MMDLSYS*)sys)->pMMdlBuf;
	
	do{
		if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_USE) == 0 ){
			return( fmmdl );
		}
		
		fmmdl++;
		i++;
	}while( i < max );
	
	return( NULL );
}

//--------------------------------------------------------------
/**
 * MMDLSYS フィールド動作モデル　エイリアスを探す
 * @param	fos			MMDLSYS *
 * @param	obj_id		一致するOBJ ID
 * @param	zone_id		一致するZONE ID
 * @retval	MMDL	一致するMMDL*　一致無し=NULL
 */
//--------------------------------------------------------------
static MMDL * MMdlSys_SearchAlies(
	const MMDLSYS *fos, int obj_id, int zone_id )
{
	u32 no = 0;
	MMDL * fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&no) ){
		if( MMDL_CheckStatusBitAlies(fmmdl) == TRUE ){
			if( MMDL_GetOBJID(fmmdl) == obj_id ){
				if( MMDL_GetZoneIDAlies(fmmdl) == zone_id ){
					return( fmmdl );
				}
			}
		}
	}
	
	return( NULL );
}

//--------------------------------------------------------------
/**
 * MMDLSYS フィールド動作モデル ゾーン更新時の動作モデル削除
 * @param	fos	MMDLSYS
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDLSYS_DeleteZoneUpdateMMdl( MMDLSYS *fos )
{
	u32 no = 0;
	MMDL *fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&no) ){
		//本来であれば更にエイリアスチェックが入る
		if( MMDL_CheckStatusBit(
				fmmdl,MMDL_STABIT_ZONE_DEL_NOT) == 0 ){
			if( MMDL_GetOBJID(fmmdl) == 0xff ){
				GF_ASSERT( 0 );
			}
			MMDL_Delete( fmmdl );
		}
	}
}

//======================================================================
//	MMDL ツール
//======================================================================
//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル　TCB動作関数追加
 * @param	fmmdl	MMDL*
 * @param	sys		MMDLSYS*
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_AddTCB( MMDL *fmmdl, const MMDLSYS *sys )
{
	int pri,code;
	GFL_TCB * tcb;
	
	pri = MMDLSYS_GetTCBPriority( sys );
	code = MMDL_GetMoveCode( fmmdl );
	
	if( code == MV_PAIR || code == MV_TR_PAIR ){
		pri += MMDL_TCBPRI_OFFS_AFTER;
	}
	
	tcb = GFL_TCB_AddTask( MMDLSYS_GetTCBSYS((MMDLSYS*)sys),
			MMdl_TCB_MoveProc, fmmdl, pri );
	GF_ASSERT( tcb != NULL );
	
	fmmdl->pTCB = tcb;
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル　TCB動作関数削除
 * @param	fmmdl	MMDL*
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_DeleteTCB( MMDL *fmmdl )
{
	GF_ASSERT( fmmdl->pTCB );
	GFL_TCB_DeleteTask( fmmdl->pTCB );
	fmmdl->pTCB = NULL;
}

//--------------------------------------------------------------
/**
 * MMDL 現在発生しているフィールド動作モデルのOBJコードを参照
 * @param	fmmdl	MMDL * 
 * @param	code	チェックするコード。HERO等
 * @retval	BOOL	TRUE=fmmdl以外にもcodeを持っている奴がいる
 */
//--------------------------------------------------------------
BOOL MMDL_SearchUseOBJCode( const MMDL *fmmdl, u16 code )
{
	u32 no = 0;
	u16 check_code;
	MMDL *cmmdl;
	const MMDLSYS *fos = MMDL_GetMMdlSys( fmmdl );
	
	while( MMDLSYS_SearchUseMMdl(fos,&cmmdl,&no) == TRUE ){
		if( cmmdl != fmmdl ){
			check_code = MMDL_GetOBJCode( cmmdl );
			if( check_code != OBJCODEMAX && check_code == code ){
				return( TRUE );
			}
		}
	}
	
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * MMDL 座標、方向を初期化。
 * @param	fmmdl	MMDL *
 * @param	vec		初期化座標
 * @param	dir		方向 DIR_UP等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_InitPosition( MMDL * fmmdl, const VecFx32 *vec, u16 dir )
{
	int grid = SIZE_GRID_FX32( vec->x );
	MMDL_SetGridPosX( fmmdl, grid );
	
	grid = SIZE_GRID_FX32( vec->y );
	MMDL_SetGridPosY( fmmdl, grid );
	
	grid = SIZE_GRID_FX32( vec->z );
	MMDL_SetGridPosZ( fmmdl, grid );
	
	MMDL_SetVectorPos( fmmdl, vec );
	MMDL_UpdateGridPosCurrent( fmmdl );
	
	MMDL_SetForceDirDisp( fmmdl, dir );
	
	MMDL_FreeAcmd( fmmdl );
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_MOVE_START );
	MMDL_OffStatusBit( fmmdl, MMDL_STABIT_MOVE|MMDL_STABIT_MOVE_END );
}

//--------------------------------------------------------------
/**
 * MMDL 動作コード変更
 * @param	fmmdl	MMDL *
 * @param	code	MV_RND等
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_ChangeMoveCode( MMDL *fmmdl, u16 code )
{
	MMDL_CallMoveDeleteProc( fmmdl );
	MMDL_SetMoveCode( fmmdl, code );
	MMdl_InitCallMoveProcWork( fmmdl );
	MMDL_InitMoveProc( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL 描画初期化に行う処理纏め
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_InitDrawWork( MMDL *fmmdl )
{
	const MMDLSYS *fos = MMDL_GetMMdlSys( fmmdl );
	
	if( MMDLSYS_CheckCompleteDrawInit(fos) == FALSE ){
		return; //描画システム初期化完了していない
	}
	
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_HEIGHT_GET_ERROR) ){
		MMDL_UpdateCurrentHeight( fmmdl );
	}
	
	MMDL_SetDrawStatus( fmmdl, 0 );
	#ifndef MMDL_PL_NULL
	MMDL_BlActAddPracFlagSet( fmmdl, FALSE );
	#endif
	
	if( MMDL_CheckStatusBitCompletedDrawInit(fmmdl) == FALSE ){
		MMdl_InitCallDrawProcWork( fmmdl );
		MMDL_CallDrawInitProc( fmmdl );
		MMDL_OnStatusBitCompletedDrawInit( fmmdl );
	}
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル 描画関数初期化
 * @param	fmmdl		MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_InitCallDrawProcWork( MMDL * fmmdl )
{
	const MMDL_DRAW_PROC_LIST *list;
	u16 code = MMDL_GetOBJCode( fmmdl );
	const OBJCODE_PARAM *prm = MMDL_GetOBJCodeParam( fmmdl, code );
	list = DrawProcList_GetList( prm->draw_proc_no );
	fmmdl->draw_proc_list = list;
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル関連エフェクトのフラグ初期化。
 * エフェクト関連のフラグ初期化をまとめる。
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_InitDrawEffectFlag( MMDL * fmmdl )
{
	MMDL_OffStatusBit( fmmdl,
		MMDL_STABIT_SHADOW_SET		|
		MMDL_STABIT_SHADOW_VANISH	|
		MMDL_STABIT_EFFSET_SHOAL		|
		MMDL_STABIT_REFLECT_SET );
}

//--------------------------------------------------------------
/**
 * MMDL OBJ IDを変更
 * @param	fmmdl	MMDL *
 * @param	id		OBJ ID
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_ChangeOBJID( MMDL * fmmdl, u16 id )
{
	MMDL_SetOBJID( fmmdl, id );
	MMDL_OnStatusBitMoveStart( fmmdl );
	MMdl_InitDrawEffectFlag( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL ワーク消去
 * @param	fmmdl	MMDL
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_ClearWork( MMDL *fmmdl )
{
	GFL_STD_MemClear( fmmdl, MMDL_SIZE );
}

//--------------------------------------------------------------
/**
 * MMDL 指定されたフィールド動作モデルがエイリアス指定かどうかチェック
 * @param	fmmdl		MMDL *
 * @param	h_zone_id	headを読み込むゾーンID
 * @param	max			head要素数
 * @param	head		MMDL_H
 * @retval	int			RET_ALIES_NOT等
 */
//--------------------------------------------------------------
static int MMdl_CheckHeaderAlies(
		const MMDL *fmmdl, int h_zone_id, int max,
		const MMDL_HEADER *head )
{
	u16 obj_id;
	int zone_id;
	
	while( max ){
		obj_id = head->id;
		
		if( MMDL_GetOBJID(fmmdl) == obj_id ){
			//エイリアスヘッダー
			if( MMdlHeader_CheckAlies(head) == TRUE ){
				//エイリアスの正規ゾーンID
				zone_id = MMdlHeader_GetAliesZoneID( head );
				//対象エイリアス
				if( MMDL_CheckStatusBitAlies(fmmdl) == TRUE ){
					if( MMDL_GetZoneIDAlies(fmmdl) == zone_id ){
						return( RET_ALIES_EXIST );	//Aliesとして既に存在
					}
				}else if( MMDL_GetZoneID(fmmdl) == zone_id ){
					return( RET_ALIES_CHANGE );		//Alies対象である
				}
			}else{ //通常ヘッダー
				if( MMDL_CheckStatusBitAlies(fmmdl) == TRUE ){
					//生存エイリアスと一致
					if( MMDL_GetZoneIDAlies(fmmdl) == h_zone_id ){
						return( RET_ALIES_CHANGE );
					}
				}
			}
		}
		
		max--;
		head++;
	}
	
	return( RET_ALIES_NOT );
}

//--------------------------------------------------------------
/**
 * MMDL 指定されたゾーンIDとOBJ IDを持つMMDL *を取得。
 * @param	fos		MMDLSYS *
 * @param	obj_id	OBJ ID
 * @param	zone_id	ゾーンID
 * @retval	MMDL * MMDL *
 */
//--------------------------------------------------------------
static MMDL * MMdl_SearchOBJIDZoneID(
		const MMDLSYS *fos, int obj_id, int zone_id )
{
	u32 no = 0;
	MMDL *fmmdl;
	
	while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&no) == TRUE ){
		if( MMDL_GetOBJID(fmmdl) == obj_id &&
			MMDL_GetZoneID(fmmdl) == zone_id ){
			return( fmmdl );
		}
	}
	
	return( NULL );
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル描画初期化に行う処理
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_InitDrawStatus( MMDL * fmmdl )
{
	MMDL_OnStatusBit( fmmdl, MMDL_STABIT_MOVE_START );
	MMdl_InitDrawEffectFlag( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル描画削除時に行う処理
 * @param	fmmdl	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_SetDrawDeleteStatus( MMDL * fmmdl )
{
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル　エイリアスから正規OBJへの変更
 * @param	fmmdl		MMDL * 
 * @param	head		対象のMMDL_H
 * @param	zone_id		正規のゾーンID
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_ChangeAliesOBJ(
	MMDL *fmmdl, const MMDL_HEADER *head, int zone_id )
{
	GF_ASSERT( MMDL_CheckStatusBitAlies(fmmdl) == TRUE );
	MMDL_SetStatusBitAlies( fmmdl, FALSE );
	MMDL_SetZoneID( fmmdl, zone_id );
	MMDL_SetEventID( fmmdl, head->event_id );
	MMDL_SetEventFlag( fmmdl, head->event_flag );
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデル　正規OBJからエイリアスへの変更
 * @param	fmmdl		MMDL * 
 * @param	head		対象のMMDL_H
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdl_ChangeOBJAlies(
	MMDL * fmmdl, int zone_id, const MMDL_HEADER *head )
{
	GF_ASSERT( MMdlHeader_CheckAlies(head) == TRUE );
	MMDL_SetStatusBitAlies( fmmdl, TRUE );
	MMDL_SetEventID( fmmdl, head->event_id );
	MMDL_SetEventFlag( fmmdl, MMdlHeader_GetAliesZoneID(head) );
	MMDL_SetZoneID( fmmdl, zone_id );
}

//--------------------------------------------------------------
/**
 * MMDL フィールド動作モデルの同一チェック。
 * 死亡、入れ替わりが発生しているかチェックする。
 * @param	fmmdl	MMDL *
 * @param	obj_id	同一とみなすOBJ ID
 * @param	zone_id	同一とみなすZONE ID
 * @retval	int		TRUE=同一。FALSE=同一ではない
 */
//--------------------------------------------------------------
BOOL MMDL_CheckSameID( const MMDL * fmmdl, u16 obj_id, u16 zone_id )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_USE) == 0 ){
		return( FALSE );
	}
	
	if( MMDL_GetOBJID(fmmdl) != obj_id ){
		return( FALSE );
	}
	
	if( MMDL_GetZoneID(fmmdl) != zone_id ){
		if( MMDL_CheckStatusBitAlies(fmmdl) == FALSE ){
			return( FALSE );
		}
		
		if( MMDL_GetZoneIDAlies(fmmdl) != zone_id ){
			return( FALSE );
		}
	}
	
	return( TRUE );
}

//--------------------------------------------------------------
/**
 * フィールド動作モデルの同一チェック。OBJコード含み
 * 死亡、入れ替わりが発生しているかチェックする。
 * @param	fmmdl	MMDL *
 * @param	code	同一とみなすOBJコード
 * @param	obj_id	同一とみなすOBJ ID
 * @param	zone_id	同一とみなすZONE ID
 * @retval	int		TRUE=同一。FALSE=同一ではない
 */
//--------------------------------------------------------------
BOOL MMDL_CheckSameIDCode(
		const MMDL * fmmdl, u16 code, u16 obj_id, u16 zone_id )
{
	if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_USE) ){
		return( FALSE );
	}
	
	{
		u16 ret = MMDL_GetOBJCode( fmmdl );
		if( ret != code ){
			return( FALSE );
		}
	}
	
	return( MMDL_CheckSameID(fmmdl,obj_id,zone_id) );
}

//======================================================================
//	OBJCODE_PARAM
//======================================================================
//--------------------------------------------------------------
/**
 * MMDLSYS OBJCODE_PARAM 初期化
 * @param	fmmdlsys	MMDLSYS
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdlSys_InitOBJCodeParam( MMDLSYS *fmmdlsys )
{
	u8 *p = GFL_ARC_LoadDataAlloc( ARCID_MMDL_PARAM, 
			NARC_fldmmdl_mdlparam_fldmmdl_mdlparam_bin,
			fmmdlsys->heapID );
	fmmdlsys->pOBJCodeParamBuf = p;
	fmmdlsys->pOBJCodeParamTbl = (const OBJCODE_PARAM*)(&p[OBJCODE_PARAM_TOTAL_NUMBER_SIZE]);
}

//--------------------------------------------------------------
/**
 * MMDLSYS OBJCODE_PARAM 削除
 * @param	fmmdlsys	MMDLSYS
 * @retval	nothing
 */
//--------------------------------------------------------------
static void MMdlSys_DeleteOBJCodeParam( MMDLSYS *fmmdlsys )
{
	GFL_HEAP_FreeMemory( fmmdlsys->pOBJCodeParamBuf );
	fmmdlsys->pOBJCodeParamBuf = NULL;
}

//--------------------------------------------------------------
/**
 * MMDLSYS OBJCODE_PARAM 取得
 * @param	fmmdlsys	MMDLSYS *
 * @param	code	取得するOBJコード
 * @retval	OBJCODE_PARAM*
 */
//--------------------------------------------------------------
const OBJCODE_PARAM * MMDLSYS_GetOBJCodeParam(
		const MMDLSYS *fmmdlsys, u16 code )
{
	GF_ASSERT( code < OBJCODEMAX );
  GF_ASSERT( fmmdlsys->pOBJCodeParamTbl != NULL );
	return( &(fmmdlsys->pOBJCodeParamTbl[code]) );
}

//--------------------------------------------------------------
/**
 * MMDL OBJCODE_PARAM 取得
 * @param	fmmdl	MMDL*
 * @param	code	取得するOBJコード
 * @retval	OBJCODE_PARAM*
 */
//--------------------------------------------------------------
const OBJCODE_PARAM * MMDL_GetOBJCodeParam(
		const MMDL *fmmdl, u16 code )
{
	const MMDLSYS *fmmdlsys = MMDL_GetMMdlSys( fmmdl );
	return( MMDLSYS_GetOBJCodeParam(fmmdlsys,code) );
}

//======================================================================
//	parts
//======================================================================
//--------------------------------------------------------------
/**
 * 指定されたOBJコードがワーク参照型ならばワーク内OBJコードに変更。
 * 違う場合はそのままで返す。
 * @param	fsys	FIELDSYS_WORK *
 * @param	code	OBJコード。HERO等
 * @retval	int		チェックされたOBJコード
 */
//--------------------------------------------------------------
static u16 WorkOBJCode_GetOBJCode( void *fsys, int code )
{
	#ifndef MMDL_PL_NULL
	if( code >= WKOBJCODE_ORG && code <= WKOBJCODE_END ){
		code -= WKOBJCODE_ORG;
		code = GetEvDefineObjCode( fsys, code );
	}
	#else
//	GF_ASSERT( 0 );
	#endif
	
	return( code );
}

//--------------------------------------------------------------
/**
 * 指定された動作コードの関数リストを取得
 * @param	code	動作コード
 * @retval MMDL_MOVE_PROC_LIST
 */
//--------------------------------------------------------------
static const MMDL_MOVE_PROC_LIST * MoveProcList_GetList( u16 code )
{
	GF_ASSERT( code < MV_CODE_MAX );
	return( DATA_FieldOBJMoveProcListTbl[code] );
}

//--------------------------------------------------------------
/**
 * 指定されたOBJコードの描画関数リストを取得
 * @param	code	OBJコード
 * @retval	MMDL_DRAW_PROC_LIST*
 */
//--------------------------------------------------------------
static const MMDL_DRAW_PROC_LIST * DrawProcList_GetList(
		MMDL_DRAWPROCNO no )
{
	GF_ASSERT( no < MMDL_DRAWPROCNO_MAX );
	return( DATA_MMDL_DRAW_PROC_LIST_Tbl[no] );
}

//--------------------------------------------------------------
/**
 * MMDL_HEADER エイリアスチェック
 * @param	head	FIELD_OBJ_H
 * @retval	int		TRUE=エイリアス　FALSE=違う
 */
//--------------------------------------------------------------
static BOOL MMdlHeader_CheckAlies( const MMDL_HEADER *head )
{
	u16 id = head->event_id;
	if( id == SP_SCRID_ALIES ){ return( TRUE ); }
	return( FALSE );
}

//--------------------------------------------------------------
/**
 * フィールドOBJヘッダー　エイリアス時のゾーンID取得。
 * エイリアス時はイベントフラグがゾーンIDになる
 * @param	head	FIELD_OBJ_H
 * @retval	int		ゾーンID
 */
//--------------------------------------------------------------
static int MMdlHeader_GetAliesZoneID( const MMDL_HEADER *head )
{
	GF_ASSERT( MMdlHeader_CheckAlies(head) == TRUE );
	return( (int)head->event_flag );
}

//======================================================================
//	動作関数ダミー
//======================================================================
//--------------------------------------------------------------
/**
 * 動作初期化関数ダミー
 * @param	MMDL	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_MoveInitProcDummy( MMDL * fmmdl )
{
}

//--------------------------------------------------------------
/**
 * 動作関数ダミー
 * @param	MMDL	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_MoveProcDummy( MMDL * fmmdl )
{
}

//--------------------------------------------------------------
/**
 * 動作削除関数ダミー
 * @param	MMDL	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_MoveDeleteProcDummy( MMDL * fmmdl )
{
}

//--------------------------------------------------------------
/**
 * 動作復帰関数ダミー
 * @param	MMDL *	MMDL *
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_MoveReturnProcDummy( MMDL * fmmdl )
{
}

//======================================================================
//	描画関数ダミー
//======================================================================
//--------------------------------------------------------------
/**
 * 描画初期化関数ダミー
 * @param	MMDL	MMDL * 
 * @retval	int			TRUE=初期化成功
 */
//--------------------------------------------------------------
void MMDL_DrawInitProcDummy( MMDL * fmmdl )
{
}

//--------------------------------------------------------------
/**
 * 描画関数ダミー
 * @param	MMDL	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_DrawProcDummy( MMDL * fmmdl )
{
}

//--------------------------------------------------------------
/**
 * 描画削除関数ダミー
 * @param	MMDL	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_DrawDeleteProcDummy( MMDL * fmmdl )
{
}

//--------------------------------------------------------------
/**
 * 描画退避関数ダミー
 * @param	MMDL	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_DrawPushProcDummy( MMDL * fmmdl )
{
}

//--------------------------------------------------------------
/**
 * 描画復帰関数ダミー
 * @param	MMDL	MMDL * 
 * @retval	nothing
 */
//--------------------------------------------------------------
void MMDL_DrawPopProcDummy( MMDL * fmmdl )
{
}

//======================================================================
//	debug
//======================================================================
#ifdef DEBUG_MMDL
//--------------------------------------------------------------
/**
 * デバッグ　動作モデル　OBJコード文字列を取得(ASCII)
 * @param	code OBJコード
 * @param	heapID buf領域確保用HEAPID
 * @retval	u8* 文字列が格納されたu8*。使用後GFL_HEAP_FreeMemory()が必要。
 * 文字列長はDEBUG_OBJCODE_STR_LENGTH。
 */
//--------------------------------------------------------------
u8 * DEBUG_MMDL_GetOBJCodeString( u16 code, HEAPID heapID )
{
	u8 *buf;
	GF_ASSERT( code < OBJCODEMAX );
	buf = GFL_HEAP_AllocClearMemoryLo(
			heapID, DEBUG_OBJCODE_STR_LENGTH );
	GFL_ARC_LoadDataOfs( buf, ARCID_MMDL_PARAM,
			NARC_fldmmdl_mdlparam_fldmmdl_objcodestr_bin,
			DEBUG_OBJCODE_STR_LENGTH * code, DEBUG_OBJCODE_STR_LENGTH );
	return( buf );
}
#endif //DEBUG_MMDL

//--------------------------------------------------------------
/**
 * OBJコードを変更する
 * @param
 * @retval
 */
//--------------------------------------------------------------
void MMDL_ChangeOBJCode( MMDL *fmmdl, u16 code )
{
	const MMDLSYS *fos;
	fos = MMDL_GetMMdlSys( fmmdl );
  
	if( MMDLSYS_CheckCompleteDrawInit(fos) == TRUE ){
    if( MMDL_CheckStatusBitCompletedDrawInit(fmmdl) == TRUE ){
		  MMDL_CallDrawDeleteProc( fmmdl );
    }
  }
  
  MMDL_SetOBJCode( fmmdl, code );
  MMDL_OffStatusBitCompletedDrawInit( fmmdl );
  MMdl_InitDrawStatus( fmmdl );
  MMdl_InitDrawWork( fmmdl );
}

//======================================================================
//
//======================================================================
#if 0
//--------------------------------------------------------------
/**
 * MMDL_BUFFER フィールド動作モデルバッファからロード
 * @param
 * @retval
 */
//--------------------------------------------------------------
MMDL * MMDL_BUFFER_LoadMMdl(
	MMDL_BUFFER *buf, MMDLSYS *fos, int no )
{
	MMDL *fmmdl;
	
	fmmdl = MMdlSys_SearchSpaceMMdl( fos );
	GF_ASSERT( fmmdl != NULL );
	
	OS_Printf( "MMDL LoadNo %d\n", no );
	
	*fmmdl = buf->fldMMdlBuf[no];
	
	MMdl_InitWork( fmmdl, fos );
	
	if( MMDL_CheckMoveBit(fmmdl,MMDL_MOVEBIT_MOVEPROC_INIT) == 0 ){
		MMdl_InitMoveWork( fmmdl );
	}else{
		MMdl_InitCallMoveProcWork( fmmdl );
	}
	
	MMDL_OffStatusBitCompletedDrawInit( fmmdl );
	MMdl_InitDrawWork( fmmdl );
	
	MMdlSys_AddMMdlTCB( fos, fmmdl );
	MMdlSys_IncrementOBJCount( (MMDLSYS*)MMDL_GetMMdlSys(fmmdl) );
	
	return( fmmdl );
}

//--------------------------------------------------------------
/**
 * MMDL_BUFFER フィールド動作モデルバッファからロード
 * @param
 * @retval
 */
//--------------------------------------------------------------
void MMDL_BUFFER_LoadBuffer( MMDL_BUFFER *buf, MMDLSYS *fos )
{
	int i;
	MMDL *fmmdl;

	for( i = 0; i < MMDL_BUFFER_MAX; i++ ){
		fmmdl = &buf->fldMMdlBuf[i];
		if( MMDL_CheckStatusBit(fmmdl,MMDL_STABIT_USE) ){
			MMDL_BUFFER_LoadMMdl( buf, fos, i );
		}
	}
}

//--------------------------------------------------------------
/**
 * MMDL_BUFFER フィールド動作モデルバッファへセーブ
 * @param
 * @retval
 */
//--------------------------------------------------------------
void MMDL_BUFFER_SaveBuffer( MMDL_BUFFER *buf, MMDLSYS *fos )
{
	MMDL *fmmdl;
	u32 i = 0, no = 0;
	
	MMDL_BUFFER_InitBuffer( buf );
	while( MMDLSYS_SearchUseMMdl(fos,&fmmdl,&i) == TRUE ){
		OS_Printf( "MMDL BUFFER WorkNo %d, BufferNo %d Save\n", i-1, no );
		buf->fldMMdlBuf[no] = *fmmdl;
		no++;
	}
}
#endif
