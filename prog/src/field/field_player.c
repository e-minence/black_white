//======================================================================
/**
 * @file	field_player.c
 * @date	2008.9.29
 * @brief	フィールドプレイヤー制御
 */
//======================================================================
#include <gflib.h>

#include "fieldmap.h"
#include "field_g3d_mapper.h"
#include "fldmmdl.h"
#include "field_player.h"

//======================================================================
//	define
//======================================================================

//======================================================================
//	struct
//======================================================================
//--------------------------------------------------------------
///	FIELD_PLAYER
//--------------------------------------------------------------
struct _FIELD_PLAYER
{
	HEAPID heapID;
	FIELDMAP_WORK *fieldWork;
	
	u16 dir;
	u16 padding0;
	VecFx32 pos;
	
	FLDMMDL *fldmmdl;
	FLDMAPPER_GRIDINFODATA gridInfoData;
	
	//消します
	GFL_BBDACT_RESUNIT_ID	bbdActResUnitID;
	GFL_BBDACT_ACTUNIT_ID	bbdActActUnitID;
};

//======================================================================
//	proto
//======================================================================
static const FLDMMDL_HEADER playerdata_FldMMdlHeader;

//======================================================================
//	フィールドプレイヤー
//======================================================================
//--------------------------------------------------------------
/**
 * フィールドプレイヤー　作成
 * @param FIELDMAP_WORK *fieldWork
 * @param pos 初期座標
 * @param heapID HEAPID
 * @retval FIELD_PLAYER*
 */
//--------------------------------------------------------------
FIELD_PLAYER * FIELD_PLAYER_Create(
		FIELDMAP_WORK *fieldWork, const VecFx32 *pos, HEAPID heapID )
{
	FLDMMDLSYS *fmmdlsys;
	FIELD_PLAYER *fld_player;
	
	fld_player = GFL_HEAP_AllocClearMemory( heapID, sizeof(FIELD_PLAYER) );
	fld_player->fieldWork = fieldWork;
	fld_player->pos = *pos;

	FLDMAPPER_GRIDINFODATA_Init( &fld_player->gridInfoData );
	
	//FLDMMDLセットアップ
	fmmdlsys = FIELDMAP_GetFldMMdlSys( fieldWork );
	
	fld_player->fldmmdl =
		FLDMMDLSYS_SearchOBJID( fmmdlsys, FLDMMDL_ID_PLAYER );

	if( fld_player->fldmmdl == NULL )	//新規
	{
		FLDMMDL_HEADER head;
		head = playerdata_FldMMdlHeader;
		head.gx = SIZE_GRID_FX32( pos->x );
		head.gz = SIZE_GRID_FX32( pos->z );
		head.y = pos->y;
		fld_player->fldmmdl = FLDMMDLSYS_AddFldMMdl( fmmdlsys, &head, 0 );
	}
	else //復帰
	{
		int gx = SIZE_GRID_FX32( pos->x );
		int gy = SIZE_GRID_FX32( pos->y );
		int gz = SIZE_GRID_FX32( pos->z );
		FLDMMDL *fmmdl = fld_player->fldmmdl;
		
		FLDMMDL_SetGridPosX( fmmdl, gx );
		FLDMMDL_SetGridPosY( fmmdl, gy );
		FLDMMDL_SetGridPosZ( fmmdl, gz );
		FLDMMDL_SetVectorPos( fmmdl, pos );
	}
	
	FLDMMDL_SetStatusBitNotZoneDelete( fld_player->fldmmdl, TRUE );
	return( fld_player );
}

//--------------------------------------------------------------
/**
 * フィールドプレイヤー　削除
 * @param fld_player FIELD_PLAYER
 * @retval nothing
 */
//--------------------------------------------------------------
void FIELD_PLAYER_Delete( FIELD_PLAYER *fld_player )
{
	//動作モデルの削除はフィールドメイン側で
	GFL_HEAP_FreeMemory( fld_player );
}

//--------------------------------------------------------------
/**
 * フィールドプレイヤー　更新
 * @param fld_player FIELD_PLAYER
 * @param dir 方向
 * @param pos 座標
 * @retval nothing
 */
//--------------------------------------------------------------
void FIELD_PLAYER_Update( FIELD_PLAYER *fld_player )
{
}

//======================================================================
//	FILED_PLAYER　参照、設定
//======================================================================
//--------------------------------------------------------------
/**
 * FILED_PLAYER　座標取得
 * @param fld_player FIELD_PLAYER
 * @param pos 座標格納先
 * @retval nothing
 */
//--------------------------------------------------------------
void FIELD_PLAYER_GetPos( const FIELD_PLAYER *fld_player, VecFx32 *pos )
{
	*pos = fld_player->pos;
}

//--------------------------------------------------------------
/**
 * FILED_PLAYER　座標セット
 * @param fld_player FIELD_PLAYER
 * @param pos セットする座標
 * @retval nothing
 */
//--------------------------------------------------------------
void FIELD_PLAYER_SetPos( FIELD_PLAYER *fld_player, const VecFx32 *pos )
{
	int gx = SIZE_GRID_FX32( pos->x );
	int gy = SIZE_GRID_FX32( pos->y );
	int gz = SIZE_GRID_FX32( pos->z );
	FLDMMDL *fmmdl = fld_player->fldmmdl;
	
	FLDMMDL_SetOldGridPosX( fmmdl, FLDMMDL_GetGridPosX(fmmdl) );
	FLDMMDL_SetOldGridPosY( fmmdl, FLDMMDL_GetGridPosY(fmmdl) );
	FLDMMDL_SetOldGridPosZ( fmmdl, FLDMMDL_GetGridPosZ(fmmdl) );
	FLDMMDL_SetGridPosX( fmmdl, gx );
	FLDMMDL_SetGridPosY( fmmdl, gy );
	FLDMMDL_SetGridPosZ( fmmdl, gz );
	FLDMMDL_SetVectorPos( fmmdl, pos );
	
	fld_player->pos = *pos;
}

//--------------------------------------------------------------
/**
 * FILED_PLAYER　方向取得
 * @param fld_player FIELD_PLAYER
 * @retval u16 方向
 */
//--------------------------------------------------------------
u16 FIELD_PLAYER_GetDir( const FIELD_PLAYER *fld_player )
{
	return( fld_player->dir );
}

//--------------------------------------------------------------
/**
 * FILED_PLAYER　方向セット
 * @param fld_player FIELD_PLAYER
 * @param dir 方向
 * @retval nothing
 */
//--------------------------------------------------------------
void FIELD_PLAYER_SetDir( FIELD_PLAYER *fld_player, u16 dir )
{
	fld_player->dir = dir;
}

//--------------------------------------------------------------
/**
 * FILED_PLAYER　FIELDMAP_WORK取得
 * @param fld_player FIELD_PLAYER
 * @retval FIELDMAP_WORK*
 */
//--------------------------------------------------------------
FIELDMAP_WORK * FIELD_PLAYER_GetFieldMapWork( FIELD_PLAYER *fld_player )
{
	return( fld_player->fieldWork );
}

//--------------------------------------------------------------
/**
 * FILED_PLAYER　FLDMMDL取得
 * @param fld_player FIELD_PLAYER
 * @retval FLDMMDL*
 */
//--------------------------------------------------------------
FLDMMDL * FIELD_PLAYER_GetFldMMdl( FIELD_PLAYER *fld_player )
{
	return( fld_player->fldmmdl );
}

//--------------------------------------------------------------
/**
 * FIELD_PLAYER FLDMAPPER_GRIDINFODATA取得
 * @param fld_player* FIELD_PLAYER
 * @retval FLDMAPPER_GRIDINFODATA*
 */
//--------------------------------------------------------------
FLDMAPPER_GRIDINFODATA * FIELD_PLAYER_GetGridInfoData(
		FIELD_PLAYER *fld_player )
{
	return( &fld_player->gridInfoData );
}

//======================================================================
//	FILED_PLAYER　ツール
//======================================================================
//--------------------------------------------------------------
/**
 * 自機の前方位置をグリッド単位で取得
 * @param fld_player FIELD_PLAYER
 * @param gx X座標格納先
 * @param gy Y座標格納先
 * @param gz Z座標格納先
 * @retval nothing
 */
//--------------------------------------------------------------
void FIELD_PLAYER_GetFrontGridPos(
		FIELD_PLAYER *fld_player, int *gx, int *gy, int *gz )
{
	int dir;
	FLDMMDL *fmmdl = FIELD_PLAYER_GetFldMMdl( fld_player );
	
	*gx = FLDMMDL_GetGridPosX( fmmdl );
	*gy = FLDMMDL_GetGridPosY( fmmdl );
	*gz = FLDMMDL_GetGridPosZ( fmmdl );
	dir = FLDMMDL_GetDirDisp( fmmdl );
	
	*gx += FLDMMDL_TOOL_GetDirAddValueGridX( dir );
	*gz += FLDMMDL_TOOL_GetDirAddValueGridZ( dir );
}

//======================================================================
//	data
//======================================================================
//--------------------------------------------------------------
/// 自機動作モデルヘッダー
//--------------------------------------------------------------
static const FLDMMDL_HEADER playerdata_FldMMdlHeader =
{
	FLDMMDL_ID_PLAYER,	///<識別ID
	HERO,	///<表示するOBJコード
	MV_DMY,	///<動作コード
	0,	///<イベントタイプ
	0,	///<イベントフラグ
	0,	///<イベントID
	0,	///<指定方向
	0,	///<指定パラメタ 0
	0,	///<指定パラメタ 1
	0,	///<指定パラメタ 2
	MOVE_LIMIT_NOT,	///<X方向移動制限
	MOVE_LIMIT_NOT,	///<Z方向移動制限
	0,	///<グリッドX
	0,	///<グリッドZ
	0,	///<Y値 fx32型
};

//======================================================================
//	以下消します
//======================================================================
GFL_BBDACT_RESUNIT_ID GetPlayerBBdActResUnitID( FIELD_PLAYER *fld_player )
{
	return( fld_player->bbdActResUnitID );
}

#if 0
void PlayerActGrid_Update(
	FIELD_PLAYER *fld_player, u16 dir, const VecFx32 *pos )
{
	VecFx32 trans;
	fld_player->pos = *pos;
	
	SetGridPlayerActTrans( fld_player, pos );
	FLDMMDL_SetForceDirDisp( fld_player->fldmmdl, dir );
}
#endif

#if 0
void SetGridPlayerActTrans( FIELD_PLAYER* fld_player, const VecFx32* trans )
{
	int gx = SIZE_GRID_FX32( trans->x );
	int gy = SIZE_GRID_FX32( trans->y );
	int gz = SIZE_GRID_FX32( trans->z );
	
	FLDMMDL_SetOldGridPosX( fld_player->fldmmdl,
		FLDMMDL_GetGridPosX(fld_player->fldmmdl) );
	FLDMMDL_SetOldGridPosY( fld_player->fldmmdl,
		FLDMMDL_GetGridPosY(fld_player->fldmmdl) );
	FLDMMDL_SetOldGridPosZ( fld_player->fldmmdl,
		FLDMMDL_GetGridPosZ(fld_player->fldmmdl) );
	
	FLDMMDL_SetGridPosX( fld_player->fldmmdl, gx );
	FLDMMDL_SetGridPosY( fld_player->fldmmdl, gy );
	FLDMMDL_SetGridPosZ( fld_player->fldmmdl, gz );
	FLDMMDL_SetVectorPos( fld_player->fldmmdl, trans );
	
	VEC_Set( &fld_player->pos, trans->x, trans->y, trans->z );
}
#endif

#if 0
void PlayerActGrid_AnimeSet(
	FIELD_PLAYER *fld_player, int dir, PLAYER_ANIME_FLAG flag )
{
	switch( flag ){
	case PLAYER_ANIME_FLAG_STOP:
		FLDMMDL_SetDrawStatus( fld_player->fldmmdl, DRAW_STA_STOP );
		break;
	case PLAYER_ANIME_FLAG_WALK:
		FLDMMDL_SetDrawStatus( fld_player->fldmmdl, DRAW_STA_WALK_8F );
		break;
	default:
		FLDMMDL_SetDrawStatus( fld_player->fldmmdl, DRAW_STA_WALK_4F );
		break;
	}
}
#endif

#if 0
FLDMAPPER_GRIDINFODATA * PlayerActGrid_GridInfoGet( FIELD_PLAYER *fld_player )
{
	return( &fld_player->gridInfoData );
}
#endif

#if 0
void PlayerActGrid_ScaleSizeSet(
	FIELD_PLAYER *fld_player, fx16 sizeX, fx16 sizeY )
{
	GFL_BBDACT_SYS *bbdActSys = FIELDMAP_GetBbdActSys( fld_player->fieldWork );
	int idx = GFL_BBDACT_GetBBDActIdxResIdx(
			bbdActSys, fld_player->bbdActActUnitID );
	GFL_BBD_SetObjectSiz(
		GFL_BBDACT_GetBBDSystem(bbdActSys),
		idx, &sizeX, &sizeY );
}
#endif

#if 0
void PLAYER_GRID_GetFrontGridPos(
	FIELD_PLAYER *fld_player, int *gx, int *gy, int *gz )
{
	int dir;
	FLDMMDL *fmmdl = FIELD_PLAYER_GetFldMMdl( fld_player );
	
	*gx = FLDMMDL_GetGridPosX( fmmdl );
	*gy = FLDMMDL_GetGridPosY( fmmdl );
	*gz = FLDMMDL_GetGridPosZ( fmmdl );
	dir = FLDMMDL_GetDirDisp( fmmdl );
	
	*gx += FLDMMDL_TOOL_GetDirAddValueGridX( dir );
	*gz += FLDMMDL_TOOL_GetDirAddValueGridZ( dir );
}
#endif
