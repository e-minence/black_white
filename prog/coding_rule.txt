====================================================================
====================================================================
====================================================================
  ポケットモンスターWBプログラムソースコーディング規約

	2009.04.15	GAMEFREAK Inc.


	※まだ承認されていません。レビューをお願いします。

====================================================================
====================================================================
====================================================================


--------------------------------------------------------------------
			ファイル名
--------------------------------------------------------------------
・アルファベット小文字+_＋数字で名前を付ける。記号の使用は禁止する。
　
・拡張子は.h.c.s.cdatに統一する。
　define定義は出来るだけ.hに入れること(ctagsの検索対象にするため)

・.hには実データを入れてはいけない。

・.cdatファイルは実データのみでコードを入れてはいけない。
　ソースと別ディレクトリに配置する。

--------------------------------------------------------------------
			ファイル構成
--------------------------------------------------------------------
基本的に以下の構成に倣うこと

☆dotCファイル構成

ソース内での定義順は以下の順番で記述するようにする
①doxygen用ヘッダー定義
②必要なインクルードファイル
③define 定義とenum
④構造体定義
⑤static 関数前方宣言
⑥変数定義
⑦外部公開関数群
⑧static関数群

Cファイル内の関数群は、外部公開関数をまずまとめて書き、
その後ろにstatic 関数群を書くようにする。
そのファイル内のstatic関数は必ず前方宣言する。


モジュールの外部公開関数を明確にするため、
doxygen用ヘッダー定義にモジュール名を書くようにする
/**
 *	@file	pgear_act.c
 *	@brief	ポケギア　アクター制御
 *	@author	Miyuki Iwasawa
 *	@date	07.06.28
 *	
 *	モジュール名：PGEAR
 */

そのファイルが内部に複数のモジュールを含んだ構成となっている場合、
③～⑧に関してはモジュールごとのブロックで繰り返してもかまわない。
つまり、
①doxygen用ヘッダー定義
②必要なインクルードファイル

＜以下はモジュールA用の記述＞
③define 定義とenum
④構造体定義
⑤static 関数前方宣言
⑥変数定義
⑦外部公開関数群
⑧static関数群

＜以下はモジュールB用の記述＞
③define 定義とenum
④構造体定義
⑤static 関数前方宣言
⑥変数定義
⑦外部公開関数群
⑧static関数群

…という構成でもよい。
※基本的にはソース分割するべきだが、情報公開の範囲などを考慮して判断する。


☆dotHファイル構成

①ヘッダ
	/**
		@file
		@brief
	*/

②2重インクルード防止定義
	#pragma once

③関数extern宣言
④必要なインクルードファイル
⑤define定義とenum
⑥構造体定義


☆dotCDATファイル構成

①doxygen用ヘッダー定義
②define 定義とenum
③構造体定義
④変数定義

※②,③についてはcdatファイル内だけで参照する場合、内部で定義してもよい。

--------------------------------------------------------------------
			命名規則
--------------------------------------------------------------------
☆ソース内の名前の長さについて
　制限はないが、見易さ、理解しやすさとレイアウトの横幅100の制限を考慮する。

☆モジュール名
　すべての外部公開される名前は、プレフィックスとしてモジュール名を持つ。
　モジュール名はすべて大文字で構成する。

　複雑な構成のモジュールに関してはモジュール名＋＿＋サブモジュール名＋…というように構成する。
　（例）BTL_SERVER_Createは、メインモジュール名「BTL」＋＿＋サブモジュール名「SERVER」…
　※サブモジュール名が多段になってもかまわない。

☆外部公開関数名
　モジュール名＋＿＋動詞（＋目的語etc.）で定義する。
　（例）u32 POKEICON_GetCgxArcIndex( const POKEMON_PASO_PARAM* ppp )
		上記例は、モジュール名「POKEICON」＋＿＋動詞「Get」＋目的語「CgxArcIndex」で構成されている。

　モジュール名以降、動詞の部分からはキャピタライズする。アルファベット以外に数字の使用も可能とする。
　※キャピタライズ＝最初の一文字は大文字で以後は小文字、単語の頭ごとに大文字。


☆ローカル関数名
　基本は自由。小文字始まり可。
　ただし、外部公開関数のプレフィックスとは区別が付くようにすること


	(ポケギアの・・・)
	PGear_Get～
	PGear_Set～

	(セルアクター系の・・・)
	CellAct_～

	/**
		@file	pmtel_book.c
		@brief	電話システム　電話帳データマネージャ
		
		グローバル
		PMTel_
	*/

	//これはグローバル
	void PMTel_AllocDataAll(){
		・・・
	}

	//こっちはローカル
	static void pmtel_sub_clear(){

	}

	//同じくローカル。
	//大文字で始めていいけど、グローバル関数のプレフィックスとはかぶらないように
	static void PMTelSub_()

	（例）
	static u16 GetNowWetherStatus(void);
	static u16 pgframe_CursorMvRelease(PGEAR_SYS_WORK* wk);


☆変数名について

・オート変数命名規則
　関数内で定義される変数については、小文字＋アンダーバー＋数字で命名する。
　（例）u8 count_item_max;

・関数外定義変数の命名規則
　関数外で定義される変数については、大文字で始まり、以降 小文字+_ で命名する。
　単語ごとにキャピタライズし、数字の使用も可能とする。
　※スコープがstaticかどうかは区別せず、この命名規則としている。
　※グローバル変数については基本的に禁止だが、使用する場合は外部公開関数と同じく
　　モジュール名を先頭に入れる命名規則に従う。

　（例）u16 LasterBuffer[];
　		static u16 ZoneDataTable[];


☆マクロ定義、定数定義
・#defineで定義する定数の名前は、大文字と数字で定義する。
　単語の区切りは＿を使用する。
　（例）
　#define POKEICON_SIZE_X             (32)

・enumによる定義についても同上とする。

・マクロ定義も同上。
	（例）
	#define	NELEMS(array)	(sizeof(array)/sizeof((array)[0]))

　※必要ない限りマクロでなくinline関数の使用を推奨する。

・外部公開する場合、モジュール名を必ず先頭に保持すること。


☆構造体定義
・構造体はマクロと同じ命名規則でおこなう。
　つまり、大文字、アンダーバー、数字で命名する。
　typedef struct {（略）}POKEMON_PARAM;

・構造体メンバ名は、自由に命名してもよい。

・外部公開する場合、モジュール名を必ず先頭に保持すること。
　これはtyedefを使った不完全型でも同様。



--------------------------------------------------------------------
		レイアウト・記法
--------------------------------------------------------------------
・横幅は100文字で統一する。これ以上長くなる場合は行の途中で折り返すこと。

・インデント幅は2で統一する。

・インデントはタブでなく半角スペースで行う。

・条件文に続く中括弧の開始位置は、原則として次の行に配置する。
　（例）
	if (condition) 
	{
	}

	for (i=0; i<ITEM_MAX; i++)
	{
	}

　ただし、見易さに配慮した場合、条件文の後につけることもありえる。
　（{}にはさまれる行が２～３行程度で、一度に見えるソース範囲が広いほうがよい場合など）

・switch caseの頭はそろえる
　（例）
	switch (n) {
	case 0:
		func1();
		break;
	case 1:
		func2();
		break;
	default:
		func_other();
		break;
	}

・行が長くなる場合の折り返し位置の頭は自由に配置してよい。
　見易さに配慮する。
　（例）
	if ((condition == STAT_GREEN) ||	(condition == STAT_BLUE) ||
			(condition == STAT_YELLOW))
	{
		func_normal();
	}
	と
	if ((condition == STAT_GREEN) ||
		(condition == STAT_BLUE) ||
		(condition == STAT_YELLOW))
	{
		func_normal();
	}
	のどちらでもかまわない

・複数の条件判定を記述する場合、対応する()をきちんとつけて、
　処理や結合の優先順位を明示すること

	//こう書くより
	if( !flag && i < max){}

	//()をつけてわかりやすく
	if((!flag) && (i < max)){}


・制御文は一行でもかならず{}をつける。本文がなくてもつける。
　→ほかのひとが見落とす可能性があるため
　（例）
	if (flag)
		return;				//×だめ

	if (flag) {
		return;				//これはＯＫ
	}

	if (flag) { return; }	//○これでもよい

	（例）
	for (p = freep; p != NULL; p++) {}	//無理矢理本文をつける！


・マルチステートメントは原則禁止する。
　変数宣言は見易さを損なわない程度ならば、一行で複数宣言をしてもよい。
　（例）
	int i,j;
	
・値を定義する場合はかならず（）で囲む。
　（例）
	#define	POKEMON_TEMOTI_MAX	6		//×だめ
	#define	POKEMON_TEMOTI_MAX	(6)		//○これでよい


--------------------------------------------------------------------
		コメント
--------------------------------------------------------------------
・ドキュメント生成ツール（doxygen）を併用するので、そのルールに従う。

・関数の説明をおこなうコメントヘッダは.hではなく.cに追加する。

・ライブラリ関数などは.hにもコメントを書くことを推奨する。
　※ただしdoxygen形式のコメントは*.cに書くこと。

・コンバータなどから自動生成されるファイルの場合は、人間が書いたものと
　区別できるようにコメントを入れる。

・#if～#endif などの構文で、#elseや#endifが何と対になっているかコメントで明示する

	#ifdef PM_DEBUG
		・・・
	#else	//ifdef PM_DEBUG
		・・・
	#endif	//ifdef PM_DEBUG

・不要になった処理はコメントとして残しっぱなしにせずに積極的に消去する
　（たとえ消去しても、必要であればsubversionから履歴をたどり参照可能）


--------------------------------------------------------------------
		C言語仕様への制限
--------------------------------------------------------------------
・関数内ローカル変数は32バイト程度まで。それ以上はグローバルかメモリ確保して使用する。

・関数は縦80行程度におさめること。（むやみに長い関数は最適化が効かない）

・register宣言は使用しない（最適化の妨げになることが多いため）

・再起呼び出しは禁止（スタック消費が見積もれないため）

・無限ループ禁止。必ず脱出条件で抜けることを確認しておくこと。
　番兵で止めるだけではなく、ループ最大条件も見るようにすること。
　（バッファオーバーフローの予防。strcpyよりもstrncpyを使うべき、というのと同じ考え方）
	
・適用可能な箇所ではconstをつかう。キャストで解決しない。
　（例）
	下記のように宣言されている関数とロムデータがある場合、
	void sample_copy(u8 * from, u8 * to);
	const u8 sample_data[];

	sample_copy(sample_data,UserWork);
	→警告が出る。
	『passing arg 1 of 'sample_copy' from incompatible pointer type』
	sample_copy((u8 *)sample_data, UserWork)のようにしてごまかしがち

	void sample_copy(const u8 * from, u8 * to);
	とすれば警告は出なくなる。また、パラメータの入れ替えなどのケアレスミスを発見しやすい。

・条件文内での代入は避ける。
　（例）
	if ((ret = GetEnemyStatus()) == 0)
	{
	}
	↓
	ret = GetEnemyStatus();
	if (ret == 0)
	{
	}

・ローカル変数の使い回しはなるべく避ける。一変数一役割。

・関数中である場所でしか使用しないテンポラリ用のオート変数は{}で括って、
　使う場所でだけ定義する
	for(i = 0;i < PMTEL_NUMBER_MAX;i++)
	{
		PMTEL_NUMBER_ID	tmp;
		tmp = PMTel_GetTelNumberFromTrID(...);
	}

・extern宣言を*.cファイルには書かない。必ず*.hファイルに書いてから*.cにインクルードする。

・関数宣言での引数は型だけではなく引数名もかならず書く。


※上記に関してどうしてもルールからはずれるという場合は必ずコメントを追加し、
　ＦＣの指定会議室に例外処理の内容・場所・理由をアップする。


--------------------------------------------------------------------
		気をつけること
--------------------------------------------------------------------

・0or1で判定する引数や返り値の型を積極的にBOOLにし、
　マジックナンバーではなくTRUE/FALSEの定義を用いて記述するようにする

・不必要なreturnを定義しない（不要になったら、戻り値を返さない関数型にできるだけ修正する）

・warningもきちんと解消する

・引数としてとる値に候補がある場合、候補値をdefine定義しておき、それをコメントで明示する。
　enumやtypedefで値の範囲、候補を明示するのがベスト

	//enumで型を定義してしまう
	typedef enum{
		TEL_TALK_MODE_NORMAL,
		TEL_TALK_MODE_REVENGE,
		TEL_TALK_MODE_ITEM
	}PMTEL_TALK_MODE;

	void PMTEL_GetTelNumberFromTrID(PMTEL_TALK_MODE number,...){
		・・・
	}

	//もしくはコメント内にしっかり書く
	/**
		@param	mode	TEL_TALK_MODE_xxxx(pmtel_talk.hに定義)
		＊定義されているヘッダ名やヘッダの場所、ヘッダ内のどれが候補なのか伝わるように！
		　「○○.hに定義」としか書いていないと、ヘッダ中のどれがそうなのかわかりずらい
	*/
	void PMTelSub_SetTalkData(u8 mode,..){
		switch(mode){
		case TEL_TALK_MODE_NORMAL:
			break;
		case TEL_TALK_MODE_REVENGE:
			break;
		case TEL_TALK_MODE_ITEM:
			break;
		}
	}

	//0,1,2,とかマジックナンバー記述するとわかりずらい
	void PMTelSub_SetTalkData(u8 mode){
		switch(mode){
		case 0:
			break;
		case 1:
			break;
		case 2:
			break;
		}
	}

・GF_ASSERT()を記述するときは、単にGF_ASSERT(0)などとせずに
　引っかかったときに、何が？何で？、引っかかったかわかるようなメッセージを
　出力するように心がける

	//これだけでもプログラマがソースを見にいけばわかるけれど
	GF_ASSERT(0)	

	//一言コメントがあったほうが分り易い
	//(プログラマ以外が問い合わせやすいし、プログラマも場所と症状の特定が早い)
	// コメントを一緒に入れるとwarningが出るのでGF_ASSERT_MSGで。
	GF_ASSERT_MSG(0 , "地形モデルの圧縮データが領域を超えた");

	↑この場合だと、ファイル名まで出力されるとわかりやすい
	>地形圧縮データが領域を超えた->m_dun1000_00_00.imd
	>GF_ASSERT(0)


・変数を定義する時に、適切な(必要な)サイズで定義するように心がける

たとえば、構造体型を定義するとき、構造体サイズはデフォルトで4byte区切りがかかるので
本当はu8で十分な変数を、構造体自体のサイズが変わらないために、u16で定義したりすることがある

struct{
 u8	id;
 u8 type;
 u16 number;	//<値としてはu8で十分でも、パディングのためにu16でいいや、とすることがある
};
//これを
struct{
 u8	id;
 u8 type;
 u8 number;	//<u8で十分ならu8で定義して
 u8	pad;	//パディング用の変数名を定義して空き領域として示しておくと、後から拡張したい場合に使いやすい、かも
			//DP→金銀などのように、ソースが継承される場合には有効
};


--------------------------------------------------------------------
		subversionでの指針
--------------------------------------------------------------------
・意味のあるコメントを必ず書く。
　『更新』とか『//』だけとかでなく、更新内容を書く。

・無関係なソースを一緒にコミットしない。
　（例）
	evobj.hとfntequ.hとserver.cを一緒にコミットするようなことは禁止

・関係のある更新内容のファイルは一緒にコミットする。
　（例）
	表示可能な文字を増やしたときに、fntequ.hとprint.cを一緒にコミットする。



====================================================================
====================================================================
====================================================================
2008/03/03 初版作成
岩澤幸・斉藤望・森昭人

2009/04/10	玉田
金銀コーディング規約から派生

2009/04/15	玉田
WBプログラマミーティング結果を反映

2009/04/21	玉田
WBプログラマミーティング（4/21)の結果を反映

2009/05/06  玉田
WBプログラマミーティング（4/28）の結果を反映
・多重インクルードは#pragma onceで
・インデント関連をフィックス。
・{}の位置をフィックス。あわせて例も修正
・doxygen形式の関数コメント位置を*.cとすることを追加
・無限ループに関する注意書きを追加（番兵の扱い）

