#=============================================================================================
#
#	ƒXƒ^ƒbƒtƒ[ƒ‹FGMMƒtƒ@ƒCƒ‹ì¬
#	2010/04/23 by nakahiro
#
#=============================================================================================

#---------------------------------------------------------------------------------------------
#	’è”’è‹`
#---------------------------------------------------------------------------------------------


#---------------------------------------------------------------------------------------------
#	ƒOƒ[ƒoƒ‹•Ï”
#---------------------------------------------------------------------------------------------
$CSV_FILE = $ARGV[0];		# Œ³ƒtƒ@ƒCƒ‹
$GMM_FILE = $ARGV[1];		# ƒeƒ“ƒvƒŒ[ƒg‚f‚l‚l

$CNV_FILE = 0;				# ƒRƒ“ƒo[ƒgƒtƒ@ƒCƒ‹–¼
@TailData = ();				# ƒeƒCƒ‹ƒf[ƒ^


#---------------------------------------------------------------------------------------------
#	ƒƒCƒ“ˆ—
#---------------------------------------------------------------------------------------------

&SUB_MakeCnvFileName();	# ƒRƒ“ƒo[ƒgƒtƒ@ƒCƒ‹–¼ì¬
&SUB_TemplateGMM();		# ƒwƒbƒ_•”•ª‚Ì‘‚«‚İ‚ÆƒeƒCƒ‹•”•ª‚Ìæ“¾
&SUB_DataConv();		# ƒf[ƒ^ƒRƒ“ƒo[ƒg
&SUB_SetTailGMM();		# ƒeƒCƒ‹•”•ª‚Ì‘‚«‚İ

exit;


#---------------------------------------------------------------------------------------------
#	ƒRƒ“ƒo[ƒgƒtƒ@ƒCƒ‹–¼ì¬
#---------------------------------------------------------------------------------------------
sub SUB_MakeCnvFileName {
	$CNV_FILE = $CSV_FILE;
	$CNV_FILE =~ s/.csv/.gmm/;
}


#---------------------------------------------------------------------------------------------
#	ƒwƒbƒ_•”•ª‚Ì‘‚«‚İ‚ÆƒeƒCƒ‹•”•ª‚Ìæ“¾
#---------------------------------------------------------------------------------------------
sub SUB_TemplateGMM {
	# ƒeƒ“ƒvƒŒ[ƒg‚f‚l‚l“Ç‚İ‚İ
	open( FP_GMM, $GMM_FILE );
	@fp_gmm = <FP_GMM>;
	close( FP_GMM );

	# ì¬ƒtƒ@ƒCƒ‹ƒI[ƒvƒ“
	open( FP_CNV, "> " . $CNV_FILE );

	$seq = 0;
	$cnt = 0;
	foreach $one ( @fp_gmm ){
		# ƒwƒbƒ_‘‚«‚İ
		if( $seq == 0 ){
			if( $one =~ /<row id=/ ){
				$seq = 1;
			}else{
				print( FP_CNV $one );
			}
		# ƒeƒCƒ‹ŒŸõ
		}elsif( $seq == 1 ){
			if( $one =~ /<flowchart-group-list>/ ){
				$seq = 2;
			}
		}

		# ƒeƒCƒ‹‘‚«‚İ
		if( $seq == 2 ){
			$TailData[$cnt] = $one;
			$cnt++;
		}
	}
	close( FP_CNV );
}

#---------------------------------------------------------------------------------------------
#	ƒf[ƒ^ƒRƒ“ƒo[ƒg
#---------------------------------------------------------------------------------------------
use Encode;

sub SUB_DataConv {
	# Œ³ƒtƒ@ƒCƒ‹ƒI[ƒvƒ“
	open( FP_CSV, "< " . $CSV_FILE );
	$fp_csv = <FP_CSV>;					# ƒ_ƒ~[
	@fp_csv = <FP_CSV>;
	close( FP_CSV );

	# ì¬ƒtƒ@ƒCƒ‹ƒI[ƒvƒ“
	open( FP_CNV, ">> " . $CNV_FILE );

	$cnt = 0;
	foreach $one ( @fp_csv ){
		@line = split( ",", $one );		# ","‚Å•ªŠ„

		$line[0] =~ s/&/&amp;/g;		# "&"‚ğ"&amp;"‚É’u‚«Š·‚¦
		$line[0] =~ s/A/,/g;			# "A"‚ğ","‚É’u‚«Š·‚¦

#		$eE = "Ã‰<";
#		$eE = $eE + 0;
#		$aA = "<";
#		$aA = $aA + 0;
#       $eE = $eE - $aA;

#		$line[0] =~ s/\?/&aelig;/g;			# "A"‚ğ","‚É’u‚«Š·‚¦

#		print( $line[0] . "\t" );

		if( $line[0] ne "" ){
#			$text = encode( "utf8", decode( "shiftjis", $line[0] ) );	# Shift-Jis > UTF8
			$text = encode( "utf8", decode( "cp932", $line[0] ) );	# Shift-Jis > UTF8

			# "E'"‚±‚Ì•¶š‚ª"?"‚É‚È‚Á‚Ä‚µ‚Ü‚¤‚½‚ßA‹­ˆø‚É’u‚«Š·‚¦‚Ä‚Ü‚·B
			# •¶šƒR[ƒh‚ğUTF8‚É•ÏŠ·‚µA"?"‚ğ’u‚«Š·‚¦‚éB
			$eE = encode( "utf8", pack( "C", hex("C9") ) );
			$text =~ s/\?/$eE/g;

			if( $cnt < 10 ){
				print( FP_CNV "\t<row id=\"STAFF_ROLL_STR_00" . $cnt ."\">\n" );
			}elsif( $cnt < 100 ){
				print( FP_CNV "\t<row id=\"STAFF_ROLL_STR_0" . $cnt ."\">\n" );
			}else{
				print( FP_CNV "\t<row id=\"STAFF_ROLL_STR_" . $cnt ."\">\n" );
			}
			print( FP_CNV "\t\t<language name=\"JPN\" width=\"256\">" . $text . "</language>\n" );
			print( FP_CNV "\t\t<language name=\"JPN_KANJI\" width=\"256\">" . $text . "</language>\n" );
			print( FP_CNV "\t</row>\n\n" );
			$cnt++;
		}
	}

	close( FP_CNV );

#	print( $eE . "\n" );
}


#---------------------------------------------------------------------------------------------
#	ƒeƒCƒ‹•”•ª‚Ì‘‚«‚İ
#---------------------------------------------------------------------------------------------
sub SUB_SetTailGMM {
	# ì¬ƒtƒ@ƒCƒ‹ƒI[ƒvƒ“
	open( FP_CNV, ">> " . $CNV_FILE );
	foreach $one ( @TailData ){
		print( FP_CNV $one );
	}
	close( FP_CNV );
}
