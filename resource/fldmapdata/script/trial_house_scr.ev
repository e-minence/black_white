//======================================================================
//                trial_house_scr.ev
//
//    スクリプトファイル：トライアルハウス　trial_house_scr用
//
//======================================================================

  .text

  .include  "scr_seq_def.h"
  .include  "../../message/dst/script/msg_trialhouse.h"
  .include  "c04r0901.h"

//----------------------------------------------------------------------
//               スクリプトテーブル
//----------------------------------------------------------------------

_EVENT_DATA   ev_tri_house_reception
_EVENT_DATA_END

DEFINE_LOCAL exit

//受付
EVENT_START ev_tri_house_reception

  DEFINE_LOCAL first_list_ret
  DEFINE_LOCAL loop
  DEFINE_LOCAL rank

  //トライアルハウススタート
  _TH_START()

  _TALK_OBJ_START()
  
  //ループ初期化
  $loop = TRUE

  //ランク取得
  _TH_GET_RANK(rank)
  //マスターランクになったか？
  IF $rank == TH_RANK_MASTER THEN
    //「ししょう！チャレンジする？」
    _BALLOONWIN_TALKOBJ_MSG_DOWN(msg_trialhouse_002)
  ELSE
    //「チャレンジする？」
    _BALLOONWIN_TALKOBJ_MSG_DOWN(msg_trialhouse_001)
  ENDIF

  WHILE $loop == TRUE
    $loop = FALSE
    //リスト作成
    _BMPMENU_INIT_EX( 1,1,0,1,first_list_ret )
    _BMPMENU_MAKE_LIST( msg_trialhouse_str1, 0 )    //チャレンジ
    _BMPMENU_MAKE_LIST( msg_trialhouse_str2, 1 )    //せつめい
    _BMPMENU_MAKE_LIST( msg_trialhouse_str3, 2 )    //やめる
     _BMPMENU_START()
    //ウィンドウ閉じる
    _BALLOONWIN_CLOSE()
    IF $first_list_ret == EV_WIN_B_CANCEL THEN//キャンセル
      //やめるフラグＯＮ
      $exit = TRUE
    ELSE
      SWITCH $first_list_ret
      CASE 0 THEN   //チャレンジ
        _CALL charange
      CASE 1 THEN //説明聴く
        $loop = TRUE      //ループフラグ立てる
        //説明メッセージコール
        _CALL explanation
      CASE 2 THEN //やめる
        //やめるフラグＯＮ
        $exit = TRUE
      ENDSWITCH
    ENDIF
  ENDWHILE

  IF $exit == TRUE THEN
    //「またこんど」
    _BALLOONWIN_TALKOBJ_MSG_DOWN(msg_trialhouse_005)
    _LAST_KEYWAIT()
    _BALLOONWIN_CLOSE()
  ENDIF

  //トライアルハウス終了
  _TH_END()

EVENT_END

//説明
explanation:
  //説明メッセージ
  _BALLOONWIN_TALKOBJ_MSG_DOWN(msg_trialhouse_001)  //@todo
_RET

charange:
  DEFINE_LOCAL    list_ret
  DEFINE_LOCAL    party_sel
  DEFINE_LOCAL    regulation
  DEFINE_LOCAL    download
  //「チャレンジするのね。ちょっとまって」
  _BALLOONWIN_TALKOBJ_MSG_DOWN(msg_trialhouse_003)
  _BALLOONWIN_CLOSE()

  //ビーコンサーチ処理
  _TH_SEARCH_BEACON( download )

  //ダウンロードデータで遊ぶかをセットする
  _TH_SET_DL_FLG( download )
  //シングル？ダブル?
  _BALLOONWIN_TALKOBJ_MSG_DOWN(msg_trialhouse_006)
  //リスト作成
  _BMPMENU_INIT_EX( 1,1,0,1,first_list_ret )
  _BMPMENU_MAKE_LIST( msg_trialhouse_str4, 0 )    //シングル
  _BMPMENU_MAKE_LIST( msg_trialhouse_str5, 1 )    //ダブル
  _BMPMENU_MAKE_LIST( msg_trialhouse_str3, 2 )    //やめる
  _BMPMENU_START()
  //ウィンドウ閉じる
  _BALLOONWIN_CLOSE()

  IF $list_ret == EV_WIN_B_CANCEL THEN  //キャンセル
    //やめるフラグＯＮ
    $exit = TRUE
    _RET
  ELSE
    DEFINE_LOCAL mode
    SWITCH $list_ret
    CASE 0 THEN   //シングル
      $regulation = REG_SUBWAY_SINGLE   //バトルサブウェイシングルレギュレーションで代用
      $mode = TH_PLAYMODE_SINGLE 
    CASE 1 THEN //ダブル
      $regulation = REG_SUBWAY_DOUBLE   //バトルサブウェイダブルレギュレーションで代用
      $mode = TH_PLAYMODE_DOUBLE
    CASE 2 THEN //やめる
      //やめるフラグＯＮ
      $exit = TRUE
     _RET
    ENDSWITCH
    //戦闘モードセット
    _TH_SET_PLAY_MODE( mode )
  ENDIF

  //「早速はじめる」
  _BALLOONWIN_TALKOBJ_MSG_DOWN(msg_trialhouse_011)
  _BALLOONWIN_CLOSE()

  //手持ちかバトルボックスか選ぶウィンドウ表示(メンバチェック込み)
  _BTL_UTIL_PARTY_SELECT_CALL( regulation, party_sel )

  IF $party_sel == SCR_BTL_PARTY_SELECT_CANCEL THEN //キャンセル
    //やめるフラグＯＮ
    $exit = TRUE
  ELSIF $party_sel == SCR_BTL_PARTY_SELECT_NG THEN
    //参加できるポケモンがいません
    _BTL_UTIL_PARTY_REGULATION_NG_MSG_CALL( regulation )
    _RET
  ENDIF

  //ポケモンリストコール
  _TH_SEL_POKE(regulation, party_sel, SCWK_ANSWER)

  IF $SCWK_ANSWER == FALSE THEN   //キャンセルした
    //やめるフラグＯＮ
    $exit = TRUE
    _RET
  ENDIF

  //「でははじめるよ」
  _BALLOONWIN_TALKOBJ_MSG_DOWN(msg_trialhouse_013)
  _BALLOONWIN_CLOSE()

  //受付係はける
  _OBJ_ANIME( C04R0901_RECEPTION_01, anm_recep_open )
  _OBJ_ANIME_WAIT()
  //自機バトル場に移動
  _OBJ_ANIME( MMDL_ID_PLAYER, anm_player_mov )
  _OBJ_ANIME_WAIT()
  _CALL battle

  //自機受付に戻る
  _OBJ_ANIME( MMDL_ID_PLAYER, anm_player_ret )
  _OBJ_ANIME_WAIT()
  //受付係もどる
  _OBJ_ANIME( C04R0901_RECEPTION_01, anm_recep_close )
  _OBJ_ANIME_WAIT()
  

  IF $SCWK_ANSWER == TRUE THEN
   DEFINE_LOCAL result_rank
   DEFINE_LOCAL rank_msg
    //「おつかれさま」
    _BALLOONWIN_TALKOBJ_MSG_DOWN(msg_trialhouse_014)
    _BALLOONWIN_CLOSE()
    //評価アプリ起動 @todo

    $result_rank = TH_RANK_BEGINNER //@todo

    SWITCH $result_rank
    CASE TH_RANK_BEGINNER THEN
      //「ビギナー」
      $rank_msg = msg_trialhouse_021
    CASE TH_RANK_NOVICE THEN
      //「ノービス」
      $rank_msg = msg_trialhouse_020
    CASE TH_RANK_NORMAL THEN
      //「ノーマル」
      $rank_msg = msg_trialhouse_019
    CASE TH_RANK_SUPER THEN
      //「スーパー」
      $rank_msg = msg_trialhouse_018
    CASE TH_RANK_HYPER THEN
      //「ハイパー」
      $rank_msg = msg_trialhouse_017
    CASE TH_RANK_ELITE THEN
      //「エリート」
      $rank_msg = msg_trialhouse_016
    CASE TH_RANK_MASTER THEN
      //「マスター」
      $rank_msg = msg_trialhouse_015
    DEFAULT
      //ここにはこないがビギナーをセットしておく
      $rank_msg = msg_trialhouse_021
    ENDSWITCH

    //ランクセット
    _TH_SET_RANK( result_rank )

    //ラストメッセージ
    _BALLOONWIN_TALKOBJ_MSG_DOWN(rank_msg)
    _LAST_KEYWAIT()
    _BALLOONWIN_CLOSE()

  ENDIF
  
_RET

battle:
  DEFINE_LOCAL btl_count
  DEFINE_LOCAL obj_id
  
  $btl_count = 0
  WHILE $btl_count < 5
    //トレーナー抽選
    _TH_SET_TR(btl_count, obj_id)
    //ＯＢＪ追加
    _OBJ_ADD_EX( 7, 0, DIR_DOWN, MMDL_ID_EVENTOBJ_00 , obj_id, MV_DMY )
    //ＯＢＪ移動
    _OBJ_ANIME( MMDL_ID_EVENTOBJ_00, anm_enemy_mov )
    _OBJ_ANIME_WAIT()
    //バトル前メッセージ
    _TH_DISP_BEFORE_MSG()
    //バトル
    _TH_CALL_BATTLE()
    //ＯＢＪ退出
    _OBJ_ANIME( MMDL_ID_EVENTOBJ_00, anm_enemy_ret )
    _OBJ_ANIME_WAIT()
    //ＯＢＪ削除
    _OBJ_DEL(MMDL_ID_EVENTOBJ_00)
    //戦闘回数加算
    $btl_count += 1
/**
    {
      DEFINE_LOCAL retire
      //リタイアする？
      _YES_NO_WIN( retire )
      IF $retire == SCR_YES THEN //リタイア
        $SCWK_ANSWER = TRUE     //リタイアなので、評価無し
        _RET
      ENDIF
    }
*/    
  ENDWHILE
  //５戦後の処理
  $SCWK_ANSWER = TRUE     //５戦消化したので評価してもらう
_RET



//--------------------------------------------------------------------
//受付係はける
//--------------------------------------------------------------------
_ANIME_LABEL	anm_recep_open
  _ANIME_DATA	AC_WALK_U_8F,1
  _ANIME_DATA	AC_WALK_L_8F,1
  _ANIME_DATA	AC_STAY_WALK_R_8F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//自機定位置へ
//--------------------------------------------------------------------
_ANIME_LABEL	anm_player_mov
  _ANIME_DATA	AC_WALK_U_8F,5
  _ANIME_DATA	AC_WALK_R_8F,2
  _ANIME_DATA	AC_STAY_WALK_L_8F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//対戦相手定位置へ
//--------------------------------------------------------------------
_ANIME_LABEL	anm_enemy_mov
  _ANIME_DATA AC_VANISH_OFF,1
  _ANIME_DATA	AC_WALK_D_8F,4
  _ANIME_DATA	AC_WALK_L_8F,2
  _ANIME_DATA	AC_STAY_WALK_R_8F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//対戦相手もどる
//--------------------------------------------------------------------
_ANIME_LABEL	anm_enemy_ret
  _ANIME_DATA	AC_WALK_R_8F,2
  _ANIME_DATA	AC_WALK_U_8F,4
  _ANIME_DATA AC_VANISH_ON,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//自機もどる
//--------------------------------------------------------------------
_ANIME_LABEL	anm_player_ret
  _ANIME_DATA	AC_WALK_L_8F,2
  _ANIME_DATA	AC_WALK_D_8F,5
  _ANIME_DATA	AC_STAY_WALK_U_8F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//受付係もどる
//--------------------------------------------------------------------
_ANIME_LABEL	anm_recep_close
  _ANIME_DATA	AC_WALK_R_8F,1
  _ANIME_DATA	AC_WALK_D_8F,1
	_ANIME_DATA	ACMD_END,0
 
  

  


