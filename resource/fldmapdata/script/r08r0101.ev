
//======================================================================
//                r08r0101.ev
//
//    スクリプトファイル：r08r0101用
//
//======================================================================

  .text

  .include  "scr_seq_def.h"
  .include  "../../message/dst/script/msg_r08r0101.h"
  .include  "r08r0101.h"
  .include  "skill_teach_scr_def.h"     //for SCRID_SKILL_LEARN

//--------------------------------------------------------------
//               スクリプト本体
//--------------------------------------------------------------

//--------------------------------------------------------------
//               スクリプトテーブル
//--------------------------------------------------------------
_EVENT_DATA    ev_zone_r08r0101     //ゾーンチェンジスクリプト
_EVENT_DATA    ev_scene_r08r0101   //シーンスクリプト
_EVENT_DATA_END


//イベント対象となるダルタニスの手持ち位置
DEFINE_LOCAL target_poke_pos

DEFINE_LOCAL AnmX
DEFINE_LOCAL AnmZ
DEFINE_LOCAL FV
DEFINE_LOCAL TrgtObj

/**************************************************************/
/*            SCENE_SCRIPT                               */
/**************************************************************/
EVENT_START ev_scene_r08r0101
  //自機所定の位置へ移動
  _OBJ_ANIME( MMDL_ID_PLAYER, anm_player_move )
  _OBJ_ANIME_WAIT()
  //条件を満たしたダルタニスが手持ちから検索して今回の対象ポケモンにする
  _GET_EVT_POKE_POS( MONSNO_654, TRUE, target_poke_pos, SCWK_ANSWER )
  IF $SCWK_ANSWER == TRUE THEN
    //対象ダルタニスのニックネームをタグ０番にセット
    _TEMOTI_NICK_NAME( 0, target_poke_pos )
    //「○○ボールからだす？」
    _SYSWIN_MSG( msg_r08r0101_narrator_01, POS_DOWN )
    _YES_NO_WIN( SCWK_ANSWER )
    _SYSWIN_CLOSE()

    IF $SCWK_ANSWER == 0 THEN
      //ボール投げるアニメ
      {
        $AnmX = 24
        $AnmZ = 38
        $FV = FV_R08R0101_POKE11
        $TrgtObj = R08R0101_POKE11_01
        _CALL ball_out
      }
      //対象ダルタニスのニックネームをタグ０番にセット
      _TEMOTI_NICK_NAME( 0, target_poke_pos )
      //「○○はとびだした」
      _SYSWIN_MSG( msg_r08r0101_narrator_03, POS_DOWN )
      _SYSWIN_CLOSE()
      //一度でも技覚えた？
      IF FLAG_OFF( FE_R08R0101_LEG_FIRST ) THEN   //まだ覚えてない
        //おじさん登場
        _FLAG_RESET( FV_R08R0101_OLDMAN1 )
        _OBJ_ADD(R08R0101_OLDMAN1_01)
        _OBJ_POS_CHANGE( R08R0101_OLDMAN1_01, 25, 0, 47, DIR_UP )
        _OBJ_ANIME( R08R0101_OLDMAN1_01, anm_oldman_move )
        _OBJ_ANIME_WAIT()
        
        _BALLOONWIN_OBJMSG_POS( msg_r08r0101_guide_01 , R08R0101_OLDMAN1_01, POS_DR )
        _BALLOONWIN_CLOSE()
        _BALLOONWIN_OBJMSG_POS( msg_r08r0101_guide_02 , R08R0101_OLDMAN1_01, POS_DR )
        _BALLOONWIN_CLOSE()
        _BALLOONWIN_OBJMSG_POS( msg_r08r0101_guide_03 , R08R0101_OLDMAN1_01, POS_DR )
        _BALLOONWIN_CLOSE()
        _BALLOONWIN_OBJMSG_POS( msg_r08r0101_guide_04 , R08R0101_OLDMAN1_01, POS_DR )
        _BALLOONWIN_CLOSE()
        
      ENDIF
      //三銃士ポケモンそろっているか？
      {
        DEFINE_LOCAL find_pos  //引数として必要なので用意してるだけ
        DEFINE_LOCAL find_num
        //検索数初期化
        $find_num = 0
        //アトスいるか？
        _GET_PARTY_POS( MONSNO_645, SCWK_ANSWER, find_pos )
        IF $SCWK_ANSWER == TRUE THEN
          $find_num+=1
        ENDIF
        //ポルトスいるか？
        _GET_PARTY_POS( MONSNO_646, SCWK_ANSWER, find_pos )
        IF $SCWK_ANSWER == TRUE THEN
          $find_num+=1
        ENDIF
        //アラミスいるか？
        _GET_PARTY_POS( MONSNO_647, SCWK_ANSWER, find_pos )
        IF $SCWK_ANSWER == TRUE THEN
          $find_num+=1
        ENDIF
        //三匹そろってるか？
        IF $find_num >= 3 THEN
          $SCWK_ANSWER = TRUE       //条件満たした
        ELSE
          $SCWK_ANSWER = FALSE      //条件満たしてない
        ENDIF
      }
      IF $SCWK_ANSWER == TRUE THEN
        //イベント続行
        _CALL sp_poke_main_event
      ELSE
        //一度でも技覚えた？
        IF FLAG_OFF( FE_R08R0101_LEG_FIRST ) THEN   //まだ覚えてない
          //「ポケモン探してる」
          _BALLOONWIN_OBJMSG_POS( msg_r08r0101_guide_07 , R08R0101_OLDMAN1_01, POS_DR )
          _BALLOONWIN_CLOSE()
          //おじさん退出
          _CALL oldman_bye
        ELSE
          //ダルタニス戻る
          {
            $AnmX = 24
            $AnmZ = 39
            $TrgtObj = R08R0101_POKE11_01
            _CALL ball_in
          }
          //対象ダルタニスのニックネームをタグ０番にセット
          _TEMOTI_NICK_NAME( 0, target_poke_pos )
          //○○はボールに戻った
          _SYSWIN_MSG( msg_r08r0101_narrator_07, POS_DOWN )
          _SYSWIN_CLOSE()
          //終了
        ENDIF
      ENDIF
    ELSE
      //「ボールにとどまった」＞＞終了
      _SYSWIN_MSG( msg_r08r0101_narrator_02, POS_DOWN )
      _LAST_KEYWAIT()
      _SYSWIN_CLOSE()
    ENDIF
  ENDIF

  //イベント終了 ローカルワーク0に0をセット
  $LOCALWORK0 = 0
EVENT_END

/**************************************************************/
/*            ZONE_CHANGE_SCRIPT                               */
/**************************************************************/
INIT_EVENT_START ev_zone_r08r0101
  DEFINE_LOCAL pos
  //ＯＢＪのバニッシュフラグをセットする(非表示状態)
  _FLAG_SET( FV_R08R0101_POKE4 )
	_FLAG_SET( FV_R08R0101_POKE5 )
	_FLAG_SET( FV_R08R0101_POKE6 )
	_FLAG_SET( FV_R08R0101_POKE11 )
  _FLAG_SET( FV_R08R0101_OLDMAN1 )
  //イベント条件判定
  _GET_EVT_POKE_POS( MONSNO_654, TRUE, pos, SCWK_ANSWER )
  IF $SCWK_ANSWER == TRUE THEN
    //ローカルワーク0に1をセット  イベント有効
    $LOCALWORK0 = 1
  ELSE
    //ローカルワーク0に0をセット　イベント無効
    $LOCALWORK0 = 0
  ENDIF
INIT_EVENT_END

//イベント中核
sp_poke_main_event:
  DEFINE_LOCAL skill_learn
  //三匹ポケを順に出す
  {
    $AnmX = 24
    $AnmZ = 36
    $FV = FV_R08R0101_POKE4
    $TrgtObj = R08R0101_POKE4_01
    _CALL ball_out
  }
  {
    $AnmX = 22
    $AnmZ = 38
    $FV = FV_R08R0101_POKE5
    $TrgtObj = R08R0101_POKE5_01
    _CALL ball_out
  }
  {
    $AnmX = 26
    $AnmZ = 38
    $FV = FV_R08R0101_POKE6
    $TrgtObj = R08R0101_POKE6_01
    _CALL ball_out
  }

  //ポケ小芝居
  _CALL poke_jump

  //一度でも技覚えた？
  IF FLAG_OFF( FE_R08R0101_LEG_FIRST ) THEN   //まだ覚えてない
    //「なにかを伝えようとしている」
    _BALLOONWIN_OBJMSG_POS( msg_r08r0101_guide_05 , R08R0101_OLDMAN1_01, POS_DR )
    _BALLOONWIN_CLOSE()
  ELSE
  ENDIF

  //それぞれダルタニスに近づく
  _OBJ_ANIME( R08R0101_POKE4_01, anm_poke4_move )
  _OBJ_ANIME( R08R0101_POKE5_01, anm_poke5_move )
  _OBJ_ANIME( R08R0101_POKE6_01, anm_poke6_move )
  _OBJ_ANIME_WAIT()

  //対象ダルタニスのニックネームをタグ０番にセット
  _TEMOTI_NICK_NAME( 0, target_poke_pos )
  //○○にきせきのつるぎを覚えさせる?
  _SYSWIN_MSG( msg_r08r0101_narrator_04, POS_DOWN )
  _YES_NO_WIN( SCWK_ANSWER )
  _SYSWIN_CLOSE()
  IF $SCWK_ANSWER == 0 THEN
    //LOCALWORK14：ポケモン位置　LOCALWORK15：覚えさせる技ＩＤ
    $LOCALWORK14 = $target_poke_pos
    $LOCALWORK15 = WAZANO_KISEKINOTURUGI
    //技覚えシーケンス SCWK_ANSWER=TRUEで覚えた
    _CHG_COMMON_SCR SCRID_SKILL_LEARN
    //覚えた？
    IF $SCWK_ANSWER == FALSE THEN
      $skill_learn = FALSE      //覚えてない
    ELSE
      $skill_learn = TRUE      //覚えた
    ENDIF
  ELSE
    $skill_learn = FALSE
  ENDIF

  //三匹戻る
  {
    $AnmX = 24
    $AnmZ = 37
    $TrgtObj = R08R0101_POKE4_01
    _CALL ball_in
  }
  {
    $AnmX = 23
    $AnmZ = 38
    $TrgtObj = R08R0101_POKE5_01
    _CALL ball_in
  }
  {
    $AnmX = 25
    $AnmZ = 38
    $TrgtObj = R08R0101_POKE6_01
    _CALL ball_in
  }

  {
    DEFINE_LOCAL oldman_last_msg
    //覚えなかったとき
    IF $skill_learn == FALSE THEN
      //「おぬししだい」
      $oldman_last_msg = msg_r08r0101_guide_08
    ELSE
      //「おぬしのおかげ」
      $oldman_last_msg = msg_r08r0101_guide_06
    ENDIF
    //一度でも技覚えた？
    IF FLAG_OFF( FE_R08R0101_LEG_FIRST ) THEN   //まだ覚えてない
      //おじさんメッセージ
      _BALLOONWIN_OBJMSG_POS( oldman_last_msg, R08R0101_OLDMAN1_01, POS_DR )
      _BALLOONWIN_CLOSE()
      //おじさん退出
      _CALL oldman_bye
    ENDIF

    IF $skill_learn == TRUE THEN
      //技を覚えたのでイベント消化フラグＯＮ
      _FLAG_SET( FE_R08R0101_LEG_FIRST )
    ENDIF
  }

  //ダルタニス戻る
  {
    $AnmX = 24
    $AnmZ = 38
    $TrgtObj = R08R0101_POKE11_01
    _CALL ball_in
  }

_RET

//おじさん退場
oldman_bye:
  _OBJ_ANIME( R08R0101_OLDMAN1_01, anm_oldman_bye )
  _OBJ_ANIME_WAIT()
  _OBJ_DEL(R08R0101_OLDMAN1_01)
_RET

//ポケ小芝居
poke_jump:
  _OBJ_ANIME( R08R0101_POKE11_01, anm_poke11_left )
  _OBJ_ANIME_WAIT()
  _OBJ_ANIME( R08R0101_POKE5_01, anm_poke5_jump)
  _OBJ_ANIME_WAIT()

  _OBJ_ANIME( R08R0101_POKE11_01, anm_poke11_right )
  _OBJ_ANIME_WAIT()
  _OBJ_ANIME( R08R0101_POKE6_01, anm_poke6_jump)
  _OBJ_ANIME_WAIT()

  _OBJ_ANIME( R08R0101_POKE11_01, anm_poke11_up )
  _OBJ_ANIME_WAIT()
  _OBJ_ANIME( R08R0101_POKE4_01, anm_poke4_jump)
  _OBJ_ANIME_WAIT()

  _OBJ_ANIME( R08R0101_POKE11_01, anm_poke11_jump )
  _OBJ_ANIME_WAIT()
_RET

//--------------------------------------------------------------------
//おじさん所定位置に移動
//--------------------------------------------------------------------
_ANIME_LABEL	anm_oldman_move
  _ANIME_DATA	AC_WALK_U_8F,7
  _ANIME_DATA	AC_STAY_WALK_L_8F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//おじさん退場
//--------------------------------------------------------------------
_ANIME_LABEL	anm_oldman_bye
  _ANIME_DATA	AC_WALK_D_8F,7
	_ANIME_DATA	ACMD_END,0
  
//--------------------------------------------------------------------
//自機所定位置に移動
//--------------------------------------------------------------------
_ANIME_LABEL	anm_player_move
  _ANIME_DATA	AC_WALK_U_8F,1
  _ANIME_DATA	AC_WALK_L_8F,6
  _ANIME_DATA	AC_WALK_U_8F,7
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//アトス　ダルタニスに近づく上から
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke4_move
  _ANIME_DATA	AC_WALK_D_8F,1
	_ANIME_DATA	ACMD_END,0
  
//--------------------------------------------------------------------
//ポルトス　ダルタニスに近づく左から
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke5_move
  _ANIME_DATA	AC_WALK_R_8F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//アラミス　ダルタニスに近づく右から
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke6_move
  _ANIME_DATA	AC_WALK_L_8F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//ダルタニス左向く
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke11_left
  _ANIME_DATA	AC_STAY_WALK_L_8F,1
  _ANIME_DATA AC_WAIT_4F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//ダルタニス右向く
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke11_right
  _ANIME_DATA	AC_STAY_WALK_R_8F,1
  _ANIME_DATA AC_WAIT_4F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//ダルタニス上向く
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke11_up
  _ANIME_DATA	AC_STAY_WALK_U_8F,1
  _ANIME_DATA AC_WAIT_4F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//ダルタニス２回ジャンプ
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke11_jump
  _ANIME_DATA	AC_STAY_JUMP_U_8F,2
  _ANIME_DATA AC_WAIT_4F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//ポルトス　ジャンプ
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke5_jump
  _ANIME_DATA	AC_STAY_JUMP_R_8F,1
  _ANIME_DATA AC_WAIT_4F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//アラミス　ジャンプ
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke6_jump
  _ANIME_DATA	AC_STAY_JUMP_L_8F,1
  _ANIME_DATA AC_WAIT_4F,1
	_ANIME_DATA	ACMD_END,0

//--------------------------------------------------------------------
//アトス　ジャンプ
//--------------------------------------------------------------------
_ANIME_LABEL	anm_poke4_jump
  _ANIME_DATA	AC_STAY_JUMP_D_8F,1
  _ANIME_DATA AC_WAIT_4F,1
	_ANIME_DATA	ACMD_END,0


ball_out:
  _MOVE_BALL( SCR_BALL_ANM_TYPE_OUT, AnmX, 3, AnmZ, 3, 8 )
  _START_BALL_ANM( SCR_BALL_ANM_TYPE_OUT, AnmX, 3, AnmZ )
  //ボール出現フレーム待ち
  _WAIT_BALL_POKE_APP( SCR_BALL_ANM_TYPE_OUT )
  _DISP_FADE_START(DISP_FADE_WHITEOUT,0,16,0)
  _DISP_FADE_END_CHECK()
  //ポケを表示
  _FLAG_RESET( FV )
  _OBJ_ADD(TrgtObj)
  _DISP_FADE_START(DISP_FADE_WHITEOUT,16,0,0)
  _DISP_FADE_END_CHECK()
  _WAIT_BALL_ANM( SCR_BALL_ANM_TYPE_OUT )
_RET

ball_in:
  _START_BALL_ANM( SCR_BALL_ANM_TYPE_IN, AnmX, 6, AnmZ )
  //ポケ非表示フレーム待ち
  _WAIT_BALL_POKE_APP( SCR_BALL_ANM_TYPE_IN )
  _DISP_FADE_START(DISP_FADE_WHITEOUT,0,16,0)
  _DISP_FADE_END_CHECK()
  //ポケ非表示
  _OBJ_DEL(TrgtObj)
  _DISP_FADE_START(DISP_FADE_WHITEOUT,16,0,0)
  _DISP_FADE_END_CHECK()
  _WAIT_BALL_ANM( SCR_BALL_ANM_TYPE_IN )
  _MOVE_BALL( SCR_BALL_ANM_TYPE_IN, AnmX, 6, AnmZ, 3, 8 )
_RET
