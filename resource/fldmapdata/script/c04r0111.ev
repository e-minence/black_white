//======================================================================
//                c04r0111.ev
//    スクリプトファイル：c04r0111用
//  ギアステーションホーム　バトルサブウェイ　終点ホーム
//======================================================================
  
  .text
  .include "scr_seq_def.h"
  .include "msg_c04r0111.h"
  .include "c04r0111.h"
  .include "bsubway_scr_def.h"
  .include "../../../prog/src/field/bsubway_scr_def.h"

//--------------------------------------------------------------
//  スクリプトテーブル
//--------------------------------------------------------------
_EVENT_DATA ev_init_c04r0111_home     //初期化
_EVENT_DATA ev_recover_c04r0111_home  //復帰
_EVENT_DATA ev_c04r0111_receipt_talk  //受付話し掛け
_EVENT_DATA ev_c04r0111_partner_talk  //パートナー話し掛け
_EVENT_DATA ev_c04r0111_npc_talk      //NPC話し掛け
_EVENT_DATA ev_c04r0111_home          //ゲームクリア後のホーム
_EVENT_DATA_END

//--------------------------------------------------------------
//  共通利用ローカル変数
//--------------------------------------------------------------
DEFINE_LOCAL msg_id
DEFINE_LOCAL comm_ret

//======================================================================
//  バトルサブウェイ　ホーム　初期化、復帰
//======================================================================
//--------------------------------------------------------------
//  ホーム　初期化
//--------------------------------------------------------------
INIT_EVENT_START ev_init_c04r0111_home
{
  DEFINE_LOCAL play_mode
  
  _BSUBWAY_TOOL( BSWTOOL_GET_DATA_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  
  //受付　座標を変更
  _OBJ_POS_CHANGE( C04R0111_RECEIPT1, 17, 0, 14, DIR_RIGHT )
  _OBJ_POS_CHANGE( C04R0111_RECEIPT2, 76, 0, 14, DIR_LEFT )
  
  //ゲームクリア直後
  IF $WK_OTHER_BSUBWAY_HOME == BSWAY_SCENE_HOME_GAME_CLEAR THEN
    //電車セット
    _BSUBWAY_TOOL( BSWTOOL_SET_TRAIN, play_mode, BTRAIN_POS_HOME, BSW_NULL )
    
    //自機座標をデモ位置に
    _OBJ_POS_CHANGE( MMDL_ID_PLAYER, 75, 0, 12, DIR_DOWN )
    
    //周回に合わせてNPC追加
    _BSUBWAY_TOOL( BSWSUB_SET_HOME_OBJ, BSW_NULL, BSW_NULL, BSW_NULL )
  ENDIF
}
INIT_EVENT_END

//--------------------------------------------------------------
//  ホーム　復帰
//--------------------------------------------------------------
INIT_EVENT_START ev_recover_c04r0111_home
{
  DEFINE_LOCAL play_mode
  
  _BSUBWAY_TOOL( BSWTOOL_GET_DATA_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  
  _CHECK_CONTINUE_RECOVER( SCWK_ANSWER )
  
  //コンテニュー復帰　ワーク作成
  IF $SCWK_ANSWER == TRUE THEN
    IF $WK_OTHER_BSUBWAY_HOME != BSWAY_SCENE_HOME_NON THEN
      _BSUBWAY_WORK_CREATE( BSWAY_PLAY_CONTINUE, play_mode )
      
      //通信マルチの場合は通信切れにより終点にする
      IF $play_mode == BSWAY_MODE_COMM_MULTI || $play_mode == BSWAY_MODE_S_COMM_MULTI THEN
        $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_TERMINUS
      ENDIF
    ENDIF
  ENDIF
  
  //電車セット
  _BSUBWAY_TOOL( BSWTOOL_SET_TRAIN, play_mode, BTRAIN_POS_HOME, BSW_NULL )
  
  //途中駅ならば電車非表示
  IF $WK_OTHER_BSUBWAY_HOME == BSWAY_SCENE_HOME_STOPOVER THEN
    _BSUBWAY_TOOL( BSWTOOL_SET_TRAIN_VANISH, TRUE, BSW_NULL, BSW_NULL )
  ENDIF
}
INIT_EVENT_END

//======================================================================
//  バトルサブウェイ　ホーム　受付話し掛け
//======================================================================
//--------------------------------------------------------------
//  バトルサブウェイ　ホーム　受付話し掛け
//--------------------------------------------------------------
EVENT_START ev_c04r0111_receipt_talk
{
  DEFINE_LOCAL play_mode
  
  _TALK_OBJ_START()
  
  IF $WK_OTHER_BSUBWAY_HOME == BSWAY_SCENE_HOME_STOPOVER THEN //途中駅
    _BALLOONWIN_OBJMSG_POS( msg_c04r0111_15, SCWK_TARGET_OBJID, POS_DOWN )
    
    _BMPMENU_INIT_RIGHT( MENU_X1, MENU_Y1, 0, 1, SCWK_ANSWER )
    _BMPMENU_MAKE_LIST( msg_c04r0111_16, 0 )    //続ける
    _BMPMENU_MAKE_LIST( msg_c04r0111_17, 1 )    //ライモン
    _BMPMENU_MAKE_LIST( msg_c04r0111_18, 2 )    //まだここにいる
    _BMPMENU_START()
    
    SWITCH $SCWK_ANSWER
    CASE 0 THEN //続けて挑戦
      _MSGWIN_CLOSE()
      _CALL sub_challenge_continue_mode
    CASE 1 THEN //ライモン戻り
      _CALL sub_mapchg_receipt
    DEFAULT
      _MSGWIN_CLOSE()
    ENDSWITCH
  ELSE //終点
    _CALL sub_mapchg_receipt
  ENDIF
}
EVENT_END

//--------------------------------------------------------------
//  受付話し掛け　続けて挑戦　モード別処理へ  
//--------------------------------------------------------------
sub_challenge_continue_mode:
{
  DEFINE_LOCAL play_mode
  
  _BSUBWAY_TOOL( BSWTOOL_GET_DATA_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  
  SWITCH $play_mode
  CASE BSWAY_MODE_SINGLE THEN
    _CALL sub_challenge_continue
  CASE BSWAY_MODE_S_SINGLE THEN
    _CALL sub_challenge_continue
  CASE BSWAY_MODE_DOUBLE THEN
    _CALL sub_challenge_continue
  CASE BSWAY_MODE_S_DOUBLE THEN
    _CALL sub_challenge_continue
  CASE BSWAY_MODE_MULTI THEN
    _CALL sub_challenge_continue
  CASE BSWAY_MODE_S_MULTI THEN
    _CALL sub_challenge_continue
  CASE BSWAY_MODE_COMM_MULTI THEN
    _CALL sub_challenge_continue_comm_multi
  CASE BSWAY_MODE_S_COMM_MULTI THEN
    _CALL sub_challenge_continue_comm_multi
  ENDSWITCH
}
_RET

//--------------------------------------------------------------
//  バトルサブウェイ　ホーム　受付話し掛け  続けてチャレンジ
//  シングル、ダブル、AIマルチ
//--------------------------------------------------------------
sub_challenge_continue:
{
  DEFINE_LOCAL play_mode
   
  //受付をエラー状態に
  $WK_OTHER_BSUBWAY_RECEIPT = BSWAY_SCENE_RECEIPT_ERROR
  
  //車内を乗車状態に
  $WK_OTHER_BSUBWAY_TRAIN = BSWAY_SCENE_TRAIN_FIRST
  
  //プレイモード取得
  _BSUBWAY_TOOL( BSWSUB_GET_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  
  //戻り場所を受付に
  _BSUBWAY_TOOL( BSWSUB_SET_PLAY_MODE_LOCATION, BSW_NULL, BSW_NULL, BSW_NULL )
  
  //トレーナー抽選
  _BSUBWAY_TOOL( BSWSUB_BTL_TRAINER_SET, BSW_NULL, BSW_NULL, BSW_NULL )
  
  //ポケモンメンバーロード
  _BSUBWAY_TOOL( BSWSUB_LOAD_POKEMON_MEMBER, BSW_NULL, BSW_NULL, BSW_NULL)
  
  //レポート
  _SYSWIN_MSG( msg_c04r0111_02, POS_DOWN ) //ご案内する前にレポート
  _REPORT_CALL( SCWK_ANSWER )
  _MSGWIN_CLOSE()
  
  //電車発車デモ
  _CALL sub_demo_train_starting
  
  //ホーム制御　無しに
  $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_NON
  
  //マップ移動
  _MAP_CHANGE_NO_FADE( ZONE_ID_C04R0110, 7, 0, 4, DIR_UP )
}
_RET

//--------------------------------------------------------------
//  受付　続けてチャレンジ　commマルチ
//--------------------------------------------------------------
sub_challenge_continue_comm_multi:
{
  DEFINE_LOCAL ret
  DEFINE_LOCAL play_mode
  
  //お友達の選択を待っています
  _SYSWIN_MSG( msg_c04r0111_19, POS_DOWN )
  
  //受信バッファクリア
  _BSUBWAY_TOOL( BSWSUB_RECV_BUF_CLEAR, BSW_NULL, BSW_NULL, BSW_NULL )
  
  //選択結果送信開始同期
  _BSUBWAY_TOOL( BSWSUB_COMM_TIMSYNC, BSW_COMM_MULTI_HOME_MENU_SELECT, BSW_NULL, comm_ret )
  
  _MSGWIN_CLOSE()
  
  IF $comm_ret == FALSE THEN
    _CALL sub_challenge_continue_comm_multi_error
    _RET
  ENDIF
  
  $LOCALWORK0 = BSWAY_COMM_HOME_SEL_NEXT
   
  //選択結果送信
  _BSUBWAY_TOOL( BSWSUB_COMM_SEND_BUF, BSWAY_COMM_RETIRE_SELECT, LOCALWORK0, BSW_NULL )
  //選択結果受信
  _BSUBWAY_TOOL( BSWSUB_COMM_RECV_BUF, BSWAY_COMM_RETIRE_SELECT, BSW_NULL, LOCALWORK0 )
  
  IF $LOCALWORK0 == BSWAY_COMM_HOME_SEL_END THEN //相手終了
    //挑戦を終了
    _BALLOONWIN_TALKOBJ_MSG( msg_c04r0111_20 )
    _TIME_WAIT( 30 )
    _BSUBWAY_TOOL( BSWSUB_COMM_TIMSYNC, BSW_COMM_MULTI_HOME_RETIRE_WAIT, BSW_NULL, comm_ret )
    _MSGWIN_CLOSE()
    
    //通信切断
    _BSUBWAY_TOOL( BSWSUB_COMM_TIMSYNC, BSW_COMM_MULTI_HOME_SIO_END, BSW_NULL, comm_ret )
    _BSUBWAY_TOOL( BSWSUB_COMM_END, BSW_NULL, BSW_NULL, BSW_NULL )
    _BSUBWAY_TOOL( BSWSUB_SET_COMM_FLAG, FALSE, BSW_NULL, BSW_NULL )
    
    _REBOOT_BEACON_SEARCH() //通信切断後のビーコンサーチ再開

    //受付対応　ゲーム後へ
    $WK_OTHER_BSUBWAY_RECEIPT = BSWAY_SCENE_RECEIPT_AFTER
    
    //電車発車デモ
    _CALL sub_demo_train_starting
    
    //ワーク開放
//    _BSUBWAY_WORK_RELEASE()
    
    //ホーム制御　無しに
    $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_NON
    
    //受付へと戻る
    _CHG_COMMON_SCR SCRID_BSW_RETMAP_RECEIPT
  ELSE //相手続ける
    _SYSWIN_MSG( msg_c04r0111_02, POS_DOWN ) //ご案内する前にレポート

    //受付をエラー状態に
    $WK_OTHER_BSUBWAY_RECEIPT = BSWAY_SCENE_RECEIPT_ERROR
    
    //車内を乗車状態に
    $WK_OTHER_BSUBWAY_TRAIN = BSWAY_SCENE_TRAIN_FIRST
  
    //プレイモード取得
    _BSUBWAY_TOOL( BSWTOOL_GET_DATA_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  
    //戻り場所を受付に
    _BSUBWAY_TOOL( BSWSUB_SET_PLAY_MODE_LOCATION, BSW_NULL, BSW_NULL, BSW_NULL )
  
    //受信バッファクリア
    _BSUBWAY_TOOL( BSWSUB_RECV_BUF_CLEAR, BSW_NULL, BSW_NULL, BSW_NULL )

    //トレーナーセット開始
    _BSUBWAY_TOOL( BSWSUB_COMM_TIMSYNC, BSW_COMM_MULTI_HOME_BTL_TRAINER_SET, BSW_NULL, comm_ret )
    
    IF $comm_ret == FALSE THEN
      _MSGWIN_CLOSE()
      _CALL sub_challenge_continue_comm_multi_error
      _RET
    ENDIF
    
    //親機なら対戦トレーナー抽選
    _BSUBWAY_TOOL( BSWSUB_COMM_GET_CURRENT_ID, BSW_NULL, BSW_NULL, ret )
    
    IF $ret == 0 THEN //親機なら対戦トレーナーセット
      //トレーナー抽選
      _BSUBWAY_TOOL( BSWSUB_BTL_TRAINER_SET, BSW_NULL, BSW_NULL, BSW_NULL )
      //子機に選んだデータを送信
      _BSUBWAY_TOOL( BSWSUB_COMM_SEND_BUF, BSWAY_COMM_TR_DATA, BSW_NULL, ret )
    ELSE //子機は親からデータを受け取る
      _BSUBWAY_TOOL( BSWSUB_COMM_RECV_BUF, BSWAY_COMM_TR_DATA, BSW_NULL, LOCALWORK0 ) 
    ENDIF
  
    //ポケモンメンバーロード
    _BSUBWAY_TOOL( BSWSUB_LOAD_POKEMON_MEMBER, BSW_NULL, BSW_NULL, BSW_NULL)
  
    //レポート
    _REPORT_CALL( SCWK_ANSWER )
    _MSGWIN_CLOSE()
    
    //通信同期待ち
    _BSUBWAY_TOOL( BSWSUB_COMM_TIMSYNC, BSW_COMM_MULTI_HOME_AUTO_SAVE, BSW_NULL, comm_ret )
    
    IF $comm_ret == FALSE THEN
      _CALL sub_challenge_continue_comm_multi_error
      _RET
    ENDIF
    
    //電車発車デモ
    _CALL sub_demo_train_starting
    
    //ホーム制御　無しに
    $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_NON
    
    //マップ移動
    _MAP_CHANGE_NO_FADE( ZONE_ID_C04R0110, 7, 0, 4, DIR_UP )
  ENDIF
}
_RET

//--------------------------------------------------------------
//  comm 続けてチャレンジ　通信エラー
//--------------------------------------------------------------
sub_challenge_continue_comm_multi_error:
{
  //通信切断
  _BSUBWAY_TOOL( BSWSUB_COMM_END, BSW_NULL, BSW_NULL, BSW_NULL )
  _BSUBWAY_TOOL( BSWSUB_SET_COMM_FLAG, FALSE, BSW_NULL, BSW_NULL )
  
  _REBOOT_BEACON_SEARCH() //通信切断後のビーコンサーチ再開

  //受付対応　ゲーム後へ
  $WK_OTHER_BSUBWAY_RECEIPT = BSWAY_SCENE_RECEIPT_AFTER
  
  //電車発車デモ
  _CALL sub_demo_train_starting

  //マップフェードアウト後にエラー画面表示
  _BSUBWAY_TOOL( BSWSUB_COMM_REQ_ERROR_DISP, BSW_NULL, BSW_NULL, BSW_NULL )

  //ホーム制御　無しに
  $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_NON
    
  //受付へと戻る
  _CHG_COMMON_SCR SCRID_BSW_RETMAP_RECEIPT
}
_RET

//--------------------------------------------------------------
//  バトルサブウェイ　ホーム　受付話し掛け  ライモンシティに戻る
//--------------------------------------------------------------
sub_mapchg_receipt:
{
  DEFINE_LOCAL play_mode
  DEFINE_LOCAL comm_flag
  
  //ライモンシティに戻るか
  _BALLOONWIN_TALKOBJ_MSG( msg_c04r0111_13 )
  _YES_NO_WIN( SCWK_ANSWER )
  
  IF $SCWK_ANSWER == 0 THEN
    //戻ります
    _BALLOONWIN_TALKOBJ_MSG( msg_c04r0111_14 )
    
    //プレイモード取得
    _BSUBWAY_TOOL( BSWSUB_GET_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
    
    //通信中であれば終了を伝える
    _BSUBWAY_TOOL( BSWSUB_GET_COMM_FLAG, BSW_NULL, BSW_NULL, comm_flag )
    
    IF $comm_flag == TRUE THEN
      //お友達の選択を待っています
      _BALLOONWIN_TALKOBJ_MSG( msg_c04r0111_19 )
      
      //受信バッファクリア
      _BSUBWAY_TOOL( BSWSUB_RECV_BUF_CLEAR, BSW_NULL, BSW_NULL, BSW_NULL )
      
      //選択開始同期
      _BSUBWAY_TOOL( BSWSUB_COMM_TIMSYNC, BSW_COMM_MULTI_HOME_MENU_SELECT, BSW_NULL, comm_ret )
      
      $LOCALWORK0 = BSWAY_COMM_HOME_SEL_END
      
      IF $comm_ret == TRUE THEN
        //選択結果送信
        _BSUBWAY_TOOL( BSWSUB_COMM_SEND_BUF, BSWAY_COMM_RETIRE_SELECT, LOCALWORK0, BSW_NULL )
        //選択結果受信
        _BSUBWAY_TOOL( BSWSUB_COMM_RECV_BUF, BSWAY_COMM_RETIRE_SELECT, BSW_NULL, LOCALWORK0 )
      ENDIF

      //戻ります
      _BALLOONWIN_TALKOBJ_MSG( msg_c04r0111_20 )
      _BSUBWAY_TOOL( BSWSUB_COMM_TIMSYNC, BSW_COMM_MULTI_HOME_RETIRE_WAIT, BSW_NULL, comm_ret )
      _TIME_WAIT( 30 )
      
      //通信切断
      _BSUBWAY_TOOL( BSWSUB_COMM_TIMSYNC, BSW_COMM_MULTI_HOME_SIO_END, BSW_NULL, comm_ret )
      _BSUBWAY_TOOL( BSWSUB_COMM_END, BSW_NULL, BSW_NULL, BSW_NULL )
      _BSUBWAY_TOOL( BSWSUB_SET_COMM_FLAG, FALSE, BSW_NULL, BSW_NULL )
      
      _REBOOT_BEACON_SEARCH() //通信切断後のビーコンサーチ再開
    ENDIF
    
    //ウィンドウクローズ
    _MSGWIN_CLOSE()
    
    //受付対応　ゲーム後へ
    $WK_OTHER_BSUBWAY_RECEIPT = BSWAY_SCENE_RECEIPT_AFTER
    
    //電車発車デモ
    _CALL sub_demo_train_starting
    
    //ワーク開放
//    _BSUBWAY_WORK_RELEASE()
    
    //ホーム制御　無しに
    $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_NON
    
    //受付へと戻る
    _CHG_COMMON_SCR SCRID_BSW_RETMAP_RECEIPT
  ELSE
    _MSGWIN_CLOSE()
  ENDIF
}
_RET

//======================================================================
//  バトルサブウェイ　ホーム　パートナー話し掛け
//======================================================================
//--------------------------------------------------------------
//  バトルサブウェイ　ホーム　パートナー話し掛け
//--------------------------------------------------------------
EVENT_START ev_c04r0111_partner_talk
{ 
  DEFINE_LOCAL sex
  DEFINE_LOCAL renshou
  DEFINE_LOCAL play_mode
  
  _BSUBWAY_TOOL( BSWTOOL_GET_DATA_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  _BSUBWAY_TOOL( BSWTOOL_GET_RENSHOU_CNT, play_mode, BSW_NULL, renshou )
  _GET_MY_SEX( sex )
  
  IF $sex == PM_FEMALE THEN //自機女 パートナー男
    $msg_id = msg_c04r0111_23   //1-14
    
    IF $renshou >= 49 THEN
      $msg_id = msg_c04r0111_27 //
    ELSIF $renshou >= 21 THEN
      $msg_id = msg_c04r0111_25 //21-42
    ENDIF
  ELSE //パートナー女
    $msg_id = msg_c04r0111_24   //-14
    
    IF $renshou >= 49 THEN
      $msg_id = msg_c04r0111_28 //49-
    ELSIF $renshou >= 21 THEN
      $msg_id = msg_c04r0111_26 //-42
    ENDIF
  ENDIF
  
  _EASY_BALLOONWIN_TALKOBJ_MSG( msg_id )
}
EVENT_END

//======================================================================
//  バトルサブウェイ　ホーム　NPC話し掛け
//======================================================================
//--------------------------------------------------------------
//  バトルサブウェイ　ホーム　NPC話し掛け
//--------------------------------------------------------------
EVENT_START ev_c04r0111_npc_talk
{
  DEFINE_LOCAL play_mode
  
  _BSUBWAY_TOOL( BSWTOOL_GET_DATA_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  
  IF $play_mode == BSWAY_MODE_WIFI THEN //WiFi NPC用メッセージ表示
    _TALK_OBJ_START()
    _BSUBWAY_TOOL( BSWTOOL_WIFI_HOME_NPC_MSG, SCWK_TARGET_OBJID, BSW_NULL, BSW_NULL )
  ELSE  //HOME NPC用メッセージID取得
    _BSUBWAY_TOOL( BSWTOOL_CHK_HOME_NPC_GETITEM, SCWK_TARGET_OBJID, BSW_NULL, SCWK_ANSWER )
    
    IF $SCWK_ANSWER == TRUE THEN //アイテムNPC
      _CALL sub_npc_item_talk
    ELSE //通常NPC   
      _BSUBWAY_TOOL( BSWTOOL_GET_HOME_NPC_MSGID, SCWK_TARGET_OBJID, BSW_NULL, msg_id )
      _EASY_BALLOONWIN_TALKOBJ_MSG( msg_id )
    ENDIF
  ENDIF
}
EVENT_END

//--------------------------------------------------------------
//  バトルサブウェイ　ホーム　アイテムをくれるNPC
//--------------------------------------------------------------
sub_npc_item_talk:
{
  DEFINE_LOCAL msg0
  DEFINE_LOCAL msg1
  DEFINE_LOCAL item_no
  DEFINE_LOCAL obj_id
  
  $obj_id = $SCWK_TARGET_OBJID
   
  _BSUBWAY_TOOL( BSWTOOL_GET_HOME_NPC_GETITEM_MSGID_BEFORE, obj_id, BSW_NULL, msg0 )
  _BSUBWAY_TOOL( BSWTOOL_GET_HOME_NPC_GETITEM_MSGID_AFTER, obj_id, BSW_NULL, msg1 )
  _BSUBWAY_TOOL( BSWTOOL_GET_HOME_NPC_GETITEM_ITEMNO, obj_id, BSW_NULL, item_no )
  
  _EASY_TALK_ITEM_EVENT( item_no, 1, FH_01, msg0, msg1, msg1 )
}
_RET

//======================================================================
//  バトルサブウェイ　ホーム　対戦終了後の戻り
//======================================================================
//--------------------------------------------------------------
//  ホーム　対戦終了後の戻り
//--------------------------------------------------------------
EVENT_START ev_c04r0111_home
{
  DEFINE_LOCAL obj_id
  DEFINE_LOCAL ret
  DEFINE_LOCAL boss_f
  DEFINE_LOCAL play_mode
  DEFINE_LOCAL point
  
  //受付OBJ ID
  $obj_id = C04R0111_RECEIPT2
  
  //プレイモード取得
  _BSUBWAY_TOOL( BSWSUB_GET_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  
  //ボスを倒したか
  _BSUBWAY_TOOL( BSWSUB_GET_PLAY_BOSS_CLEAR, BSW_NULL, BSW_NULL, boss_f )
  
  //途中駅状態に
  $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_STOPOVER
  
  //終点チェック
  SWITCH $play_mode
  CASE BSWAY_MODE_SINGLE THEN
    IF $boss_f == TRUE THEN
      $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_TERMINUS
    ENDIF
  CASE BSWAY_MODE_DOUBLE THEN
    IF $boss_f == TRUE THEN
      $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_TERMINUS
    ENDIF
  CASE BSWAY_MODE_MULTI THEN
    IF $boss_f == TRUE THEN
      $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_TERMINUS
    ENDIF
  CASE BSWAY_MODE_COMM_MULTI THEN
    IF $boss_f == TRUE THEN
      $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_TERMINUS
    ENDIF
  CASE BSWAY_MODE_WIFI THEN
    $WK_OTHER_BSUBWAY_HOME = BSWAY_SCENE_HOME_TERMINUS
  ENDSWITCH
  
  //電車到着デモ
  _CALL sub_demo_train_arrival
  
  //戻り先を無効に
  _BSUBWAY_TOOL( BSWTOOL_POP_NOW_LOCATION, BSW_NULL, BSW_NULL,BSW_NULL )
  
  //ボスを倒したか？
  IF $boss_f == 1 THEN //倒した
    _BSUBWAY_TOOL( BSWSUB_CHK_S_MODE, BSW_NULL, BSW_NULL, SCWK_ANSWER )
    
    IF $SCWK_ANSWER == TRUE THEN //スーパーボスである
      //おめでとうございます
      _BALLOONWIN_OBJMSG_POS( msg_c04r0111_04, obj_id, POS_DOWN )
      _MSGWIN_CLOSE()
      
      _BSUBWAY_TOOL( BSWSUB_ADD_BATTLE_POINT, BSW_NULL, BSW_NULL, point )
      _PLAYER_NAME( 0 )
      _NUMBER( 1, point, 2 )
      _SYSWIN_MSG( msg_c04r0111_00 , POS_DOWN ) //BPを手に入れた
      _ME_PLAY( SEQ_ME_BPGET )             //ファンファーレ
      _ME_WAIT()
      _AB_KEYWAIT_MARK()
      _SYSWIN_CLOSE()

      _BSUBWAY_TOOL( BSWTOOL_GET_BOSS_CLEAR_FLAG, play_mode, BSW_NULL, SCWK_ANSWER )
      
      IF $SCWK_ANSWER == 0 THEN //初めて倒した
        //トロフィを差し上げます
        _BALLOONWIN_OBJMSG_POS( msg_c04r0111_08, obj_id, POS_DOWN )
        _MSGWIN_CLOSE()

        _BSUBWAY_TOOL( BSWTOOL_SET_BOSS_CLEAR_FLAG, play_mode, BSW_NULL, BSW_NULL )
        
        //送信ビーコンセット：バトルサブウェイでトロフィー取得 
        _BEACON_SET_REQ_SUBWAY_TROPHY_GET() 
        
        //トロフィのバニッシュフラグをリセット
        SWITCH $play_mode
        CASE BSWAY_MODE_S_SINGLE THEN
          _FLAG_RESET( FV_T01R0102_TROPHY_01 )
        CASE BSWAY_MODE_S_DOUBLE THEN
          _FLAG_RESET( FV_T01R0102_TROPHY_02 )
        CASE BSWAY_MODE_S_MULTI THEN
          _FLAG_RESET( FV_T01R0102_TROPHY_03 )
        CASE BSWAY_MODE_S_COMM_MULTI THEN
          _FLAG_RESET( FV_T01R0102_TROPHY_03 )
        ENDSWITCH
      ENDIF
    ELSE  //ノーマルボスである
      //おめでとうございます
      _BALLOONWIN_OBJMSG_POS( msg_c04r0111_04, obj_id, POS_DOWN )
      _MSGWIN_CLOSE()
      
      _BSUBWAY_TOOL( BSWSUB_ADD_BATTLE_POINT, BSW_NULL, BSW_NULL, point )
      _PLAYER_NAME( 0 )
      _NUMBER( 1, point, 2 )
      _SYSWIN_MSG( msg_c04r0111_00, POS_DOWN ) //BPを手に入れた
      _ME_PLAY( SEQ_ME_BPGET ) //ファンファーレ
      _ME_WAIT()
      _AB_KEYWAIT_MARK()
      _SYSWIN_CLOSE()
      
      _BSUBWAY_TOOL( BSWTOOL_GET_BOSS_CLEAR_FLAG, play_mode, BSW_NULL, SCWK_ANSWER )
    
      IF $SCWK_ANSWER == 0 THEN //初めて倒した
        //スーパーに挑戦出来ます
        _PLAYER_NAME( 0 )
        
        SWITCH $play_mode
        CASE BSWAY_MODE_SINGLE THEN
          _BALLOONWIN_OBJMSG_POS( msg_c04r0111_05, obj_id, POS_DOWN )
        CASE BSWAY_MODE_DOUBLE THEN
          _BALLOONWIN_OBJMSG_POS( msg_c04r0111_06, obj_id, POS_DOWN )
        CASE BSWAY_MODE_MULTI THEN
          _BALLOONWIN_OBJMSG_POS( msg_c04r0111_07, obj_id, POS_DOWN )
        CASE BSWAY_MODE_COMM_MULTI THEN
          _BALLOONWIN_OBJMSG_POS( msg_c04r0111_08, obj_id, POS_DOWN )
        ENDSWITCH
        
        _MSGWIN_CLOSE()
        
        _BSUBWAY_TOOL( BSWTOOL_SET_BOSS_CLEAR_FLAG, play_mode, BSW_NULL, BSW_NULL )
      ENDIF
    ENDIF
  ELSE //ボス倒していない
    //おめでとうございます
    _BALLOONWIN_OBJMSG_POS( msg_c04r0111_03, obj_id, POS_DOWN )
    _MSGWIN_CLOSE()
    
    _BSUBWAY_TOOL( BSWSUB_ADD_BATTLE_POINT, BSW_NULL, BSW_NULL, point )
    _PLAYER_NAME( 0 )
    _NUMBER( 1, point, 2 )
    _SYSWIN_MSG( msg_c04r0111_00 , POS_DOWN ) //BPを手に入れた
    _ME_PLAY( SEQ_ME_BPGET )             //ファンファーレ
    _ME_WAIT()
    _AB_KEYWAIT_MARK()
    _SYSWIN_CLOSE()
  ENDIF
  
  //wifiランク処理
  IF $play_mode == BSWAY_MODE_WIFI THEN
    _BSUBWAY_TOOL( BSWTOOL_WIFI_CHK_SEL_DL_BTL, BSW_NULL, BSW_NULL, ret )
    
    IF $ret == TRUE THEN //ダウンロードによる新規プレイである
      //ランクアップ処理
      _BSUBWAY_TOOL( BSWTOOL_UP_WIFI_RANK, BSW_NULL, BSW_NULL, ret )
      
      IF $ret == TRUE THEN //ランクアップした
        _BSUBWAY_TOOL( BSWTOOL_GET_WIFI_RANK, BSW_NULL, BSW_NULL, ret )

        _PLAYER_NAME( 0 )
        _NUMBER( 1, ret, 2 )

        //ランク？になりました
        _BALLOONWIN_OBJMSG_POS( msg_c04r0111_21, obj_id, POS_DOWN )
      ENDIF
      
      //今回の成績をWifiに送るか？
      _BALLOONWIN_OBJMSG_POS( msg_c04r0111_22, obj_id, POS_DOWN )
      _YES_NO_WIN( SCWK_ANSWER )
      _MSGWIN_CLOSE()
       
      IF $SCWK_ANSWER == SCR_YES THEN //送る
        _CHG_COMMON_SCR SCRID_BSW_UPLOAD_WIFI_SCORE
      ELSE //送らない 未ダウンロードフラグセット
        _BSUBWAY_TOOL( BSWTOOL_WIFI_SET_UPLOAD_FLAG, 1, BSW_NULL, BSW_NULL )
      ENDIF
    ENDIF
  ENDIF
  
  //終点であればラウンド数、ステージNoをリセット
  IF $WK_OTHER_BSUBWAY_HOME == BSWAY_SCENE_HOME_TERMINUS THEN
    _BSUBWAY_TOOL( BSWSUB_RESET_STAGE_ROUND, BSW_NULL, BSW_NULL, BSW_NULL )
  ENDIF
  
  //７人抜き毎にバトルサブウェイの落し物イベントをカウント
  IF $WK_OTHER_BSEVENT_NUM < 10 THEN
	  $WK_OTHER_BSEVENT_NUM += 1
  ENDIF
  
  //ゲーム情報をセーブデータに反映
  _BSUBWAY_TOOL( BSWSUB_SAVE_GAMECLEAR, BSW_NULL, BSW_NULL, BSW_NULL )
  
  //レポート
  _SYSWIN_MSG( msg_c04r0111_01 , POS_DOWN )
  _REPORT_CALL( SCWK_ANSWER )
  _SYSWIN_CLOSE()

  IF $WK_OTHER_BSUBWAY_HOME == BSWAY_SCENE_HOME_STOPOVER THEN
    //途中駅　また話し掛けてくれ
    _BALLOONWIN_OBJMSG_POS( msg_c04r0111_09, obj_id, POS_DOWN )
  ELSE
    //終点　終点メッセージ
    SWITCH $play_mode
    CASE BSWAY_MODE_SINGLE THEN
      _BALLOONWIN_OBJMSG_POS( msg_c04r0111_10, obj_id, POS_DOWN )
    CASE BSWAY_MODE_DOUBLE THEN
      _BALLOONWIN_OBJMSG_POS( msg_c04r0111_11, obj_id, POS_DOWN )
    CASE BSWAY_MODE_MULTI THEN
      _BALLOONWIN_OBJMSG_POS( msg_c04r0111_12, obj_id, POS_DOWN )
    CASE BSWAY_MODE_COMM_MULTI THEN
      _BALLOONWIN_OBJMSG_POS( msg_c04r0111_12, obj_id, POS_DOWN )
    CASE BSWAY_MODE_WIFI THEN
      _BALLOONWIN_OBJMSG_POS( msg_c04r0111_29, obj_id, POS_DOWN )
    ENDSWITCH
  ENDIF
  
  _LAST_KEYWAIT()
  _MSGWIN_CLOSE()
  
  //ホーム到着用ワークセット
  _BSUBWAY_TOOL( BSWSUB_SET_HOME_WORK, BSW_NULL, BSW_NULL, BSW_NULL )
}
EVENT_END

//======================================================================
//  デモ
//======================================================================
//--------------------------------------------------------------
//  電車到着デモ
//--------------------------------------------------------------
sub_demo_train_arrival:
{
  DEFINE_LOCAL play_mode
  DEFINE_LOCAL ai_multi
  
  //プレイモード取得
  _BSUBWAY_TOOL( BSWSUB_GET_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  
  IF $play_mode == BSWAY_MODE_MULTI || $play_mode == BSWAY_MODE_S_MULTI THEN
    $ai_multi = TRUE
  ELSE
    $ai_multi = FALSE
  ENDIF
  
  //自機初期設定
//  _OBJ_POS_CHANGE( MMDL_ID_PLAYER, 75, 0, 12, DIR_DOWN )
  _BSUBWAY_TOOL( BSWTOOL_OBJ_VANISH, MMDL_ID_PLAYER, TRUE, BSW_NULL )
  _BSUBWAY_TOOL( BSWTOOL_OBJ_HEIGHT_OFF, MMDL_ID_PLAYER, 0, BSW_NULL )
  
  //マルチならパートナー追加
  IF $ai_multi == TRUE THEN
    _BSUBWAY_TOOL( BSWTOOL_GET_OBJCODE_PARTNER, BSW_NULL, BSW_NULL, OBJCHRWORK0 )
    _FLAG_RESET( FV_C04R0111_PARTNER )
    _OBJ_ADD( C04R0111_PARTNER )
    _BSUBWAY_TOOL( BSWTOOL_OBJ_HEIGHT_OFF, C04R0111_PARTNER, 0, BSW_NULL )
    _BSUBWAY_TOOL( BSWTOOL_OBJ_VANISH, C04R0111_PARTNER, TRUE, BSW_NULL )
    _BSUBWAY_TOOL( BSWTOOL_OBJ_PAUSE, C04R0111_PARTNER, 0, BSW_NULL )
    _BSUBWAY_TOOL( BSWTOOL_SET_OBJ_DIR, C04R0111_PARTNER, DIR_DOWN, BSW_NULL )
    _OBJ_POS_CHANGE( C04R0111_PARTNER, 75, 0, 12, DIR_DOWN )
  ENDIF
  
  //到着アニメ
  _BSUBWAY_TOOL( BSWTOOL_SET_TRAIN_ANM, 2, BTRAIN_POS_RECEIPT, BSW_NULL )
  
  //マップフェードイン
  _MAP_FADE_BLACK_IN()
  _MAP_FADE_END_CHECK()
  
  _TIME_WAIT( 10 ) //マップフェード直後だとマップBGM再生によりSEが鳴らない
  _SE_PLAY( SEQ_SE_BDEMO_03 ) //電車到着音
  _TIME_WAIT( 60 ) //アニメを待つ
  _SE_PLAY( SEQ_SE_BDEMO_01 ) //電車扉開閉音
  
  //自機登場アニメ
  _OBJ_ANIME( MMDL_ID_PLAYER, anm_demo_train_arrival_jiki )
  
  //パートナーアニメ
  IF $ai_multi == TRUE THEN
    _OBJ_ANIME( C04R0111_PARTNER, anm_demo_train_arrival_partner )
  ENDIF
  
  //OBJアニメ待ち
  _OBJ_ANIME_WAIT()
  
  //自機高さを戻す
  _BSUBWAY_TOOL( BSWTOOL_OBJ_HEIGHT_ON, MMDL_ID_PLAYER, 0, BSW_NULL )

  //パートナー高さ戻す
  IF $ai_multi == TRUE THEN
    _BSUBWAY_TOOL( BSWTOOL_OBJ_HEIGHT_ON, C04R0111_PARTNER, 0, BSW_NULL )
  ENDIF
  
  //途中駅なら電車去る
  IF $WK_OTHER_BSUBWAY_HOME == BSWAY_SCENE_HOME_STOPOVER THEN
    _TIME_WAIT( 30 ) //ちょっと待つ
    _BSUBWAY_TOOL( BSWTOOL_SET_TRAIN_ANM, BTRAIN_ANIME_TYPE_START_GEAR, BTRAIN_POS_RECEIPT, BSW_NULL )
    _SE_PLAY( SEQ_SE_BDEMO_01 ) //電車扉音
    _TIME_WAIT( 20 )
    _SE_PLAY( SEQ_SE_BDEMO_04 ) //電車が去る時の発射音
    _TIME_WAIT( 30 ) //ちょっと待つ
    
    //ブラックアウト
    _BLACK_OUT()
    _DISP_FADE_END_CHECK()
    
    //電車消す
    _BSUBWAY_TOOL( BSWTOOL_SET_TRAIN_VANISH, TRUE, BSW_NULL, BSW_NULL )
    
    //ちょっと待つ
    _TIME_WAIT( 30 )

    //フェードイン
    _BLACK_IN()
    _DISP_FADE_END_CHECK()
  ENDIF
}
_RET

//アニメデータ　電車到着デモ　自機下車
_ANIME_LABEL anm_demo_train_arrival_jiki
  _ANIME_DATA AC_VANISH_OFF,1
  _ANIME_DATA AC_WAIT_1F,4
  _ANIME_DATA AC_WALK_D_8F,2
  _ANIME_DATA AC_STAY_WALK_R_8F,1
  _ANIME_DATA ACMD_END,0

//アニメデータ　電車到着デモ　パートナー下車
_ANIME_LABEL anm_demo_train_arrival_partner
  _ANIME_DATA AC_WAIT_1F,14
  _ANIME_DATA AC_VANISH_OFF,1
  _ANIME_DATA AC_WAIT_1F,4
  _ANIME_DATA AC_WALK_D_8F,1
  _ANIME_DATA AC_WALK_L_8F,1
  _ANIME_DATA AC_WALK_D_8F,1
  _ANIME_DATA AC_STAY_WALK_R_8F,1
  _ANIME_DATA ACMD_END,0

//--------------------------------------------------------------
//  電車出発デモ
//--------------------------------------------------------------
sub_demo_train_starting:
{
  DEFINE_LOCAL play_mode
  DEFINE_LOCAL ai_multi
  
  //マップフェードアウト
  _BLACK_OUT()
  _DISP_FADE_END_CHECK()
  
  //受付を右に
  _BSUBWAY_TOOL( BSWTOOL_SET_OBJ_DIR, C04R0111_RECEIPT1, DIR_RIGHT, BSW_NULL )
  
  //プレイモード取得
  _BSUBWAY_TOOL( BSWSUB_GET_PLAY_MODE, BSW_NULL, BSW_NULL, play_mode )
  
  IF $play_mode == BSWAY_MODE_MULTI || $play_mode == BSWAY_MODE_S_MULTI THEN
    $ai_multi = TRUE
  ELSE
    $ai_multi = FALSE
  ENDIF
  
  //自機初期設定
  _OBJ_POS_CHANGE( MMDL_ID_PLAYER, 18, 0, 14, DIR_LEFT )
  _BSUBWAY_TOOL( BSWTOOL_OBJ_HEIGHT_OFF, MMDL_ID_PLAYER, 0, BSW_NULL )
  
  //マルチならパートナー設定
  IF $ai_multi == TRUE THEN
    _OBJ_POS_CHANGE( C04R0111_PARTNER, 19, 0, 14, DIR_LEFT )
    _BSUBWAY_TOOL( BSWTOOL_OBJ_HEIGHT_OFF, C04R0111_PARTNER, 0, BSW_NULL )
    _BSUBWAY_TOOL( BSWTOOL_OBJ_PAUSE, C04R0111_PARTNER, 0, BSW_NULL )
  ENDIF
  
  //マップフェードイン開始
  _BLACK_IN()
  
  //途中駅ならば電車到着アニメ
  IF $WK_OTHER_BSUBWAY_HOME == BSWAY_SCENE_HOME_STOPOVER THEN
    _BSUBWAY_TOOL( BSWTOOL_SET_TRAIN_ANM, 2, BTRAIN_POS_HOME, BSW_NULL )
    _BSUBWAY_TOOL( BSWTOOL_SET_TRAIN_VANISH, FALSE, BSW_NULL, BSW_NULL )
    _SE_PLAY( SEQ_SE_BDEMO_03 ) //電車到着音
    _TIME_WAIT( 70 ) //アニメを待つ
    _SE_PLAY( SEQ_SE_BDEMO_01 ) //電車扉開閉音
    _TIME_WAIT( 20 ) //アニメを待つ
  ENDIF
  
  //フェードイ30ンチェック
  _DISP_FADE_END_CHECK()
  
  //自機乗車アニメ
  _OBJ_ANIME( MMDL_ID_PLAYER, anm_demo_train_starting_jiki )
  
  //パートナーアニメ
  IF $ai_multi == TRUE THEN
    _OBJ_ANIME( C04R0111_PARTNER, anm_demo_train_starting_partner )
  ENDIF
  
  //アニメ終了待ち
  _OBJ_ANIME_WAIT()
  
  //電車発車
  _BSUBWAY_TOOL( BSWTOOL_SET_TRAIN_ANM, BTRAIN_ANIME_TYPE_START_HOME, BTRAIN_POS_HOME, BSW_NULL )
  _SE_PLAY( SEQ_SE_BDEMO_01 ) //電車扉音
  _TIME_WAIT( 30 )
  _SE_PLAY( SEQ_SE_BDEMO_02 ) //電車発射音
  _TIME_WAIT( 30 ) //アニメを少し見せる
  
  //マップフェードアウト
  _MAP_FADE_BLACK_OUT()
  _MAP_FADE_END_CHECK()
}
_RET

//アニメデータ　電車発車デモ　自機乗車
_ANIME_LABEL anm_demo_train_starting_jiki
  _ANIME_DATA AC_STAY_WALK_U_8F,1
  _ANIME_DATA AC_WALK_U_8F,2
  _ANIME_DATA AC_WAIT_1F,8
  _ANIME_DATA AC_VANISH_ON,1
  _ANIME_DATA ACMD_END,0

//アニメデータ　電車発車デモ　パートナー乗車
_ANIME_LABEL anm_demo_train_starting_partner
  _ANIME_DATA AC_WAIT_1F,16
  _ANIME_DATA AC_WALK_L_8F,1
  _ANIME_DATA AC_WALK_U_8F,2
  _ANIME_DATA AC_WAIT_1F,8
  _ANIME_DATA AC_VANISH_ON,1
  _ANIME_DATA ACMD_END,0
